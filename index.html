<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodShare - Food Sharing App</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-green: #22c55e;
            --primary-green-dark: #16a34a;
            --primary-green-light: #86efac;
            --secondary-green: #4ade80;
            --bg-green-light: #f0fdf4;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-600: #4b5563;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
        }

        body {
            background-color: var(--gray-100);
            color: var(--gray-600);
            min-height: 100vh;
            position: relative;
        }

        /* Onboarding */
        .onboarding-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 999;
            overflow: hidden;
        }

        .onboarding-slides {
            display: flex;
            width: 300%;
            height: calc(100% - 80px);
            transition: transform 0.5s ease;
        }

        .onboarding-slide {
            width: 33.33%;
            height: 100%;
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .onboarding-slide img {
            width: 250px;
            height: 250px;
            margin-bottom: 30px;
            object-fit: contain;
        }

        .onboarding-slide h2 {
            font-size: 22px;
            margin-bottom: 15px;
            color: var(--primary-green-dark);
        }

        .onboarding-slide p {
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 30px;
            line-height: 1.5;
        }

        .onboarding-progress {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--gray-300);
            margin: 0 5px;
            transition: background-color 0.3s ease;
        }

        .progress-dot.active {
            background-color: var(--primary-green);
        }

        .onboarding-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 0 30px;
            position: absolute;
            bottom: 30px;
        }

        .skip-btn {
            background: none;
            border: none;
            color: var(--gray-400);
            font-weight: 500;
            cursor: pointer;
        }

        .next-btn {
            background-color: var(--primary-green);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .next-btn:hover {
            background-color: var(--primary-green-dark);
        }

        /* Auth Screens */
        .auth-container {
            display: none;
            max-width: 500px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-header h1 {
            color: var(--primary-green-dark);
            margin-bottom: 10px;
        }

        .auth-header p {
            color: var(--gray-600);
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 30px;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            font-weight: 500;
            color: var(--gray-400);
            position: relative;
        }

        .auth-tab.active {
            color: var(--primary-green-dark);
            font-weight: 600;
        }

        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--primary-green);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-600);
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .form-group .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        .role-selection {
            margin-bottom: 25px;
        }

        .role-selection h3 {
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--gray-600);
        }

        .role-options {
            display: flex;
            gap: 15px;
        }

        .role-option {
            flex: 1;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-option:hover {
            border-color: var(--primary-green-light);
        }

        .role-option.selected {
            border-color: var(--primary-green);
            background-color: var(--bg-green-light);
        }

        .role-option i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--primary-green);
        }

        .role-option p {
            font-size: 14px;
            color: var(--gray-600);
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .auth-btn:hover {
            background-color: var(--primary-green-dark);
        }

        .auth-btn:disabled {
            background-color: var(--gray-300);
            cursor: not-allowed;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--gray-400);
        }

        .auth-footer a {
            color: var(--primary-green);
            text-decoration: none;
            font-weight: 500;
        }

        /* Profile Setup */
        .profile-setup-container {
            display: none;
            max-width: 500px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .profile-setup-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-setup-header h1 {
            color: var(--primary-green-dark);
            margin-bottom: 10px;
        }

        .profile-setup-header p {
            color: var(--gray-600);
        }

        .preview-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 20px;
            border: 3px solid var(--gray-200);
        }

        .preview-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-avatar.initials {
            background-color: var(--primary-green-dark);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
        }

        .avatar-selection {
            margin-bottom: 30px;
        }

        .avatar-selection h3 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--gray-600);
        }

        .avatar-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .avatar-option.selected {
            border-color: var(--primary-green);
        }

        .avatar-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .custom-avatar-upload {
            text-align: center;
            margin-bottom: 30px;
        }

        .custom-avatar-upload label {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--gray-200);
            color: var(--gray-600);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .custom-avatar-upload label:hover {
            background-color: var(--gray-300);
        }

        .custom-avatar-upload input {
            display: none;
        }

        /* Main App Container */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background-color: var(--primary-green);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-md);
            position: sticky;
            border-radius: 0 0 25px 25px;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .greeting {
            margin-left: 10px;
        }

        .greeting h2 {
            font-size: 18px;
            margin-bottom: 2px;
        }

        .greeting p {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon {
            position: relative;
            cursor: pointer;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid white;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar.initials {
            background-color: var(--primary-green-dark);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        /* Homepage Header */
        .home-header {
            background-color: var(--primary-green);
            color: white;
            padding: 40px 20px 60px;
            position: relative;
            margin-bottom: -30px;
            z-index: 1;
        }

        .welcome-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            margin: 0 auto;
            max-width: 800px;
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .welcome-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
            border: 3px solid var(--primary-green);
        }

        .welcome-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .welcome-avatar.initials {
            background-color: var(--primary-green);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: bold;
        }

        .welcome-content h2 {
            color: var(--primary-green-dark);
            margin-bottom: 5px;
            font-size: 20px;
        }

        .welcome-content p {
            color: var(--gray-600);
            font-size: 14px;
        }

        /* Sidebar for desktop */
        .sidebar {
            display: none;
            width: 250px;
            background-color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            box-shadow: var(--shadow-md);
            padding-top: 80px;
            z-index: 90;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
        }

        .sidebar-nav li {
            margin-bottom: 5px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--gray-600);
            text-decoration: none;
            transition: all 0.3s;
        }

        .sidebar-nav a:hover {
            background-color: var(--bg-green-light);
            color: var(--primary-green-dark);
        }

        .sidebar-nav a.active {
            background-color: var(--bg-green-light);
            color: var(--primary-green-dark);
            border-left: 4px solid var(--primary-green);
        }

        .sidebar-nav i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Bottom Navigation for mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: white;
            display: flex;
            justify-content: space-around;
            padding: 20px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
            height: 70px;
            border-radius: 25px 25px 0 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--gray-400);
            text-decoration: none;
            font-size: 12px;
            position: relative;
        }

        .nav-item i {
            font-size: 20px;
            margin-bottom: 3px;
        }

        .nav-item.active {
            color: var(--primary-green);
        }

        .nav-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-green);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: var(--shadow-xl);
            cursor: pointer;
            z-index: 99;
            transition: all 0.3s;
        }

        .fab:hover {
            background-color: var(--primary-green-dark);
            transform: translateY(-3px);
        }

        .fab i {
            font-size: 24px;
        }

        /* Main Content */
        .main-content {
            padding: 20px;
            padding-bottom: 80px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .page-header h2 {
            color: var(--primary-green-dark);
            font-size: 22px;
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: var(--shadow-sm);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 12px;
            color: var(--gray-400);
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-green-dark);
        }

        .quick-actions {
            margin-bottom: 25px;
        }

        .quick-actions h3 {
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 15px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .action-btn {
            background-color: white;
            border: 1px solid var(--gray-200);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--gray-600);
        }

        .action-btn:hover {
            border-color: var(--primary-green-light);
            transform: translateY(-2px);
        }

        .action-btn i {
            font-size: 24px;
            color: var(--primary-green);
            margin-bottom: 10px;
        }

        .recent-section {
            margin-bottom: 25px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-header h3 {
            font-size: 16px;
            color: var(--gray-600);
        }

        .section-header a {
            font-size: 14px;
            color: var(--primary-green);
            text-decoration: none;
        }

        /* Food Listings */
        .listings-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .listing-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .listing-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .listing-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .listing-details {
            padding: 15px;
        }

        .listing-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .listing-title {
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 5px;
        }

        .listing-category {
            display: inline-block;
            padding: 3px 8px;
            background-color: var(--bg-green-light);
            color: var(--primary-green-dark);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .listing-meta {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--gray-400);
            margin-bottom: 10px;
        }

        .listing-meta i {
            margin-right: 5px;
        }

        .listing-description {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 15px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .listing-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .listing-donor {
            display: flex;
            align-items: center;
        }

        .donor-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 8px;
        }

        .donor-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .donor-avatar.initials {
            background-color: var(--gray-300);
            color: var(--gray-600);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            font-weight: bold;
        }

        .donor-name {
            font-size: 12px;
            color: var(--gray-600);
        }

        .listing-actions {
            display: flex;
            gap: 10px;
        }

        .action-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--gray-100);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .action-icon:hover {
            background-color: var(--gray-200);
        }

        .action-icon i {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* Create Listing Modal */
        .listing-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .listing-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .listing-modal {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .listing-modal-overlay.active .listing-modal {
            transform: translateY(0);
        }

        .listing-modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 1;
        }

        .listing-modal-header h3 {
            font-size: 18px;
            color: var(--gray-600);
        }

        .listing-modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-400);
            cursor: pointer;
        }

        .listing-modal-body {
            padding: 20px;
        }

        .listing-modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background-color: white;
        }

        .listing-modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            font-size: 16px;
        }

        .listing-modal-btn.secondary {
            background-color: var(--gray-100);
            color: var(--gray-600);
            border: none;
        }

        .listing-modal-btn.primary {
            background-color: var(--primary-green);
            color: white;
            border: none;
        }

        .listing-modal-btn.primary:hover {
            background-color: var(--primary-green-dark);
        }

        .image-upload {
            margin-bottom: 20px;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--gray-300);
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            overflow: hidden;
            position: relative;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .upload-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: var(--gray-100);
            color: var(--gray-600);
            border: none;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .upload-btn:hover {
            background-color: var(--gray-200);
        }

        .category-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .category-option {
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-option:hover {
            border-color: var(--primary-green-light);
        }

        .category-option.selected {
            border-color: var(--primary-green);
            background-color: var(--bg-green-light);
        }

        .category-option i {
            font-size: 24px;
            color: var(--primary-green);
            margin-bottom: 10px;
        }

        .category-option h4 {
            font-size: 14px;
            color: var(--gray-600);
        }

        /* Messaging */
        .chat-list {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .chat-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chat-item:hover {
            background-color: var(--gray-100);
        }

        .chat-item.unread {
            background-color: var(--bg-green-light);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-avatar.initials {
            background-color: var(--gray-300);
            color: var(--gray-600);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
        }

        .chat-details {
            flex: 1;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .chat-name {
            font-weight: 600;
            color: var(--gray-600);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 12px;
            color: var(--gray-400);
            flex-shrink: 0;
            margin-left: 10px;
        }

        .chat-preview {
            font-size: 14px;
            color: var(--gray-400);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-unread {
            background-color: var(--primary-green);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            margin-left: 10px;
        }

        /* Chat Conversation */
        .chat-container {
            display: none;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            height: calc(100vh - 200px);
            flex-direction: column;
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }

        .message.received {
            align-self: flex-start;
        }

        .message.sent {
            align-self: flex-end;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.4;
        }

        .message.received .message-content {
            background-color: var(--gray-100);
            color: var(--gray-600);
            border-top-left-radius: 4px;
        }

        .message.sent .message-content {
            background-color: var(--primary-green);
            color: white;
            border-top-right-radius: 4px;
        }

        .message-time {
            font-size: 11px;
            color: var(--gray-400);
            margin-top: 5px;
            text-align: right;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid var(--gray-200);
            background-color: white;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--gray-200);
            border-radius: 20px;
            outline: none;
        }

        .chat-input button {
            background-color: var(--primary-green);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chat-input button:hover {
            background-color: var(--primary-green-dark);
        }

        /* Profile Page */
        .profile-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .profile-header {
            padding: 30px 20px;
            text-align: center;
            background-color: var(--bg-green-light);
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 15px;
            border: 3px solid white;
            box-shadow: var(--shadow-sm);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-avatar.initials {
            background-color: var(--primary-green);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 36px;
            font-weight: bold;
        }

        .profile-name {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 5px;
        }

        .profile-role {
            display: inline-block;
            padding: 4px 12px;
            background-color: var(--primary-green-light);
            color: var(--primary-green-dark);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .profile-bio {
            margin-top: 15px;
            color: var(--gray-600);
            font-size: 14px;
            line-height: 1.5;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat h3 {
            font-size: 12px;
            color: var(--gray-400);
            margin-bottom: 5px;
        }

        .profile-stat p {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-green-dark);
        }

        .profile-section {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
        }

        .profile-section h3 {
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 15px;
        }

        .profile-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
        }

        .profile-item i {
            width: 24px;
            color: var(--gray-400);
            margin-right: 15px;
        }

        .profile-item p {
            flex: 1;
            color: var(--gray-600);
        }

        .profile-item .arrow {
            color: var(--gray-400);
        }

        /* Notifications */
        .notifications-container {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
        }

        .notification-item.unread {
            background-color: var(--bg-green-light);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--gray-100);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .notification-icon i {
            color: var(--primary-green);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 3px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--gray-400);
        }

        .notification-time {
            font-size: 12px;
            color: var(--gray-400);
            margin-top: 5px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background-color: white;
            border-radius: 10px;
        }

        .empty-state i {
            font-size: 48px;
            color: var(--gray-300);
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--gray-600);
            margin-bottom: 10px;
        }

        .empty-state p {
            font-size: 14px;
            color: var(--gray-400);
            margin-bottom: 20px;
        }

        /* Loading States */
        .loading-state {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(34, 197, 94, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s linear infinite;
        }

        .skeleton {
            background-color: var(--gray-200);
            border-radius: 4px;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes spin {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
.modal-body {
    padding: 20px;
    text-align: center;
}

.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid var(--gray-200);
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.modal-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    font-size: 16px;
}

.modal-btn.secondary {
    background-color: var(--gray-100);
    color: var(--gray-600);
    border: none;
}

.modal-btn.primary {
    background-color: var(--primary-green);
    color: white;
    border: none;
}

.modal-btn.primary:hover {
    background-color: var(--primary-green-dark);
}        

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--gray-200);
            padding: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
            color: var(--gray-600);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-400);
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-btn.secondary {
            background-color: var(--gray-100);
            color: var(--gray-600);
            border: none;
        }

        .modal-btn.primary {
            background-color: var(--primary-green);
            color: white;
            border: none;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background-color: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--primary-green);
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast-icon {
            margin-right: 15px;
            font-size: 20px;
        }

        .toast.success .toast-icon {
            color: var(--primary-green);
        }

        .toast.error .toast-icon {
            color: #ef4444;
        }

        .toast-content h4 {
            font-size: 16px;
            margin-bottom: 3px;
            color: var(--gray-600);
        }

        .toast-content p {
            font-size: 14px;
            color: var(--gray-400);
        }

        .toast-close {
            margin-left: 15px;
            color: var(--gray-400);
            cursor: pointer;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .app-container {
                padding-left: 250px;
            }

            .sidebar {
                display: block;
            }

            .bottom-nav {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .listings-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .chat-back {
                display: block;
            }

            .home-header {
                padding: 60px 40px 80px;
            }

            .welcome-card {
                padding: 30px;
            }
        }

        @media (min-width: 1024px) {
            .listings-container {
                grid-template-columns: repeat(3, 1fr);
            }

            .category-select {
                grid-template-columns: repeat(6, 1fr);
            }
        }
        
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s ease;
    }
    
    .loading-content {
        text-align: center;
    }
    
    .loading-screen h3 {
        margin-top: 20px;
        color: var(--primary-green-dark);
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .loading-screen .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid var(--primary-green-light);
        border-top-color: var(--primary-green);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    /* Add to your existing CSS */
.modal-btn.danger {
    background-color: #ef4444;
    color: white;
}

.modal-btn.danger:hover {
    background-color: #dc2626;
}

/* Chat Conversation */
.chat-container {
    display: none;
    background-color: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
}

.chat-header {
    padding: 15px;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    background-color: white;
    position: sticky;
    top: 0;
    z-index: 1;
}

.chat-messages {
    flex: 1;
    padding: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.message {
    margin-bottom: 15px;
    max-width: 80%;
    display: flex;
    flex-direction: column;
}

.message.received {
    align-self: flex-start;
}

.message.sent {
    align-self: flex-end;
}

.message-content {
    padding: 10px 15px;
    border-radius: 18px;
    font-size: 14px;
    line-height: 1.4;
    word-wrap: break-word;
}

.message.received .message-content {
    background-color: var(--gray-100);
    color: var(--gray-600);
    border-top-left-radius: 4px;
}

.message.sent .message-content {
    background-color: var(--primary-green);
    color: white;
    border-top-right-radius: 4px;
}

.message-time {
    font-size: 11px;
    color: var(--gray-400);
    margin-top: 5px;
    text-align: right;
}

.chat-input {
    display: flex;
    padding: 10px;
    border-top: 1px solid var(--gray-200);
    background-color: white;
    position: sticky;
    bottom: 0;
}

.chat-input input {
    flex: 1;
    padding: 10px 15px;
    border: 1px solid var(--gray-200);
    border-radius: 20px;
    outline: none;
}

.chat-input button {
    background-color: var(--primary-green);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    margin-left: 10px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.chat-input button:hover {
    background-color: var(--primary-green-dark);
}

/* Chat List */
.chat-item {
    display: flex;
    padding: 15px;
    border-bottom: 1px solid var(--gray-200);
    cursor: pointer;
    transition: background-color 0.3s;
}

.chat-item:hover {
    background-color: var(--gray-100);
}

.chat-item.unread {
    background-color: var(--bg-green-light);
}

.chat-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 15px;
    flex-shrink: 0;
    background-size: cover;
    background-position: center;
}

.chat-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.chat-avatar.initials {
    background-color: var(--gray-300);
    color: var(--gray-600);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    font-weight: bold;
}

.chat-details {
    flex: 1;
    overflow: hidden;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.chat-name {
    font-weight: 600;
    color: var(--gray-600);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-time {
    font-size: 12px;
    color: var(--gray-400);
    flex-shrink: 0;
    margin-left: 10px;
}

.chat-preview {
    font-size: 14px;
    color: var(--gray-400);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-unread {
    background-color: var(--primary-green);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    margin-left: 10px;
}

    /* Chat Page Animation */
#chat-page {
    position: fixed;
    top: 0;
    left: 100%;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 1000; /* Higher z-index to ensure it's above everything */
    transition: transform 0.35s cubic-bezier(0.22, 0.61, 0.36, 1);
    will-change: transform;
    overflow: hidden;
}

#chat-page.active {
    transform: translateX(-100%);
}

/* Chat Header */
.chat-header {
    padding: 15px;
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    background-color: white;
    position: sticky;
    top: 0;
    z-index: 1;
}

.chat-back {
    margin-right: 15px;
    cursor: pointer;
    font-size: 20px;
    color: var(--gray-600);
    min-width: 24px; /* Ensure consistent width */
}

.chat-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin-right: 15px;
    flex-shrink: 0;
}

.chat-name {
    font-weight: 600;
    color: var(--gray-600);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
}

/* Hide bottom nav when chat is active */
body.chat-active .bottom-nav {
    display: none !important;
}
    
    /* Chat Container */
    .chat-container {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    /* Chat Header */
    .chat-header {
        padding: 15px;
        border-bottom: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        background-color: white;
        position: sticky;
        top: 0;
        z-index: 1;
    }
    
    .chat-back {
        margin-right:15px;
        cursor: pointer;
        font-size: 20px;
        color: var(--gray-600);
    }
    
    .chat-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        overflow: hidden;
        margin-right: 15px;
        flex-shrink: 0;
    }
    
    .chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .chat-avatar.initials {
        background-color: var(--gray-300);
        color: var(--gray-600);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 16px;
        font-weight: bold;
    }
    
    .chat-name {
        font-weight: 600;
        color: var(--gray-600);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }
    
    /* Chat Messages */
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    .message {
        margin-bottom: 15px;
        max-width: 80%;
        display: flex;
        flex-direction: column;
    }
    
    .message.received {
        align-self: flex-start;
    }
    
    .message.sent {
        align-self: flex-end;
    }
    
    .message-content {
        padding: 10px 15px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        word-wrap: break-word;
    }
    
    .message.received .message-content {
        background-color: var(--gray-100);
        color: var(--gray-600);
        border-top-left-radius: 4px;
    }
    
    .message.sent .message-content {
        background-color: var(--primary-green);
        color: white;
        border-top-right-radius: 4px;
    }
    
    .message-time {
        font-size: 11px;
        color: var(--gray-400);
        margin-top: 5px;
        text-align: right;
    }
    
    /* Chat Input */
    .chat-input {
        display: flex;
        padding: 15px;
        border-top: 1px solid var(--gray-200);
        background-color: white;
        position: sticky;
        bottom: 0;
    }
    
    .chat-input input {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid var(--gray-200);
        border-radius: 20px;
        outline: none;
        font-size: 16px;
    }
    
    .chat-input button {
        background-color: var(--primary-green);
        color: white;
        border: none;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        margin-left: 10px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .chat-input button:hover {
        background-color: var(--primary-green-dark);
    }
    
    /* Hide bottom nav when in chat */
    body.chat-active .bottom-nav {
        display: none !important;
    }
</style>
</head>
<body>
  <div class="loading-screen" id="loading-screen">
    <div class="loading-content">
        <div class="loading-spinner"></div>
        <h3>Loading FoodShare</h3>
    </div>
</div>

    <!-- Onboarding Slides -->
    <div class="onboarding-container">
        <div class="onboarding-slides">
            <div class="onboarding-slide">
                <img src="https://images.unsplash.com/photo-1593113598332-cd288d649433?w=300&h=300&fit=crop&crop=center" alt="People sharing food">
                <h2>Share Surplus Food</h2>
                <p>Connect with your community by sharing extra food that would otherwise go to waste.</p>
            </div>
            <div class="onboarding-slide">
                <img src="https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=300&h=300&fit=crop&crop=center" alt="Fresh groceries and produce">
                <h2>Find Available Food</h2>
                <p>Discover fresh food shared by people in your neighborhood.</p>
            </div>
            <div class="onboarding-slide">
                <img src="https://images.unsplash.com/photo-1559027615-cd4628902d4a?w=300&h=300&fit=crop&crop=center" alt="Community volunteers helping">
                <h2>Make a Difference</h2>
                <p>Reduce food waste and help those in need in your community.</p>
            </div>
        </div>
        <div class="onboarding-progress">
            <div class="progress-dot active"></div>
            <div class="progress-dot"></div>
            <div class="progress-dot"></div>
        </div>
        <div class="onboarding-buttons">
            <button class="skip-btn">Skip</button>
            <button class="next-btn">Next</button>
        </div>
    </div>

    <!-- Authentication Screens -->
    <div class="auth-container">
        <div class="auth-header">
            <h1>Welcome to FoodShare</h1>
            <p>Join our community to share or receive food</p>
        </div>
        <div class="auth-tabs">
            <div class="auth-tab active" data-tab="login">Login</div>
            <div class="auth-tab" data-tab="signup">Sign Up</div>
        </div>
        <form id="login-form" class="auth-form active">
            <div class="form-group">
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="Enter your email">
                <div class="error-message" id="login-email-error"></div>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Enter your password">
                <div class="error-message" id="login-password-error"></div>
            </div>
            <button type="submit" class="auth-btn" id="login-btn">Login</button>
            <div class="auth-footer">
                Forgot password? <a href="#" id="forgot-password">Reset it</a>
            </div>
        </form>
        <form id="signup-form" class="auth-form">
            <div class="form-group">
                <label for="signup-name">Full Name</label>
                <input type="text" id="signup-name" placeholder="Enter your full name">
                <div class="error-message" id="signup-name-error"></div>
            </div>
            <div class="form-group">
                <label for="signup-email">Email</label>
                <input type="email" id="signup-email" placeholder="Enter your email">
                <div class="error-message" id="signup-email-error"></div>
            </div>
            <div class="form-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" placeholder="Create a password (min 6 chars)">
                <div class="error-message" id="signup-password-error"></div>
            </div>
            <div class="form-group">
                <label for="signup-confirm-password">Confirm Password</label>
                <input type="password" id="signup-confirm-password" placeholder="Confirm your password">
                <div class="error-message" id="signup-confirm-password-error"></div>
            </div>
            <div class="role-selection">
                <h3>I want to:</h3>
                <div class="role-options">
                    <div class="role-option selected" data-role="donor">
                        <i class="fas fa-utensils"></i>
                        <p>Share Food</p>
                    </div>
                    <div class="role-option" data-role="receiver">
                        <i class="fas fa-hands-helping"></i>
                        <p>Receive Food</p>
                    </div>
                </div>
            </div>
            <button type="submit" class="auth-btn" id="signup-btn">Create Account</button>
            <div class="auth-footer">
                Already have an account? <a href="#" id="switch-to-login">Login</a>
            </div>
        </form>
    </div>

    <!-- Profile Setup -->
    <div class="profile-setup-container">
        <div class="profile-setup-header">
            <h1>Complete Your Profile</h1>
            <p>Add some details to help others recognize you</p>
        </div>
        <div class="preview-avatar initials" id="preview-avatar">
            <!-- Initials or image will be shown here -->
        </div>
        <div class="avatar-selection">
            <h3>Choose an avatar</h3>
            <div class="avatar-options">
                <div class="avatar-option selected" data-avatar="1">
                    <img src="https://i.ibb.co/0jQ4ZJ1/avatar1.png" alt="Avatar 1">
                </div>
                <div class="avatar-option" data-avatar="2">
                    <img src="https://i.ibb.co/7Yk6z0P/avatar2.png" alt="Avatar 2">
                </div>
                <div class="avatar-option" data-avatar="3">
                    <img src="https://i.ibb.co/0jQ4ZJ1/avatar3.png" alt="Avatar 3">
                </div>
            </div>
        </div>
        <div class="custom-avatar-upload">
            <label for="avatar-upload">Or upload your own</label>
            <input type="file" id="avatar-upload" accept="image/*">
        </div>
        <div class="form-group">
            <label for="profile-bio">Bio (Optional)</label>
            <textarea id="profile-bio" rows="3" placeholder="Tell others a bit about yourself..."></textarea>
        </div>
        <button class="auth-btn" id="complete-profile-btn">Complete Setup</button>
    </div>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Sidebar for desktop -->
        <div class="sidebar">
            <ul class="sidebar-nav">
                <li>
                    <a href="#" class="nav-link active" data-page="home">
                        <i class="fas fa-home"></i> Home
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-page="listings">
                        <i class="fas fa-utensils"></i> Food Listings
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-page="messages">
                        <i class="fas fa-comments"></i> Messages
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link" data-page="profile">
                        <i class="fas fa-user"></i> Profile
                    </a>
                </li>
            </ul>
        </div>

        <!-- Header -->
        <div class="app-header">
            <div class="header-left">
                <div class="user-avatar initials" id="header-avatar">
                    <!-- Initials or image will be shown here -->
                </div>
                <div class="greeting">
                    <h2 id="greeting-text">Good Morning</h2>
                    <p id="username-text">User</p>
                </div>
            </div>
            <div class="header-right">
                <div class="notification-icon" id="notification-icon">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notification-badge">3</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Home Page -->
            <div class="page" id="home-page">
                <!-- Donor Dashboard -->
                <div id="donor-dashboard">
                    <div class="stats-grid">
                      <div class="stat-card">
                          <h3>Total Donations</h3>
                          <p id="donor-total-donations"><span class="skeleton" style="width: 30px; height: 24px; display: inline-block;"></span></p>
                      </div>
                      <div class="stat-card">
                          <h3>People Helped</h3>
                          <p id="donor-people-helped"><span class="skeleton" style="width: 30px; height: 24px; display: inline-block;"></span></p>
                      </div>
                      <div class="stat-card">
                          <h3>Your Rating</h3>
                          <p id="donor-rating"><span class="skeleton" style="width: 30px; height: 24px; display: inline-block;"></span></p>
                      </div>
                      <div class="stat-card">
                          <h3>Active Listings</h3>
                          <p id="donor-active-listings"><span class="skeleton" style="width: 30px; height: 24px; display: inline-block;"></span></p>
                      </div>
                    </div>
                                    
                    <div class="quick-actions">
                        <h3>Quick Actions</h3>
                        <div class="action-buttons">
                            <a href="#" class="action-btn" id="add-listing-btn">
                                <i class="fas fa-plus-circle"></i>
                                <span>Add New Listing</span>
                            </a>
                            <a href="#" class="action-btn" id="view-listings-btn">
                                <i class="fas fa-list"></i>
                                <span>View Your Listings</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="recent-section">
                        <div class="section-header">
                            <h3>Recent Requests</h3>
                            <a href="#">View All</a>
                        </div>
                        <div class="empty-state">
                            <i class="fas fa-comment-dots"></i>
                            <h3>No Recent Requests</h3>
                            <p>When people request your food, you'll see them here</p>
                        </div>
                    </div>
                </div>
                
                <!-- Receiver Dashboard -->
                <div id="receiver-dashboard" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Requests</h3>
                            <p id="receiver-total-requests"><span class="skeleton" style="width: 30px; height: 24px; display: inline-block;"></span></p>
                        </div>
                        <div class="stat-card">
                            <h3>Successful</h3>
                            <p id="receiver-successful-requests"><span class="skeleton" style="width: 30px; height: 24px; display: inline-block;"></span></p>
                        </div>
                        <div class="stat-card">
                            <h3>Your Rating</h3>
                            <p id="receiver-rating"><span class="skeleton" style="width: 30px; height: 24px; display: inline-block;"></span></p>
                        </div>
                        <div class="stat-card">
                            <h3>Nearby Listings</h3>
                            <p id="receiver-nearby-listings"><span class="skeleton" style="width: 30px; height: 24px; display: inline-block;"></span></p>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <h3>Quick Actions</h3>
                        <div class="action-buttons">
                            <a href="#" class="action-btn" id="browse-listings-btn">
                                <i class="fas fa-search"></i>
                                <span>Browse Listings</span>
                            </a>
                            <a href="#" class="action-btn" id="view-messages-btn">
                                <i class="fas fa-comments"></i>
                                <span>View Messages</span>
                            </a>
                        </div>
                    </div>
                    
                    <div class="recent-section">
                        <div class="section-header">
                            <h3>Recently Added Food</h3>
                            <a href="#">View All</a>
                        </div>
                        <div class="listings-container">
                            <div class="empty-state">
                                <i class="fas fa-utensils"></i>
                                <h3>No Recent Listings</h3>
                                <p>When food is shared nearby, it will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Listings Page -->
            <div class="page" id="listings-page" style="display: none;">
                
                <div id="listings-content">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Messages Page -->
            <div class="page" id="messages-page" style="display: none;">
                
                <div class="chat-list" id="chat-list">
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <h3>No Messages Yet</h3>
                        <p>When you start conversations about food listings, they'll appear here</p>
                    </div>
                </div>
            </div>
            
            <!-- Chat Conversation Page -->
<div class="page" id="chat-page">
    <div class="chat-container" id="chat-container">
        <div class="chat-header">
            <div class="chat-avatar initials" id="chat-user-avatar"></div>
            <div class="chat-name" id="chat-user-name"></div>
            
            <div class="chat-back" id="chat-back">
                <i class="fas fa-arrow-left"></i>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Type a message...">
            <button id="send-message-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
            
            <!-- Notifications Page -->
            <div class="page" id="notifications-page" style="display: none;">
                <div class="page-header">
                    <h2>Notifications</h2>
                </div>
                
                <div class="notifications-container" id="notifications-container">
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h3>No Notifications</h3>
                        <p>When you have new notifications, they'll appear here</p>
                    </div>
                </div>
            </div>
            
            <!-- Profile Page -->
            <div class="page" id="profile-page" style="display: none;">
                <div class="profile-container">
                    <div class="profile-header">
                        <div class="profile-avatar initials" id="profile-avatar">
                            <!-- Avatar will be dynamically inserted here -->
                        </div>
                        <h2 class="profile-name" id="profile-name">John Doe</h2>
                        <span class="profile-role" id="profile-role">Donor</span>
                        <p class="profile-bio" id="profile-bio">No bio yet</p>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <h3>Listings</h3>
                            <p id="profile-listings">0</p>
                        </div>
                        <div class="profile-stat">
                            <h3>Helped</h3>
                            <p id="profile-helped">0</p>
                        </div>
                        <div class="profile-stat">
                            <h3>Rating</h3>
                            <p id="profile-rating">0.0</p>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Account</h3>
                        <div class="profile-item" id="edit-profile-btn">
                            <i class="fas fa-user-edit"></i>
                            <p>Edit Profile</p>
                            <i class="fas fa-chevron-right arrow"></i>
                        </div>
                        <div class="profile-item" id="change-password-btn">
                            <i class="fas fa-lock"></i>
                            <p>Change Password</p>
                            <i class="fas fa-chevron-right arrow"></i>
                        </div>
                        <div class="profile-item" id="notification-settings-btn">
                            <i class="fas fa-bell"></i>
                            <p>Notification Settings</p>
                            <i class="fas fa-chevron-right arrow"></i>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>About</h3>
                        <div class="profile-item" id="terms-btn">
                            <i class="fas fa-file-alt"></i>
                            <p>Terms of Service</p>
                            <i class="fas fa-chevron-right arrow"></i>
                        </div>
                        <div class="profile-item" id="privacy-btn">
                            <i class="fas fa-shield-alt"></i>
                            <p>Privacy Policy</p>
                            <i class="fas fa-chevron-right arrow"></i>
                        </div>
                        <div class="profile-item" id="contact-btn">
                            <i class="fas fa-envelope"></i>
                            <p>Contact Us</p>
                            <i class="fas fa-chevron-right arrow"></i>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <div class="profile-item" id="logout-btn">
                            <i class="fas fa-sign-out-alt"></i>
                            <p>Logout</p>
                        </div>
                        <div class="profile-item" id="delete-account-btn" style="color: #ef4444;">
                            <i class="fas fa-trash-alt"></i>
                            <p>Delete Account</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <div class="fab" id="fab-btn" style="display: none;">
            <i class="fas fa-plus"></i>
        </div>
        
        <!-- Bottom Navigation for mobile -->
        <div class="bottom-nav">
            <a href="#" class="nav-item active" data-page="home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" data-page="listings">
                <i class="fas fa-utensils"></i>
                <span>Listings</span>
            </a>
            <a href="#" class="nav-item" data-page="messages">
                <i class="fas fa-comments"></i>
                <span>Messages</span>
                <span class="nav-notification" id="mobile-message-badge" style="display: none;">3</span>
            </a>
            <a href="#" class="nav-item" data-page="profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </div>
    </div>
    
    <!-- Create Listing Modal -->
    <div class="listing-modal-overlay" id="listing-modal">
        <div class="listing-modal">
            <div class="listing-modal-header">
                <h3>Share Food</h3>
                <button class="listing-modal-close" id="close-listing-modal">&times;</button>
            </div>
            <div class="listing-modal-body">
                <div class="form-group image-upload">
                    <label>Food Image</label>
                    <div class="image-preview" id="image-preview">
                        <i class="fas fa-camera" style="font-size: 40px; color: var(--gray-300);"></i>
                    </div>
                    <button class="upload-btn" id="upload-btn">Choose Image</button>
                    <input type="file" id="food-image-upload" accept="image/*" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label for="food-title">Title</label>
                    <input type="text" id="food-title" placeholder="e.g. Fresh baked bread, assorted vegetables">
                    <div class="error-message" id="food-title-error"></div>
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <div class="category-select">
                        <div class="category-option" data-category="bakery">
                            <i class="fas fa-bread-slice"></i>
                            <h4>Bakery</h4>
                        </div>
                        <div class="category-option" data-category="produce">
                            <i class="fas fa-apple-alt"></i>
                            <h4>Produce</h4>
                        </div>
                        <div class="category-option" data-category="dairy">
                            <i class="fas fa-cheese"></i>
                            <h4>Dairy</h4>
                        </div>
                        <div class="category-option" data-category="pantry">
                            <i class="fas fa-box-open"></i>
                            <h4>Pantry</h4>
                        </div>
                        <div class="category-option" data-category="prepared">
                            <i class="fas fa-utensils"></i>
                            <h4>Prepared</h4>
                        </div>
                        <div class="category-option" data-category="other">
                            <i class="fas fa-ellipsis-h"></i>
                            <h4>Other</h4>
                        </div>
                    </div>
                    <input type="hidden" id="food-category">
                    <div class="error-message" id="food-category-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="food-description">Description</label>
                    <textarea id="food-description" rows="4" placeholder="Describe the food, quantity, any special instructions..."></textarea>
                    <div class="error-message" id="food-description-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="food-expiry">Expiry Date</label>
                    <input type="date" id="food-expiry">
                    <div class="error-message" id="food-expiry-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="food-address">Pickup Address</label>
                    <textarea id="food-address" rows="2" placeholder="Where can the food be picked up?"></textarea>
                    <div class="error-message" id="food-address-error"></div>
                </div>
            </div>
            <div class="listing-modal-footer">
                <button class="listing-modal-btn secondary" id="cancel-listing-btn">Cancel</button>
                <button class="listing-modal-btn primary" id="submit-listing-btn">Share Food</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div class="modal-overlay" id="notification-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Notifications</h3>
                <button class="modal-close" id="close-notification-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="notification-item unread">
                    <div class="notification-icon">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">New Request</div>
                        <div class="notification-message">John requested your "Fresh Bread" listing</div>
                        <div class="notification-time">2 hours ago</div>
                    </div>
                </div>
                <div class="notification-item">
                    <div class="notification-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">Rating Received</div>
                        <div class="notification-message">Sarah gave you 5 stars for your donation</div>
                        <div class="notification-time">1 day ago</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="edit-profile-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Profile</h3>
                <button class="modal-close" id="close-edit-profile-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-name">Full Name</label>
                    <input type="text" id="edit-name" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="edit-email">Email</label>
                    <input type="email" id="edit-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="edit-bio">Bio</label>
                    <textarea id="edit-bio" rows="3" placeholder="Tell others a bit about yourself..."></textarea>
                </div>
                <div class="preview-avatar initials" id="edit-avatar-preview">
                    <!-- Avatar will be shown here -->
                </div>
                <div class="custom-avatar-upload">
                    <label for="edit-avatar-upload">Change Profile Picture</label>
                    <input type="file" id="edit-avatar-upload" accept="image/*">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="cancel-edit-profile">Cancel</button>
                <button class="modal-btn primary" id="save-profile-changes">Save Changes</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="change-password-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="modal-close" id="close-change-password-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" placeholder="Enter current password">
                </div>
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label for="confirm-new-password">Confirm New Password</label>
                    <input type="password" id="confirm-new-password" placeholder="Confirm new password">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="cancel-change-password">Cancel</button>
                <button class="modal-btn primary" id="save-new-password">Change Password</button>
            </div>
        </div>
    </div>
    
<div class="modal-overlay" id="delete-account-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>Delete Account</h3>
            <button class="modal-close" id="close-delete-account-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p>This will permanently delete your account and all associated data. This action cannot be undone.</p>
            <div class="form-group" style="margin-top: 15px;">
                <label for="delete-password">Enter your password to confirm</label>
                <input type="password" id="delete-password" placeholder="Enter your password">
                <div class="error-message" id="delete-password-error" style="display: none;"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn secondary" id="cancel-delete-account">Cancel</button>
            <button class="modal-btn danger" id="confirm-delete-account">
                <i class="fas fa-trash-alt"></i> Delete Account
            </button>
        </div>
    </div>
</div>
    
    <!-- Add this modal for confirmations -->
<div class="modal-overlay" id="confirmation-modal">
    <div class="modal">
        <div class="modal-header">
            <h3 id="confirmation-title">Confirm Action</h3>
            <button class="modal-close" id="close-confirmation-modal">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmation-message">Are you sure you want to perform this action?</p>
        </div>
        <div class="modal-footer">
            <button class="modal-btn secondary" id="cancel-confirmation">Cancel</button>
            <button class="modal-btn primary" id="confirm-action">Confirm</button>
        </div>
    </div>
</div>
    
    <!-- Toast Notifications -->
    <div class="toast-container" id="toast-container">
        <!-- Toasts will be dynamically inserted here -->
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCJ-SUL2Agv_R311Gh7XqYLPRpZjeQJiZU",
            authDomain: "foodshare-6017b.firebaseapp.com",
            projectId: "foodshare-6017b",
            storageBucket: "foodshare-6017b.appspot.com",
            messagingSenderId: "997283656787",
            appId: "1:997283656787:web:47e1687ce5f157094742a6",
            measurementId: "G-ZZBMQPC4P8"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
const listingsCollection = db.collection('listings');
 const requestsCollection = db.collection('requests');
const ratingsCollection = db.collection('ratings');

        // ImageBB API key
        const IMAGEBB_API_KEY = '1dbc58387d100c16d5e7012f6fd434c1';

        // App state
        let currentUser = null;
        let userData = null;
        let selectedAvatar = '1';
        let selectedAvatarFile = null;
        let selectedFoodImage = null;
        let selectedCategory = null;
        let currentPage = 'home';
        let currentChat = null;
        let unsubscribeFunctions = [];
        
        

        // DOM Elements
        const onboardingContainer = document.querySelector('.onboarding-container');
        const authContainer = document.querySelector('.auth-container');
        const profileSetupContainer = document.querySelector('.profile-setup-container');
        const appContainer = document.querySelector('.app-container');
        
        // Onboarding elements
        const onboardingSlides = document.querySelector('.onboarding-slides');
        const progressDots = document.querySelectorAll('.progress-dot');
        const skipBtn = document.querySelector('.skip-btn');
        const nextBtn = document.querySelector('.next-btn');
        
        // Auth elements
        const authTabs = document.querySelectorAll('.auth-tab');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const signupName = document.getElementById('signup-name');
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupConfirmPassword = document.getElementById('signup-confirm-password');
        const signupBtn = document.getElementById('signup-btn');
        const roleOptions = document.querySelectorAll('.role-option');
        
        // Profile setup elements
        const avatarOptions = document.querySelectorAll('.avatar-option');
        const avatarUpload = document.getElementById('avatar-upload');
        const previewAvatar = document.getElementById('preview-avatar');
        const profileBio = document.getElementById('profile-bio');
        const completeProfileBtn = document.getElementById('complete-profile-btn');
        
        // App elements
        const headerAvatar = document.getElementById('header-avatar');
        const welcomeAvatar = document.getElementById('welcome-avatar');
        const greetingText = document.getElementById('greeting-text');
        const usernameText = document.getElementById('username-text');
        const welcomeTitle = document.getElementById('welcome-title');
        const welcomeMessage = document.getElementById('welcome-message');
        const notificationIcon = document.getElementById('notification-icon');
        const notificationBadge = document.getElementById('notification-badge');
        const mobileMessageBadge = document.getElementById('mobile-message-badge');
        const fabBtn = document.getElementById('fab-btn');
        
        // Dashboard elements
        const donorDashboard = document.getElementById('donor-dashboard');
        const receiverDashboard = document.getElementById('receiver-dashboard');
        
        // Navigation elements
        const navItems = document.querySelectorAll('.nav-item');
        const sidebarLinks = document.querySelectorAll('.sidebar-nav a');
        const pages = document.querySelectorAll('.page');
        
        // Listings elements
        const listingsTitle = document.getElementById('listings-title');
        const listingsContent = document.getElementById('listings-content');
        const addListingBtn = document.getElementById('add-listing-btn');
        const viewListingsBtn = document.getElementById('view-listings-btn');
        const browseListingsBtn = document.getElementById('browse-listings-btn');
        
        // Listing modal elements
        const listingModal = document.getElementById('listing-modal');
        const closeListingModal = document.getElementById('close-listing-modal');
        const cancelListingBtn = document.getElementById('cancel-listing-btn');
        const foodImageUpload = document.getElementById('food-image-upload');
        const imagePreview = document.getElementById('image-preview');
        const uploadBtn = document.getElementById('upload-btn');
        const foodTitle = document.getElementById('food-title');
        const foodCategoryInput = document.getElementById('food-category');
        const foodDescription = document.getElementById('food-description');
        const foodExpiry = document.getElementById('food-expiry');
        const foodAddress = document.getElementById('food-address');
        const submitListingBtn = document.getElementById('submit-listing-btn');
        const categoryOptions = document.querySelectorAll('.category-option');
        
        // Messages elements
        const chatList = document.getElementById('chat-list');
        const chatPage = document.getElementById('chat-page');
        const chatContainer = document.getElementById('chat-container');
        const chatBack = document.getElementById('chat-back');
        const chatUserAvatar = document.getElementById('chat-user-avatar');
        const chatUserName = document.getElementById('chat-user-name');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendMessageBtn = document.getElementById('send-message-btn');
        const viewMessagesBtn = document.getElementById('view-messages-btn');
        
        // Profile elements
        const profilePage = document.getElementById('profile-page');
        const profileAvatar = document.getElementById('profile-avatar');
        const profileName = document.getElementById('profile-name');
        const profileRole = document.getElementById('profile-role');
        const profileBioText = document.getElementById('profile-bio');
        const editProfileBtn = document.getElementById('edit-profile-btn');
        const changePasswordBtn = document.getElementById('change-password-btn');
        const notificationSettingsBtn = document.getElementById('notification-settings-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        
        // Modal elements
        const notificationModal = document.getElementById('notification-modal');
        const closeNotificationModal = document.getElementById('close-notification-modal');
        const editProfileModal = document.getElementById('edit-profile-modal');
        const closeEditProfileModal = document.getElementById('close-edit-profile-modal');
        const cancelEditProfile = document.getElementById('cancel-edit-profile');
        const saveProfileChanges = document.getElementById('save-profile-changes');
        const editName = document.getElementById('edit-name');
        const editEmail = document.getElementById('edit-email');
        const editBio = document.getElementById('edit-bio');
        const editAvatarPreview = document.getElementById('edit-avatar-preview');
        const editAvatarUpload = document.getElementById('edit-avatar-upload');
        const changePasswordModal = document.getElementById('change-password-modal');
        const closeChangePasswordModal = document.getElementById('close-change-password-modal');
        const cancelChangePassword = document.getElementById('cancel-change-password');
        const saveNewPassword = document.getElementById('save-new-password');
        const currentPassword = document.getElementById('current-password');
        const newPassword = document.getElementById('new-password');
        const confirmNewPassword = document.getElementById('confirm-new-password');
        const deleteAccountModal = document.getElementById('delete-account-modal');
        const closeDeleteAccountModal = document.getElementById('close-delete-account-modal');
        const cancelDeleteAccount = document.getElementById('cancel-delete-account');
        const confirmDeleteAccount = document.getElementById('confirm-delete-account');
        const deletePassword = document.getElementById('delete-password');
        
        // Toast container
        const toastContainer = document.getElementById('toast-container');

        // Initialize the app
 function initApp() {
    const loadingScreen = document.getElementById('loading-screen');
    
    // Show loading screen immediately
    loadingScreen.style.display = 'flex';
    
    // Check if user has seen onboarding
    const hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding');
    
    // Check if mobile device
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile && hasSeenOnboarding) {
        checkAuthState();
    } else if (!hasSeenOnboarding) {
        loadingScreen.style.display = 'none';
        showOnboarding();
    } else {
        checkAuthState();
    }
}

        // Show onboarding slides
        function showOnboarding() {
            onboardingContainer.style.display = 'block';
            
            let currentSlide = 0;
            
            // Update progress dots
            function updateProgress() {
                progressDots.forEach((dot, index) => {
                    if (index === currentSlide) {
                        dot.classList.add('active');
                    } else {
                        dot.classList.remove('active');
                    }
                });
                
                // Update next button text on last slide
                if (currentSlide === 2) {
                    nextBtn.textContent = 'Get Started';
                } else {
                    nextBtn.textContent = 'Next';
                }
            }
            
            // Next button click
            nextBtn.addEventListener('click', () => {
                if (currentSlide < 2) {
                    currentSlide++;
                    onboardingSlides.style.transform = `translateX(-${currentSlide * 33.33}%)`;
                    updateProgress();
                } else {
                    // Onboarding complete
                    localStorage.setItem('hasSeenOnboarding', 'true');
                    onboardingContainer.style.display = 'none';
                    checkAuthState();
                }
            });
            
            // Skip button click
            skipBtn.addEventListener('click', () => {
                localStorage.setItem('hasSeenOnboarding', 'true');
                onboardingContainer.style.display = 'none';
                checkAuthState();
            });
            
            updateProgress();
        }

        // Check auth state
        function checkAuthState() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    
                    // Check if user has completed profile setup
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (userDoc.exists) {
                        userData = userDoc.data();
                        
                        // Check if profile is complete
                        if (userData.profileComplete) {
                            showApp();
                        } else {
                            showProfileSetup();
                        }
                    } else {
                        // User document doesn't exist, show profile setup
                        showProfileSetup();
                    }
                } else {
                    // No user is signed in
                    showAuth();
                }
            });
        }

        // Show auth screens
        function showAuth() {
            authContainer.style.display = 'block';
            profileSetupContainer.style.display = 'none';
            appContainer.style.display = 'none';
            
            // Switch between login and signup tabs
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    
                    authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.auth-form').forEach(form => {
                        form.classList.remove('active');
                    });
                    
                    document.getElementById(`${tabName}-form`).classList.add('active');
                });
            });
            
            // Switch to login from signup footer link
            document.getElementById('switch-to-login').addEventListener('click', (e) => {
                e.preventDefault();
                authTabs[0].click();
            });
            
            // Switch to signup from login footer link
            document.getElementById('forgot-password').addEventListener('click', (e) => {
                e.preventDefault();
                showToast('Password Reset', 'A password reset link has been sent to your email', 'success');
            });
            
            // Role selection
            roleOptions.forEach(option => {
                option.addEventListener('click', () => {
                    roleOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                });
            });
            
            // Login form submission
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                loginUser();
            });
            
            // Signup form submission
            signupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                signupUser();
            });
        }

        // Login user
        function loginUser() {
            const email = loginEmail.value.trim();
            const password = loginPassword.value.trim();
            
            // Validate inputs
            let isValid = true;
            
            if (!email) {
                document.getElementById('login-email-error').textContent = 'Email is required';
                document.getElementById('login-email-error').style.display = 'block';
                isValid = false;
            } else if (!validateEmail(email)) {
                document.getElementById('login-email-error').textContent = 'Please enter a valid email';
                document.getElementById('login-email-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('login-email-error').style.display = 'none';
            }
            
            if (!password) {
                document.getElementById('login-password-error').textContent = 'Password is required';
                document.getElementById('login-password-error').style.display = 'block';
                isValid = false;
            } else if (password.length < 6) {
                document.getElementById('login-password-error').textContent = 'Password must be at least 6 characters';
                document.getElementById('login-password-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('login-password-error').style.display = 'none';
            }
            
            if (!isValid) return;
            
            // Disable button and show loading state
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Login successful
                    currentUser = userCredential.user;
                    checkAuthState();
                })
                .catch((error) => {
                    // Handle errors
                    let errorMessage = 'Login failed. Please try again.';
                    
                    switch (error.code) {
                        case 'auth/user-not-found':
                            errorMessage = 'No user found with this email.';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Incorrect password. Please try again.';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'This account has been disabled.';
                            break;
                    }
                    
                    showToast('Login Error', errorMessage, 'error');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Login';
                });
        }

        // Signup user
        function signupUser() {
            const name = signupName.value.trim();
            const email = signupEmail.value.trim();
            const password = signupPassword.value.trim();
            const confirmPassword = signupConfirmPassword.value.trim();
            const role = document.querySelector('.role-option.selected').getAttribute('data-role');
            
            // Validate inputs
            let isValid = true;
            
            if (!name) {
                document.getElementById('signup-name-error').textContent = 'Name is required';
                document.getElementById('signup-name-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('signup-name-error').style.display = 'none';
            }
            
            if (!email) {
                document.getElementById('signup-email-error').textContent = 'Email is required';
                document.getElementById('signup-email-error').style.display = 'block';
                isValid = false;
            } else if (!validateEmail(email)) {
                document.getElementById('signup-email-error').textContent = 'Please enter a valid email';
                document.getElementById('signup-email-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('signup-email-error').style.display = 'none';
            }
            
            if (!password) {
                document.getElementById('signup-password-error').textContent = 'Password is required';
                document.getElementById('signup-password-error').style.display = 'block';
                isValid = false;
            } else if (password.length < 6) {
                document.getElementById('signup-password-error').textContent = 'Password must be at least 6 characters';
                document.getElementById('signup-password-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('signup-password-error').style.display = 'none';
            }
            
            if (!confirmPassword) {
                document.getElementById('signup-confirm-password-error').textContent = 'Please confirm your password';
                document.getElementById('signup-confirm-password-error').style.display = 'block';
                isValid = false;
            } else if (password !== confirmPassword) {
                document.getElementById('signup-confirm-password-error').textContent = 'Passwords do not match';
                document.getElementById('signup-confirm-password-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('signup-confirm-password-error').style.display = 'none';
            }
            
            if (!isValid) return;
            
            // Disable button and show loading state
            signupBtn.disabled = true;
            signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
            
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // User created successfully
                    currentUser = userCredential.user;
                    
                    // Create user document in Firestore
                    return db.collection('users').doc(currentUser.uid).set({
                        uid: currentUser.uid,
                        name: name,
                        email: email,
                        role: role,
                        profileComplete: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        avatar: null,
                        bio: ''
                    });
                })
                .then(() => {
                    // Show profile setup
                    showProfileSetup();
                })
                .catch((error) => {
                    // Handle errors
                    let errorMessage = 'Signup failed. Please try again.';
                    
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'This email is already in use.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Please enter a valid email address.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Password should be at least 6 characters.';
                            break;
                    }
                    
                    showToast('Signup Error', errorMessage, 'error');
                    signupBtn.disabled = false;
                    signupBtn.textContent = 'Create Account';
                });
        }

        // Show profile setup
        function showProfileSetup() {
            authContainer.style.display = 'none';
            profileSetupContainer.style.display = 'block';
            appContainer.style.display = 'none';
            
            // Set initial preview avatar (initials)
            if (currentUser && currentUser.email) {
                const initials = getInitials(currentUser.email);
                previewAvatar.textContent = initials;
            }
            
            // Avatar selection
            avatarOptions.forEach(option => {
                option.addEventListener('click', () => {
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedAvatar = option.getAttribute('data-avatar');
                    selectedAvatarFile = null;
                    
                    // Update preview
                    previewAvatar.innerHTML = `<img src="${option.querySelector('img').src}" alt="Selected Avatar">`;
                });
            });
            
            // Custom avatar upload
            avatarUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedAvatarFile = file;
                    selectedAvatar = null;
                    
                    // Deselect all avatar options
                    avatarOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        previewAvatar.innerHTML = `<img src="${event.target.result}" alt="Custom Avatar">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Complete profile button
            completeProfileBtn.addEventListener('click', () => {
                completeProfile();
            });
        }

        // Complete profile setup
        async function completeProfile() {
            completeProfileBtn.disabled = true;
            completeProfileBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            let avatarUrl = null;
            const bio = profileBio.value.trim();
            
            try {
                // Upload custom avatar if selected
                if (selectedAvatarFile) {
                    avatarUrl = await uploadImageToImageBB(selectedAvatarFile);
                } else if (selectedAvatar) {
                    // Use default avatar
                    avatarUrl = `https://i.ibb.co/0jQ4ZJ1/avatar${selectedAvatar}.png`;
                }
                
                // Update user document
                await db.collection('users').doc(currentUser.uid).update({
                    avatar: avatarUrl,
                    bio: bio,
                    profileComplete: true
                });
                
                // Show the app
                showApp();
            } catch (error) {
                showToast('Error', 'Failed to complete profile setup. Please try again.', 'error');
                completeProfileBtn.disabled = false;
                completeProfileBtn.textContent = 'Complete Setup';
            }
        }

        // Show the main app
        function showApp() {
    const loadingScreen = document.getElementById('loading-screen');
    
    // Fade out loading screen
    loadingScreen.style.opacity = '0';
    setTimeout(() => {
        loadingScreen.style.display = 'none';
    }, 500); // Match this with the CSS transition duration
    
    authContainer.style.display = 'none';
    profileSetupContainer.style.display = 'none';
    appContainer.style.display = 'block';
    
    // Load user data and setup the app
    loadUserData();
    setupNavigation();
    setupModals();
    setupListingModal();
    
    // Set initial page
    navigateTo('home');
    
    // Update greeting based on time of day
    updateGreeting();
}

        // Load user data
  async function loadUserData() {
    if (!currentUser) return;
    
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    
    if (userDoc.exists) {
        userData = userDoc.data();
        
        // Update UI with user data
        updateUserUI();
        
        // Set up real-time listeners based on user role
        if (userData.role === 'donor') {
            setupDonorListeners();
        } else {
            setupReceiverListeners();
        }
        
        // Set up notifications and chat listeners
        setupNotificationsListener();
        setupChatListeners();
    }
}

        // Update UI with user data
        function updateUserUI() {
    // Header
    usernameText.textContent = userData.name;
    
    // Remove welcome card references
    
    // Avatar - remove welcomeAvatar reference
    updateAvatarElements(userData.avatar, userData.name);
    
    // Profile page
    profileName.textContent = userData.name;
    profileRole.textContent = userData.role === 'donor' ? 'Donor' : 'Receiver';
    profileBioText.textContent = userData.bio || 'No bio yet';
    
    // Show appropriate dashboard
    if (userData.role === 'donor') {
        donorDashboard.style.display = 'block';
        receiverDashboard.style.display = 'none';
        listingsTitle.textContent = 'Your Listings';
        
        // Show FAB for donors
        fabBtn.style.display = 'flex';
    } else {
        donorDashboard.style.display = 'none';
        receiverDashboard.style.display = 'block';
        listingsTitle.textContent = 'Available Food';
        
        // Hide FAB for receivers
        fabBtn.style.display = 'none';
    }
    
    // Update header for current page
    updateHeaderContent();
}

        // Update avatar elements
        function updateAvatarElements(avatarUrl, name) {
    const initials = getInitials(name);
    
    // Header avatar
    const headerAvatar = document.getElementById('header-avatar');
    if (headerAvatar) {
        if (avatarUrl) {
            headerAvatar.innerHTML = `<img src="${avatarUrl}" alt="User Avatar">`;
        } else {
            headerAvatar.textContent = initials;
            headerAvatar.className = 'user-avatar initials';
        }
    }
    
    // Profile page avatar
    if (avatarUrl) {
        profileAvatar.innerHTML = `<img src="${avatarUrl}" alt="User Avatar">`;
    } else {
        profileAvatar.textContent = initials;
        profileAvatar.className = 'profile-avatar initials';
    }
}
        
        function updateHeaderContent() {
    const headerLeft = document.querySelector('.header-left');
    const headerRight = document.querySelector('.header-right');
    
    switch (currentPage) {
        case 'home':
            headerLeft.innerHTML = `
                <div class="user-avatar initials" id="header-avatar"></div>
                <div class="greeting">
                    <h2 id="greeting-text">${greetingText.textContent}</h2>
                    <p id="username-text">${userData.name}</p>
                </div>
            `;
            updateAvatarElements(userData.avatar, userData.name);
            updateGreeting();
            break;
            
        case 'listings':
            headerLeft.innerHTML = `
                <h2>${userData.role === 'donor' ? 'Your Listings' : 'Available Food'}</h2>
            `;
            break;
            
        case 'messages':
            headerLeft.innerHTML = `
                <h2>Messages</h2>
            `;
            break;
            
        case 'profile':
            headerLeft.innerHTML = `
                <h2>Your Profile</h2>
            `;
            break;
            
        case 'notifications':
            headerLeft.innerHTML = `
                <h2>Notifications</h2>
            `;
            break;
            
        case 'chat':
            headerLeft.innerHTML = `
                <div class="chat-back" id="chat-back">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <div class="chat-avatar initials" id="chat-user-avatar"></div>
                <div class="greeting">
                    <h2 id="chat-user-name">${chatUserName.textContent}</h2>
                </div>
            `;
            break;
    }
    
    // Always keep the notification icon in header right
    headerRight.innerHTML = `
        <div class="notification-icon" id="notification-icon">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notification-badge">0</span>
        </div>
    `;
    
    // Reattach event listeners
    document.getElementById('notification-icon').addEventListener('click', () => {
        notificationModal.classList.add('active');
    });
}

        // Set up donor listeners
function setupDonorListeners() {
    // Clean up any existing listeners
    unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
    unsubscribeFunctions = [];
    
    // Listen for donor's listings
    const listingsUnsubscribe = db.collection('listings')
        .where('donorId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .onSnapshot(async snapshot => {
            const listings = [];
            snapshot.forEach(doc => {
                listings.push({ id: doc.id, ...doc.data() });
            });
            
            // Update active listings count
            const activeListings = listings.filter(l => !isExpired(l.expiryDate)).length;
            document.getElementById('donor-active-listings').textContent = activeListings;
            
            // Update total donations count
            document.getElementById('donor-total-donations').textContent = listings.length;
            
            // Calculate people helped from requests
            const requestsSnapshot = await db.collection('requests')
                .where('listingId', 'in', listings.map(l => l.id))
                .where('status', '==', 'completed')
                .get();
            
            const peopleHelped = requestsSnapshot.size;
            document.getElementById('donor-people-helped').textContent = peopleHelped;
            
            // Calculate average rating
            const ratingsSnapshot = await db.collection('ratings')
                .where('donorId', '==', currentUser.uid)
                .get();
            
            let totalRating = 0;
            ratingsSnapshot.forEach(doc => {
                totalRating += doc.data().rating;
            });
            
            const averageRating = ratingsSnapshot.size > 0 ? 
                (totalRating / ratingsSnapshot.size).toFixed(1) : '0.0';
            document.getElementById('donor-rating').textContent = averageRating;
            
            // Update listings page if it's active
            if (currentPage === 'listings') {
                renderListings(listings);
            }
        }, error => {
            console.error('Error listening to listings:', error);
            showToast('Error', 'Failed to load listings', 'error');
        });
    
    unsubscribeFunctions.push(listingsUnsubscribe);
}

        // Set up receiver listeners
        function setupReceiverListeners() {
    // Clean up any existing listeners
    unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
    unsubscribeFunctions = [];
    
    // Listen for all active listings
    const listingsUnsubscribe = db.collection('listings')
        .where('expiryDate', '>=', new Date().toISOString().split('T')[0])
        .orderBy('expiryDate')
        .orderBy('createdAt', 'desc')
        .onSnapshot(async snapshot => {
            const listings = [];
            snapshot.forEach(doc => {
                listings.push({ id: doc.id, ...doc.data() });
            });
            
            // Update nearby listings count
            document.getElementById('receiver-nearby-listings').textContent = listings.length;
            
            // Update home page recently added section
            const recentlyAdded = listings.slice(0, 3);
            renderRecentlyAdded(recentlyAdded);
            
            // Update listings page if it's active
            if (currentPage === 'listings') {
                renderListings(listings);
            }
        }, error => {
            console.error('Error listening to listings:', error);
            showToast('Error', 'Failed to load listings', 'error');
        });
    
    // Listen for receiver's requests and ratings
    const requestsUnsubscribe = db.collection('requests')
        .where('receiverId', '==', currentUser.uid)
        .onSnapshot(async snapshot => {
            const totalRequests = snapshot.size;
            const successfulRequests = snapshot.docs.filter(doc => 
                doc.data().status === 'completed').length;
            
            document.getElementById('receiver-total-requests').textContent = totalRequests;
            document.getElementById('receiver-successful-requests').textContent = successfulRequests;
            
            // Calculate average rating
            const ratingsSnapshot = await db.collection('ratings')
                .where('receiverId', '==', currentUser.uid)
                .get();
            
            let totalRating = 0;
            ratingsSnapshot.forEach(doc => {
                totalRating += doc.data().rating;
            });
            
            const averageRating = ratingsSnapshot.size > 0 ? 
                (totalRating / ratingsSnapshot.size).toFixed(1) : '0.0';
            document.getElementById('receiver-rating').textContent = averageRating;
        });
    
    unsubscribeFunctions.push(listingsUnsubscribe, requestsUnsubscribe);
}

        // Set up notifications listener
        function setupNotificationsListener() {
            const notificationsUnsubscribe = db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    const unreadCount = snapshot.docs.filter(doc => !doc.data().read).length;
                    
                    // Update badge counts
                    if (unreadCount > 0) {
                        notificationBadge.textContent = unreadCount;
                        notificationBadge.style.display = 'flex';
                        mobileMessageBadge.style.display = 'flex';
                    } else {
                        notificationBadge.style.display = 'none';
                        mobileMessageBadge.style.display = 'none';
                    }
                    
                    // Update notifications page if it's active
                    if (currentPage === 'notifications') {
                        renderNotifications(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }
                });
            
            unsubscribeFunctions.push(notificationsUnsubscribe);
        }

        // Set up navigation
        function setupNavigation() {
            // Bottom nav items
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.getAttribute('data-page');
                    navigateTo(page);
                });
            });
            
            // Sidebar links
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    navigateTo(page);
                });
            });
            
            // Add listing button (homepage)
            addListingBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                showListingModal();
            });
            
            // View listings button
            viewListingsBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('listings');
            });
            
            // Browse listings button
            browseListingsBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('listings');
            });
            
            // View messages button
            viewMessagesBtn?.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('messages');
            });
            
            // Notification icon
            notificationIcon.addEventListener('click', () => {
                notificationModal.classList.add('active');
            });
            
            // Back button in chat
            chatBack.addEventListener('click', () => {
                navigateTo('messages');
            });
            
            // FAB button
            fabBtn.addEventListener('click', () => {
                showListingModal();
            });
        }

        // Navigate to a page
function navigateTo(page) {
    // If navigating away from chat, clean up and restore UI
    if (currentPage === 'chat') {
        // Remove chat-active class from body
        document.body.classList.remove('chat-active');
        
        // Hide chat page
        document.getElementById('chat-page').classList.remove('active');
        setTimeout(() => {
            document.getElementById('chat-page').style.display = 'none';
        }, 350); // Match this with your CSS transition duration
    }

    // Hide all pages
    pages.forEach(p => p.style.display = 'none');
    
    // Update current page
    currentPage = page;
    
    // Show the selected page
    document.getElementById(`${page}-page`).style.display = 'block';
    
    // Update active nav items
    updateNavItems(page);
    
    // Load page-specific content
    loadPageContent(page);
    
    // Set up appropriate listeners
    setupPageListeners(page);
}

function updateNavItems(page) {
    // Update active nav items
    navItems.forEach(item => {
        if (item.getAttribute('data-page') === page) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
    
    // Update active sidebar links
    sidebarLinks.forEach(link => {
        if (link.getAttribute('data-page') === page) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
}

function loadPageContent(page) {
    switch (page) {
        case 'home':
            // Dashboard updates handled by listeners
            break;
        case 'listings':
            loadListings();
            break;
        case 'messages':
            loadChats();
            break;
        case 'notifications':
            loadNotifications();
            break;
        case 'profile':
            // Profile updates handled by listeners
            break;
        case 'chat':
            // Chat loaded separately via openChat()
            break;
    }
}

function setupPageListeners(page) {
    // Clean up any existing listeners
    unsubscribeFunctions.forEach(unsubscribe => unsubscribe());
    unsubscribeFunctions = [];
    
    // Set up listeners based on page
    switch (page) {
        case 'home':
            if (userData.role === 'donor') {
                setupDonorListeners();
            } else {
                setupReceiverListeners();
            }
            break;
        case 'listings':
            setupListingsListeners();
            break;
        case 'messages':
            setupChatListListeners(); // Use the new function here
            break;
    }
    
    // Always set up notifications listener
    setupNotificationsListener();
}

function showPage(page) {
    // Hide all pages
    pages.forEach(p => p.style.display = 'none');
    
    // Update current page
    currentPage = page;
    
    // Show the selected page
    if (page !== 'chat') {
        document.getElementById(`${page}-page`).style.display = 'block';
    }
    
    // Update active nav items
    navItems.forEach(item => {
        if (item.getAttribute('data-page') === page) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });
    
    // Update active sidebar links
    sidebarLinks.forEach(link => {
        if (link.getAttribute('data-page') === page) {
            link.classList.add('active');
        } else {
            link.classList.remove('active');
        }
    });
    
    // Load page-specific content
    switch (page) {
        case 'home':
            // Already handled by listeners
            break;
        case 'listings':
            loadListings();
            break;
        case 'messages':
            loadChats();
            break;
        case 'notifications':
            loadNotifications();
            break;
        case 'profile':
            // Already handled by listeners
            break;
    }
    
    // Update chat listeners when changing pages
    setupChatListeners();
}

        // Load listings
        async function loadListings() {
            listingsContent.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div></div>';
            
            try {
                let query;
                
                if (userData.role === 'donor') {
                    // Donor sees their own listings
                    query = db.collection('listings')
                        .where('donorId', '==', currentUser.uid)
                        .orderBy('createdAt', 'desc');
                } else {
                    // Receiver sees all active listings
                    query = db.collection('listings')
                        .where('expiryDate', '>=', new Date().toISOString().split('T')[0])
                        .orderBy('expiryDate')
                        .orderBy('createdAt', 'desc');
                }
                
                const snapshot = await query.get();
                const listings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderListings(listings);
            } catch (error) {
                console.error('Error loading listings:', error);
                listingsContent.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>Error Loading Listings</h3><p>Please try again later</p></div>';
            }
        }

        // Render listings
        function renderListings(listings) {
            if (listings.length === 0) {
                listingsContent.innerHTML = '<div class="empty-state"><i class="fas fa-utensils"></i><h3>No Listings Found</h3><p>When listings are available, they will appear here</p></div>';
                return;
            }
            
            listingsContent.innerHTML = '<div class="listings-container"></div>';
            const container = listingsContent.querySelector('.listings-container');
            
            listings.forEach(listing => {
                const listingElement = createListingElement(listing);
                container.appendChild(listingElement);
            });
        }

        // Create listing element
        function createListingElement(listing) {
            const expired = isExpired(listing.expiryDate);
            const daysLeft = getDaysLeft(listing.expiryDate);
            
            const listingElement = document.createElement('div');
            listingElement.className = 'listing-card';
            listingElement.innerHTML = `
                <img src="${listing.imageUrl || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${listing.title}" class="listing-image">
                <div class="listing-details">
                    <div class="listing-header">
                        <h3 class="listing-title">${listing.title}</h3>
                        <span class="listing-category">${formatCategory(listing.category)}</span>
                    </div>
                    <div class="listing-meta">
                        <i class="fas fa-clock"></i> ${formatDate(listing.createdAt?.toDate())}
                        <span style="margin: 0 5px;"></span>
                        <i class="fas fa-hourglass-half"></i> ${expired ? 'Expired' : `${daysLeft} ${daysLeft === 1 ? 'day' : 'days'} left`}
                    </div>
                    <p class="listing-description">${listing.description || 'No description provided'}</p>
                    <div class="listing-footer">
                        <div class="listing-donor">
                            <div class="donor-avatar initials" id="donor-avatar-${listing.donorId}">
                                <!-- Initials will be added by JavaScript -->
                            </div>
                            <span class="donor-name">${listing.donorName}</span>
                        </div>
                        <div class="listing-actions">
                            ${userData.role === 'receiver' && !expired ? `
                                <div class="action-icon" data-action="message" data-listing-id="${listing.id}" data-donor-id="${listing.donorId}">
                                    <i class="fas fa-comment"></i>
                                </div>
                                <div class="action-icon" data-action="request" data-listing-id="${listing.id}">
                                    <i class="fas fa-hand-holding-heart"></i>
                                </div>
                            ` : ''}
                            ${userData.role === 'donor' ? `
                                <div class="action-icon" data-action="edit" data-listing-id="${listing.id}">
                                    <i class="fas fa-edit"></i>
                                </div>
                                <div class="action-icon" data-action="delete" data-listing-id="${listing.id}">
                                    <i class="fas fa-trash"></i>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            // Set donor avatar initials
            const donorAvatar = listingElement.querySelector(`#donor-avatar-${listing.donorId}`);
            if (donorAvatar) {
                const initials = getInitials(listing.donorName);
                donorAvatar.textContent = initials;
            }
            
            // Add event listeners to action buttons
            const actionIcons = listingElement.querySelectorAll('.action-icon');
            actionIcons.forEach(icon => {
                icon.addEventListener('click', (e) => {
                    const action = icon.getAttribute('data-action');
                    const listingId = icon.getAttribute('data-listing-id');
                    
                    switch (action) {
                        case 'message':
                            const donorId = icon.getAttribute('data-donor-id');
                            startChat(donorId, listingId);
                            break;
                        case 'request':
                            requestFood(listingId);
                            break;
                        case 'edit':
                            editListing(listingId);
                            break;
                        case 'delete':
                            deleteListing(listingId);
                            break;
                    }
                });
            });
            
            return listingElement;
        }

        // Render recently added listings
        function renderRecentlyAdded(listings) {
            const container = receiverDashboard.querySelector('.listings-container');
            
            if (listings.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-utensils"></i><h3>No Recent Listings</h3><p>When food is shared nearby, it will appear here</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            listings.forEach(listing => {
                const listingElement = createListingElement(listing);
                container.appendChild(listingElement);
            });
        }

        // Set up listing modal
        function setupListingModal() {
            // Image upload
            uploadBtn.addEventListener('click', (e) => {
                e.preventDefault();
                foodImageUpload.click();
            });
            
            foodImageUpload.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedFoodImage = file;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.innerHTML = `<img src="${event.target.result}" alt="Food Preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Category selection
            categoryOptions.forEach(option => {
                option.addEventListener('click', () => {
                    categoryOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedCategory = option.getAttribute('data-category');
                    foodCategoryInput.value = selectedCategory;
                });
            });
            
            // Form submission
            submitListingBtn.addEventListener('click', (e) => {
                e.preventDefault();
                submitListing();
            });
            
            // Cancel button
            cancelListingBtn.addEventListener('click', () => {
                listingModal.classList.remove('active');
                resetListingForm();
            });
            
            // Close button
            closeListingModal.addEventListener('click', () => {
                listingModal.classList.remove('active');
                resetListingForm();
            });
        }

        // Show listing modal
        function showListingModal() {
            listingModal.classList.add('active');
        }

        // Reset listing form
        function resetListingForm() {
            foodTitle.value = '';
            foodCategoryInput.value = '';
            foodDescription.value = '';
            foodExpiry.value = '';
            foodAddress.value = '';
            imagePreview.innerHTML = '<i class="fas fa-camera" style="font-size: 40px; color: var(--gray-300);"></i>';
            selectedFoodImage = null;
            selectedCategory = null;
            
            // Clear category selection
            categoryOptions.forEach(opt => opt.classList.remove('selected'));
            
            // Clear error messages
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
        }

        // Submit listing
        async function submitListing() {
            const title = foodTitle.value.trim();
            const category = foodCategoryInput.value;
            const description = foodDescription.value.trim();
            const expiryDate = foodExpiry.value;
            const address = foodAddress.value.trim();
            
            // Validate inputs
            let isValid = true;
            
            if (!title) {
                document.getElementById('food-title-error').textContent = 'Title is required';
                document.getElementById('food-title-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('food-title-error').style.display = 'none';
            }
            
            if (!category) {
                document.getElementById('food-category-error').textContent = 'Category is required';
                document.getElementById('food-category-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('food-category-error').style.display = 'none';
            }
            
            if (!expiryDate) {
                document.getElementById('food-expiry-error').textContent = 'Expiry date is required';
                document.getElementById('food-expiry-error').style.display = 'block';
                isValid = false;
            } else if (new Date(expiryDate) < new Date()) {
                document.getElementById('food-expiry-error').textContent = 'Expiry date must be in the future';
                document.getElementById('food-expiry-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('food-expiry-error').style.display = 'none';
            }
            
            if (!address) {
                document.getElementById('food-address-error').textContent = 'Pickup address is required';
                document.getElementById('food-address-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('food-address-error').style.display = 'none';
            }
            
            if (!isValid) return;
            
            // Disable button and show loading state
            submitListingBtn.disabled = true;
            submitListingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sharing...';
            
            try {
                let imageUrl = null;
                
                // Upload image if selected
                if (selectedFoodImage) {
                    imageUrl = await uploadImageToImageBB(selectedFoodImage);
                }
                
                // Create listing document
                await db.collection('listings').add({
                    title: title,
                    category: category,
                    description: description,
                    expiryDate: expiryDate,
                    pickupAddress: address,
                    imageUrl: imageUrl,
                    donorId: currentUser.uid,
                    donorName: userData.name,
                    donorAvatar: userData.avatar,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'available'
                });
                
                // Show success message
                showToast('Success', 'Your food listing has been shared!', 'success');
                
                // Close modal and reset form
                listingModal.classList.remove('active');
                resetListingForm();
                
                // Navigate to listings page
                navigateTo('listings');
            } catch (error) {
                console.error('Error submitting listing:', error);
                showToast('Error', 'Failed to share your listing. Please try again.', 'error');
                submitListingBtn.disabled = false;
                submitListingBtn.textContent = 'Share Food';
            }
        }

        // Edit listing
        function editListing(listingId) {
            // In a complete app, you would implement this
            showToast('Info', 'Edit functionality will be implemented in the full version', 'success');
        }

        // Delete listing
        function deleteListing(listingId) {
    showConfirmation(
        'Delete Listing', 
        'Are you sure you want to delete this listing? This action cannot be undone.',
        async (confirmed) => {
            if (confirmed) {
                try {
                    await db.collection('listings').doc(listingId).delete();
                    showToast('Success', 'Listing deleted successfully', 'success');
                } catch (error) {
                    console.error('Error deleting listing:', error);
                    showToast('Error', 'Failed to delete listing', 'error');
                }
            }
        }
    );
}

        // Request food
        function requestFood(listingId) {
            // In a complete app, you would implement this
            showToast('Info', 'Request functionality will be implemented in the full version', 'success');
        }

        // Start chat
async function startChat(donorId, listingId) {
    try {
        // Check if a chat already exists between these users for this listing
        const existingChat = await db.collection('chats')
            .where('participants', 'array-contains', currentUser.uid)
            .where('listingId', '==', listingId)
            .limit(1)
            .get();

        if (!existingChat.empty) {
            // Open existing chat
            const chatId = existingChat.docs[0].id;
            openChat(chatId);
            return;
        }

        // Get donor info
        const donorDoc = await db.collection('users').doc(donorId).get();
        const donorData = donorDoc.data();

        // Create new chat
        const chatRef = await db.collection('chats').add({
            participants: [currentUser.uid, donorId],
            participantNames: {
                [currentUser.uid]: userData.name,
                [donorId]: donorData.name
            },
            participantAvatars: {
                [currentUser.uid]: userData.avatar,
                [donorId]: donorData.avatar
            },
            listingId: listingId,
            lastMessage: '',
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Open the new chat
        openChat(chatRef.id);

    } catch (error) {
        console.error('Error starting chat:', error);
        showToast('Error', 'Failed to start chat', 'error');
    }
}

async function openChat(chatId) {
      // Add chat-active class to body
    document.body.classList.add('chat-active');
  
    try {
        // Get chat data
        const chatDoc = await db.collection('chats').doc(chatId).get();
        if (!chatDoc.exists) {
            throw new Error('Chat not found');
        }
        
        const chatData = chatDoc.data();

        // Get the other participant's info
        const otherParticipantId = chatData.participants.find(id => id !== currentUser.uid);
        const otherParticipantName = chatData.participantNames[otherParticipantId];
        const otherParticipantAvatar = chatData.participantAvatars[otherParticipantId];

        // Update chat UI
        const chatUserName = document.getElementById('chat-user-name');
        const chatUserAvatar = document.getElementById('chat-user-avatar');
        
        chatUserName.textContent = otherParticipantName;
        
        if (otherParticipantAvatar) {
            chatUserAvatar.innerHTML = `<img src="${otherParticipantAvatar}" alt="${otherParticipantName}">`;
            chatUserAvatar.className = 'chat-avatar';
        } else {
            const initials = getInitials(otherParticipantName);
            chatUserAvatar.textContent = initials;
            chatUserAvatar.className = 'chat-avatar initials';
        }

        // Load messages
        await loadMessages(chatId);

        // Set current chat
        currentChat = chatId;

        // Add chat-active class to body
        document.body.classList.add('chat-active');
        
        // Show chat page with animation
        const chatPage = document.getElementById('chat-page');
        chatPage.style.display = 'block';
        // Force reflow to ensure animation works
        void chatPage.offsetWidth;
        chatPage.classList.add('active');

    } catch (error) {
        console.error('Error opening chat:', error);
        showToast('Error', 'Failed to open chat', 'error');
    }
}

async function loadMessages(chatId) {
    try {
        chatMessages.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div></div>';

        const messagesSnapshot = await db.collection('chats').doc(chatId)
            .collection('messages')
            .orderBy('timestamp', 'asc')
            .get();

        if (messagesSnapshot.empty) {
            chatMessages.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><h3>Start a Conversation</h3><p>Send a message to begin chatting</p></div>';
            return;
        }

        chatMessages.innerHTML = '';

        messagesSnapshot.forEach(doc => {
            const message = doc.data();
            addMessageToUI(message, doc.id);
        });

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;

    } catch (error) {
        console.error('Error loading messages:', error);
        chatMessages.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>Error Loading Messages</h3><p>Please try again later</p></div>';
    }
}

function addMessageToUI(message, messageId) {
    const isCurrentUser = message.senderId === currentUser.uid;
    const messageElement = document.createElement('div');
    messageElement.className = `message ${isCurrentUser ? 'sent' : 'received'}`;
    
    messageElement.innerHTML = `
        <div class="message-content">${message.text}</div>
        <div class="message-time">${formatTime(message.timestamp?.toDate())}</div>
    `;
    
    chatMessages.appendChild(messageElement);
}

// Update the loadChats function
async function loadChats() {
    try {
        chatList.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div></div>';

        const chatsSnapshot = await db.collection('chats')
            .where('participants', 'array-contains', currentUser.uid)
            .orderBy('lastMessageTime', 'desc')
            .get();

        if (chatsSnapshot.empty) {
            chatList.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><h3>No Messages Yet</h3><p>When you start conversations about food listings, they will appear here</p></div>';
            return;
        }

        chatList.innerHTML = '';

        chatsSnapshot.forEach(doc => {
            const chat = doc.data();
            addChatToUI(chat, doc.id);
        });

    } catch (error) {
        console.error('Error loading chats:', error);
        chatList.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-circle"></i><h3>Error Loading Chats</h3><p>Please try again later</p></div>';
    }
}

function addChatToUI(chat, chatId) {
    const otherParticipantId = chat.participants.find(id => id !== currentUser.uid);
    const otherParticipantName = chat.participantNames[otherParticipantId];
    const otherParticipantAvatar = chat.participantAvatars[otherParticipantId];

    const chatElement = document.createElement('div');
    chatElement.className = 'chat-item';
    chatElement.setAttribute('data-chat-id', chatId);
    
    chatElement.innerHTML = `
        <div class="chat-avatar ${otherParticipantAvatar ? '' : 'initials'}" 
             style="${otherParticipantAvatar ? `background-image: url('${otherParticipantAvatar}')` : ''}">
            ${otherParticipantAvatar ? '' : getInitials(otherParticipantName)}
        </div>
        <div class="chat-details">
            <div class="chat-header">
                <div class="chat-name">${otherParticipantName}</div>
                <div class="chat-time">${formatTime(chat.lastMessageTime?.toDate())}</div>
            </div>
            <div class="chat-preview">${chat.lastMessage || 'No messages yet'}</div>
        </div>
    `;

    chatElement.addEventListener('click', () => {
        openChat(chatId);
    });

    chatList.appendChild(chatElement);
}

// Add message sending functionality
sendMessageBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

async function sendMessage() {
    const messageText = chatInput.value.trim();
    
    if (!messageText || !currentChat) return;
    
    try {
        // Add message to chat
        await db.collection('chats').doc(currentChat).collection('messages').add({
            text: messageText,
            senderId: currentUser.uid,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update chat last message
        await db.collection('chats').doc(currentChat).update({
            lastMessage: messageText,
            lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Clear input
        chatInput.value = '';
        
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Error', 'Failed to send message', 'error');
    }
}

// Add real-time chat updates
function setupChatListeners() {
    if (!currentUser) return;

    // Listen for new chats
    const chatsUnsubscribe = db.collection('chats')
        .where('participants', 'array-contains', currentUser.uid)
        .orderBy('lastMessageTime', 'desc')
        .onSnapshot(snapshot => {
            if (currentPage === 'messages') {
                chatList.innerHTML = '';
                snapshot.forEach(doc => {
                    addChatToUI(doc.data(), doc.id);
                });
            }
        });

    // Listen for new messages in current chat
    let messagesUnsubscribe = null;
    let lastSeenMessageTime = null;
    
    if (currentChat) {
messagesUnsubscribe = db.collection('chats').doc(currentChat)
    .collection('messages')
    .orderBy('timestamp', 'asc')
    .onSnapshot(snapshot => {
        if (currentPage === 'chat') {
            // Handle message display...
        } else {
            // Only show notification for truly new messages
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added' && 
                    change.doc.data().senderId !== currentUser.uid &&
                    change.doc.data().timestamp.toDate() > new Date()) { // Only truly new messages
                    showToast('New Message', 'You have a new message', 'success');
                }
            });
        }
    });
    }

    return { chatsUnsubscribe, messagesUnsubscribe };
}

// Set up chat list listeners
function setupChatListListeners() {
    if (!currentUser) return;

    // Listen for chat updates
    const chatsUnsubscribe = db.collection('chats')
        .where('participants', 'array-contains', currentUser.uid)
        .orderBy('lastMessageTime', 'desc')
        .onSnapshot(snapshot => {
            if (currentPage === 'messages') {
                chatList.innerHTML = '';
                snapshot.forEach(doc => {
                    addChatToUI(doc.data(), doc.id);
                });
            }
        });

    unsubscribeFunctions.push(chatsUnsubscribe);
}

// Helper function to format time
function formatTime(date) {
    if (!date) return '';
    return new Intl.DateTimeFormat('en-US', {
        hour: 'numeric',
        minute: 'numeric',
        hour12: true
    }).format(date);
}

        // Load notifications
        async function loadNotifications() {
            const snapshot = await db.collection('notifications')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get();
                
            const notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderNotifications(notifications);
        }

        // Render notifications
        function renderNotifications(notifications) {
            const container = document.getElementById('notifications-container');
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-bell-slash"></i><h3>No Notifications</h3><p>When you have new notifications, they will appear here</p></div>';
                return;
            }
            
            container.innerHTML = '';
            
            notifications.forEach(notification => {
                const notificationElement = document.createElement('div');
                notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
                notificationElement.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas ${getNotificationIcon(notification.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-message">${notification.message}</div>
                        <div class="notification-time">${formatDate(notification.createdAt?.toDate())}</div>
                    </div>
                `;
                
                container.appendChild(notificationElement);
                
                // Mark as read when clicked
                if (!notification.read) {
                    notificationElement.addEventListener('click', () => {
                        db.collection('notifications').doc(notification.id).update({
                            read: true
                        });
                    });
                }
            });
        }

        // Set up modals
        function setupModals() {
            // Notification modal
            closeNotificationModal.addEventListener('click', () => {
                notificationModal.classList.remove('active');
            });
            
            // Edit profile modal
            editProfileBtn.addEventListener('click', () => {
                editName.value = userData.name;
                editEmail.value = userData.email;
                editBio.value = userData.bio || '';
                
                // Set avatar preview
                if (userData.avatar) {
                    editAvatarPreview.innerHTML = `<img src="${userData.avatar}" alt="Profile Picture">`;
                } else {
                    const initials = getInitials(userData.name);
                    editAvatarPreview.textContent = initials;
                    editAvatarPreview.className = 'preview-avatar initials';
                }
                
                editProfileModal.classList.add('active');
            });
            
            closeEditProfileModal.addEventListener('click', () => {
                editProfileModal.classList.remove('active');
            });
            
            cancelEditProfile.addEventListener('click', () => {
                editProfileModal.classList.remove('active');
            });
            
            // Save profile changes
            saveProfileChanges.addEventListener('click', async () => {
                const name = editName.value.trim();
                const email = editEmail.value.trim();
                const bio = editBio.value.trim();
                let avatarUrl = userData.avatar;
                
                // Validate inputs
                if (!name) {
                    showToast('Error', 'Name is required', 'error');
                    return;
                }
                
                if (!email || !validateEmail(email)) {
                    showToast('Error', 'Please enter a valid email', 'error');
                    return;
                }
                
                // Check if avatar was changed
                if (editAvatarUpload.files[0]) {
                    try {
                        avatarUrl = await uploadImageToImageBB(editAvatarUpload.files[0]);
                    } catch (error) {
                        showToast('Error', 'Failed to upload new avatar', 'error');
                        return;
                    }
                }
                
                // Update user document
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        name: name,
                        email: email,
                        bio: bio,
                        avatar: avatarUrl
                    });
                    
                    // Update local user data
                    userData.name = name;
                    userData.email = email;
                    userData.bio = bio;
                    userData.avatar = avatarUrl;
                    
                    // Update UI
                    updateUserUI();
                    
                    // Close modal
                    editProfileModal.classList.remove('active');
                    
                    showToast('Success', 'Profile updated successfully', 'success');
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showToast('Error', 'Failed to update profile', 'error');
                }
            });
            
            // Change password modal
            changePasswordBtn.addEventListener('click', () => {
                changePasswordModal.classList.add('active');
            });
            
            closeChangePasswordModal.addEventListener('click', () => {
                changePasswordModal.classList.remove('active');
            });
            
            cancelChangePassword.addEventListener('click', () => {
                changePasswordModal.classList.remove('active');
            });
            
            // Save new password
            saveNewPassword.addEventListener('click', async () => {
                const currentPwd = currentPassword.value;
                const newPwd = newPassword.value;
                const confirmPwd = confirmNewPassword.value;
                
                // Validate inputs
                if (!currentPwd || !newPwd || !confirmPwd) {
                    showToast('Error', 'Please fill in all fields', 'error');
                    return;
                }
                
                if (newPwd.length < 6) {
                    showToast('Error', 'Password must be at least 6 characters', 'error');
                    return;
                }
                
                if (newPwd !== confirmPwd) {
                    showToast('Error', 'Passwords do not match', 'error');
                    return;
                }
                
                try {
                    // Reauthenticate user
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        currentUser.email,
                        currentPwd
                    );
                    
                    await currentUser.reauthenticateWithCredential(credential);
                    
                    // Update password
                    await currentUser.updatePassword(newPwd);
                    
                    // Close modal and clear fields
                    changePasswordModal.classList.remove('active');
                    currentPassword.value = '';
                    newPassword.value = '';
                    confirmNewPassword.value = '';
                    
                    showToast('Success', 'Password changed successfully', 'success');
                } catch (error) {
                    console.error('Error changing password:', error);
                    
                    let errorMessage = 'Failed to change password';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Current password is incorrect';
                    }
                    
                    showToast('Error', errorMessage, 'error');
                }
            });
            
            // Delete account modal
            deleteAccountBtn.addEventListener('click', () => {
                showConfirmation(
                    'Delete Account', 
                    'Are you sure you want to delete your account? This action cannot be undone. All your data will be permanently removed.',
                    async (confirmed) => {
                        if (confirmed) {
                            deleteAccountModal.classList.add('active');
                        }
                    }
                );
            });
            
            closeDeleteAccountModal.addEventListener('click', () => {
                deleteAccountModal.classList.remove('active');
            });
            
            cancelDeleteAccount.addEventListener('click', () => {
                deleteAccountModal.classList.remove('active');
            });
            
            // Confirm account deletion
          confirmDeleteAccount.addEventListener('click', async () => {
              const password = deletePassword.value;
              
              if (!password) {
                  document.getElementById('delete-password-error').textContent = 'Please enter your password';
                  document.getElementById('delete-password-error').style.display = 'block';
                  return;
              }
              
              // Disable button and show loading state
              confirmDeleteAccount.disabled = true;
              confirmDeleteAccount.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
              
              try {
                  // Reauthenticate user
                  const credential = firebase.auth.EmailAuthProvider.credential(
                      currentUser.email,
                      password
                  );
                  
                  await currentUser.reauthenticateWithCredential(credential);
                  
                  // Delete user document
                  await db.collection('users').doc(currentUser.uid).delete();
                  
                  // Delete user account
                  await currentUser.delete();
                  
                  // Sign out and show auth screen
                  showToast('Success', 'Account deleted successfully', 'success');
                  checkAuthState();
              } catch (error) {
                  console.error('Error deleting account:', error);
                  
                  let errorMessage = 'Failed to delete account';
                  if (error.code === 'auth/wrong-password') {
                      errorMessage = 'Password is incorrect';
                  }
                  
                  document.getElementById('delete-password-error').textContent = errorMessage;
                  document.getElementById('delete-password-error').style.display = 'block';
              } finally {
                  confirmDeleteAccount.disabled = false;
                  confirmDeleteAccount.textContent = 'Delete Account';
              }
          });
            
            // Logout
          logoutBtn.addEventListener('click', () => {
              showConfirmation(
                  'Log Out', 
                  'Are you sure you want to log out?',
                  async (confirmed) => {
                      if (confirmed) {
                          try {
                              await auth.signOut();
                              showToast('Success', 'You have been logged out', 'success');
                              checkAuthState();
                          } catch (error) {
                              console.error('Error signing out:', error);
                              showToast('Error', 'Failed to log out', 'error');
                          }
                      }
                  }
              );
          });
        }

        // Upload image to ImageBB
        async function uploadImageToImageBB(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMAGEBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.data.url;
                } else {
                    throw new Error('Image upload failed');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                throw error;
            }
        }

        // Update greeting based on time of day
        function updateGreeting() {
            const hour = new Date().getHours();
            let greeting;
            
            if (hour < 12) {
                greeting = 'Good Morning';
            } else if (hour < 18) {
                greeting = 'Good Afternoon';
            } else {
                greeting = 'Good Evening';
            }
            
            greetingText.textContent = greeting;
        }

        // Show toast notification
        function showToast(title, message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                </div>
                <div class="toast-content">
                    <h4>${title}</h4>
                    <p>${message}</p>
                </div>
                <div class="toast-close">&times;</div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            // Close button
            toast.querySelector('.toast-close').addEventListener('click', () => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            });
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }

        // Helper functions
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(' ');
            let initials = parts[0].charAt(0).toUpperCase();
            if (parts.length > 1) {
                initials += parts[parts.length - 1].charAt(0).toUpperCase();
            }
            return initials;
        }

        function formatDate(date) {
            if (!date) return '';
            return new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            }).format(date);
        }

        function formatCategory(category) {
            if (!category) return '';
            return category.charAt(0).toUpperCase() + category.slice(1);
        }

        function isExpired(expiryDate) {
            if (!expiryDate) return true;
            return new Date(expiryDate) < new Date();
        }

        function getDaysLeft(expiryDate) {
            if (!expiryDate) return 0;
            const today = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'request':
                    return 'fa-hand-holding-heart';
                case 'message':
                    return 'fa-comment';
                case 'rating':
                    return 'fa-star';
                default:
                    return 'fa-bell';
            }
        }

        // Custom confirmation function
        function showConfirmation(title, message, callback) {
            const modal = document.getElementById('confirmation-modal');
            const titleElement = document.getElementById('confirmation-title');
            const messageElement = document.getElementById('confirmation-message');
            const confirmBtn = document.getElementById('confirm-action');
            
            titleElement.textContent = title;
            messageElement.textContent = message;
            
            modal.classList.add('active');
            
            // Set up event listeners
            const closeModal = () => modal.classList.remove('active');
            
            document.getElementById('close-confirmation-modal').addEventListener('click', closeModal);
            document.getElementById('cancel-confirmation').addEventListener('click', closeModal);
            
            confirmBtn.onclick = () => {
                closeModal();
                callback(true);
            };
            
            // Return a promise for async/await usage
            return new Promise(resolve => {
                const originalCallback = callback;
                callback = (result) => {
                    originalCallback(result);
                    resolve(result);
                };
            });
        }
        
        document.getElementById('chat-back').addEventListener('click', () => {
    navigateTo('messages');
});

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
