<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Share</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <style>
        :root {
            --primary-green: #22c55e;
            --primary-green-dark: #16a34a;
            --primary-green-light: #86efac;
            --secondary-green: #4ade80;
            --bg-green-light: #f0fdf4;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.1);
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --sidebar-width: 280px;
            --bottom-nav-height: 70px;
            --header-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-main);
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-green-light);
            overscroll-behavior: none;
            height: 100vh;
            position: relative;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--gray-600);
            font-size: 1rem;
            margin-top: 15px;
        }

        /* Onboarding Screens */
        .onboarding-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 9998;
            overflow: hidden;
        }

        .onboarding-slides {
            display: flex;
            width: 300%;
            height: 100%;
            transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .onboarding-slide {
            width: 33.333%;
            height: 100%;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            position: relative;
        }

        .onboarding-background {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(30px);
            opacity: 0.15;
        }

        .shape-1 {
            width: 230px;
            height: 230px;
            background-color: var(--primary-green);
            top: 10%;
            left: -20%;
            animation: float-slow 20s infinite alternate ease-in-out;
        }

        .shape-2 {
            width: 180px;
            height: 180px;
            background-color: var(--primary-green-light);
            bottom: 15%;
            right: -10%;
            animation: float-slow 15s infinite alternate-reverse ease-in-out;
        }

        .shape-3 {
            width: 120px;
            height: 120px;
            background-color: var(--secondary-green);
            bottom: 25%;
            left: 10%;
            animation: float-slow 18s infinite alternate ease-in-out;
        }

        @keyframes float-slow {
            0% { transform: translate(0, 0); }
            100% { transform: translate(10px, 15px); }
        }

        .onboarding-image {
            width: 200px;
            height: 200px;
            margin-bottom: 2rem;
            background-color: var(--bg-green-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-green);
            font-size: 4rem;
            position: relative;
            z-index: 1;
            box-shadow: var(--shadow-sm);
            animation: pulse 3s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.2); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(34, 197, 94, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        .onboarding-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-green-dark);
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        .onboarding-description {
            font-size: 1rem;
            color: var(--gray-600);
            margin-bottom: 2rem;
            max-width: 350px;
            position: relative;
            z-index: 1;
            line-height: 1.6;
        }

        .onboarding-progress {
            display: flex;
            gap: 8px;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--gray-200);
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            background-color: var(--primary-green);
            transform: scale(1.2);
        }

        .onboarding-actions {
            display: flex;
            gap: 1rem;
            width: 100%;
            max-width: 350px;
            position: relative;
            z-index: 1;
        }

        .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn span {
            position: relative;
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.5s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background-color: var(--primary-green);
            color: white;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
            flex: 1;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-green-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(34, 197, 94, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--gray-100);
            color: var(--gray-600);
            flex: 1;
        }

        .btn-secondary:hover {
            background-color: var(--gray-200);
            transform: translateY(-2px);
        }

        .skip-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--gray-400);
            font-weight: 500;
            cursor: pointer;
            z-index: 1;
        }

        /* Auth Screens */
        .auth-screen {
            display: none;
            min-height: 100vh;
            flex-direction: column;
            padding: 2rem;
            background-color: white;
            max-width: 480px;
            margin: 0 auto;
            position: relative;
        }
        
        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            margin-bottom: 2.5rem;
            transform-origin: center;
            animation: logoEnter 1s ease-out;
        }
        
        @keyframes logoEnter {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .auth-logo i {
            font-size: 2.5rem;
            color: var(--primary-green);
            text-shadow: 0 2px 10px rgba(34, 197, 94, 0.3);
        }

        .auth-logo h1 {
            color: var(--primary-green-dark);
            font-size: 2rem;
            font-weight: 700;
        }

        .auth-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2.5rem;
            border-bottom: 1px solid var(--gray-200);
            position: relative;
        }
        
        .auth-tab-indicator {
            position: absolute;
            bottom: -1px;
            height: 2px;
            background-color: var(--primary-green);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .auth-tab {
            padding: 0.85rem 1.2rem;
            color: var(--gray-600);
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            z-index: 1;
            font-weight: 500;
            flex: 1;
            text-align: center;
        }

        .auth-tab.active {
            color: var(--primary-green);
            font-weight: 600;
        }

        .auth-form-container {
            flex: 1;
            perspective: 1000px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            transform-style: preserve-3d;
            transform-origin: center center;
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        #loginForm {
            animation: formEnter 0.6s ease-out 0.2s backwards;
        }
        
        #signupForm {
            animation: formEnter 0.6s ease-out;
        }
        
        @keyframes formEnter {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .input-group label {
            color: var(--gray-600);
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 0.2rem;
        }

        .input-field {
            display: flex;
            align-items: center;
            border: 1.5px solid var(--gray-300);
            border-radius: 12px;
            padding: 0 1.2rem;
            overflow: hidden;
            transition: all 0.25s ease;
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .input-field.error {
            border-color: #ef4444;
            animation: shake 0.4s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-5px); }
            40%, 80% { transform: translateX(5px); }
        }

        .input-field i {
            color: var(--gray-400);
            margin-right: 0.85rem;
            font-size: 1.1rem;
            transition: all 0.25s ease;
        }

        .input-field input, .input-field textarea {
            width: 100%;
            padding: 1rem 0;
            border: none;
            font-size: 1rem;
            background: transparent;
        }

        .input-field input:focus, .input-field textarea:focus {
            outline: none;
        }

        .input-field:focus-within {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
            transform: translateY(-2px);
        }
        
        .input-field:focus-within i {
            color: var(--primary-green);
        }

        .error-message {
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: 0.3rem;
            margin-left: 0.2rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .role-options {
            display: flex;
            gap: 1.2rem;
            margin-top: 0.8rem;
        }

        .role-option {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.7rem;
            padding: 1.7rem 1rem;
            border: 1.5px solid var(--gray-300);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }
        
        .role-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-green-light), rgba(255,255,255,0));
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 0;
        }

        .role-option:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .role-option:hover::before {
            opacity: 1;
        }

        .role-option.selected {
            border-color: var(--primary-green);
            background-color: var(--bg-green-light);
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(34, 197, 94, 0.15);
        }
        
        .role-option.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            background: var(--primary-green);
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            animation: checkmarkEnter 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes checkmarkEnter {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .role-option i {
            font-size: 2rem;
            color: var(--primary-green);
            z-index: 1;
            transition: all 0.3s ease;
        }
        
        .role-option.selected i {
            transform: scale(1.2);
        }

        .role-option h3 {
            color: var(--gray-600);
            font-size: 1.1rem;
            font-weight: 600;
            z-index: 1;
        }

        .role-option p {
            color: var(--gray-400);
            font-size: 0.9rem;
            text-align: center;
            z-index: 1;
        }

        /* Terms and Conditions */
        .terms-container {
            background-color: var(--gray-50);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
        }

        .terms-content {
            font-size: 0.8rem;
            color: var(--gray-600);
            line-height: 1.5;
        }

        .terms-content h4 {
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        .terms-content p {
            margin-bottom: 0.8rem;
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
            margin-top: 1rem;
        }

        .terms-checkbox input {
            margin-top: 0.2rem;
        }

        .terms-checkbox label {
            font-size: 0.9rem;
            color: var(--gray-600);
            line-height: 1.4;
        }

        /* Form switch animation */
        @keyframes formSwitchOut {
            from { opacity: 1; transform: rotateY(0); }
            to { opacity: 0; transform: rotateY(-20deg); }
        }
        
        @keyframes formSwitchIn {
            from { opacity: 0; transform: rotateY(20deg); }
            to { opacity: 1; transform: rotateY(0); }
        }

        /* Profile Setup Screen */
        .profile-setup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 9997;
            padding: 2rem;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }

        .profile-setup-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-setup-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-green-dark);
            margin-bottom: 0.5rem;
        }

        .profile-setup-subtitle {
            font-size: 1rem;
            color: var(--gray-600);
        }

        .profile-form {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .avatar-choice {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .avatar-choice-btn {
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: var(--gray-100);
            color: var(--gray-600);
            border: none;
        }

        .avatar-choice-btn.active {
            background-color: var(--primary-green);
            color: white;
        }

        .avatar-options {
            display: flex;
            gap: 1.5rem;
            margin: 1rem 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .avatar-option.selected {
            border: 3px solid var(--primary-green);
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(34, 197, 94, 0.3);
        }

        .avatar-option.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--primary-green);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .avatar-option.color-1 {
            background-color: #3b82f6;
        }

        .avatar-option.color-2 {
            background-color: #ef4444;
        }

        .avatar-option.color-3 {
            background-color: #f59e0b;
        }

        .avatar-option.color-4 {
            background-color: #8b5cf6;
        }

        .avatar-option.color-5 {
            background-color: #10b981;
        }

        .avatar-option.color-6 {
            background-color: #ec4899;
        }

        .custom-avatar-upload {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background-color: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview i {
            font-size: 3rem;
            color: var(--gray-400);
        }

        .upload-btn {
            background-color: var(--gray-100);
            color: var(--gray-600);
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background-color: var(--gray-200);
        }

        /* Main App Container */
        .app-container {
            display: none;
            height: 100vh;
            width: 100%;
            position: relative;
        }

        /* Sidebar - Visible on wide screens */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100%;
            background-color: white;
            box-shadow: var(--shadow-md);
            z-index: 100;
            display: none;
            flex-direction: column;
            padding: 1.5rem;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
            overflow: hidden;
        }

        .sidebar-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-user-info h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 0.2rem;
        }

        .sidebar-user-info p {
            font-size: 0.8rem;
            color: var(--gray-400);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .sidebar-user-info p i {
            font-size: 0.7rem;
        }

        .sidebar-user-info .verified {
            color: var(--primary-green);
        }

        .sidebar-user-info .unverified {
            color: #f59e0b;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray-600);
            text-decoration: none;
        }

        .sidebar-item i {
            font-size: 1.1rem;
            width: 24px;
            text-align: center;
        }

        .sidebar-item:hover {
            background-color: var(--bg-green-light);
            color: var(--primary-green);
        }

        .sidebar-item.active {
            background-color: var(--bg-green-light);
            color: var(--primary-green);
            font-weight: 600;
        }

        .sidebar-footer {
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        .sidebar-footer .sidebar-item {
            color: #ef4444;
        }

        .sidebar-footer .sidebar-item:hover {
            background-color: #fef2f2;
        }

        /* Mobile Header - Visible on small screens */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: var(--header-height);
            background-color: var(--primary-green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            z-index: 90;
            box-shadow: var(--shadow-md);
        }

        .mobile-header-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .mobile-header-actions {
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }

        .mobile-header-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
        }

        .mobile-header-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .mobile-header-avatar i {
            font-size: 1rem;
            color: white;
        }

        .notification-badge {
            position: relative;
            cursor: pointer;
        }

        .notification-badge i {
            font-size: 1.3rem;
            color: white;
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Bottom Navigation - Visible on small screens */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--bottom-nav-height);
            background-color: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 90;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            border-radius:20px 20px 0 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            color: var(--gray-400);
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-item i {
            font-size: 1.3rem;
        }

        .nav-item.active {
            color: var(--primary-green);
        }

        .nav-item .badge {
            top: -2px;
            right: -8px;
        }

        /* Main Content */
        .main-content {
            margin-top: var(--header-height);
            margin-bottom: var(--bottom-nav-height);
            padding: 1.5rem;
            height: calc(100vh - var(--header-height) - var(--bottom-nav-height));
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Page transition */
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Loading state for pages */
        .page-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 1rem;
        }

        .page-loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--gray-200);
            border-top: 4px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .page-loading-text {
            color: var(--gray-500);
            font-size: 0.9rem;
        }

        /* Skeleton loading */
        .skeleton {
            background-color: var(--gray-200);
            border-radius: 8px;
            animation: pulse 1.5s infinite ease-in-out;
        }

        .skeleton-card {
            height: 120px;
            width: 100%;
            margin-bottom: 1rem;
        }

        .skeleton-text {
            height: 16px;
            width: 80%;
            margin-bottom: 0.5rem;
        }

        .skeleton-text.short {
            width: 50%;
        }

        /* Home Page */
        .welcome-message {
            margin-bottom: 2rem;
        }

        .greeting {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-green-dark);
            margin-bottom: 0.5rem;
        }

        .user-name {
            color: var(--gray-600);
            font-size: 1rem;
        }

.stats-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            flex: 1 1 calc(50% - 0.5rem);
            background-color: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .stat-card {
                flex: 1 1 calc(25% - 0.75rem);
            }
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        .stat-title {
            font-size: 0.9rem;
            color: var(--gray-400);
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-green-dark);
            margin-bottom: 0.5rem;
        }
        .stat-change {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .stat-change.positive {
            color: var(--primary-green);
        }
        .stat-change.negative {
            color: #ef4444;
        }
        
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .action-card {
            flex: 1 1 calc(50% - 0.5rem);
            background-color: white;
            border-radius: 16px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 0.8rem;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: var(--gray-600);
        }
        
        @media (min-width: 768px) {
            .action-card {
                flex: 1 1 calc(25% - 0.75rem);
            }
        }
        
        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        .action-card i {
            font-size: 1.8rem;
            color: var(--primary-green);
        }
        .action-card h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title a {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary-green);
            text-decoration: none;
        }

        /* Food Listings */
        .food-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .food-card {
            background-color: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .food-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .food-image {
            height: 160px;
            background-color: var(--gray-100);
            position: relative;
            overflow: hidden;
        }

        .food-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .food-card:hover .food-image img {
            transform: scale(1.05);
        }

        .food-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--primary-green);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .food-details {
            padding: 1.2rem;
        }

        .food-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .food-description {
            font-size: 0.9rem;
            color: var(--gray-400);
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .food-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--gray-400);
        }

        .food-distance {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .food-expiry {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .food-expiry.soon {
            color: #f59e0b;
        }

        .food-expiry.expired {
            color: #ef4444;
        }

        /* Verification Banner */
        .verification-banner {
            background-color: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .verification-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .verification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fef3c7;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #d97706;
            font-size: 1.2rem;
        }

        .verification-text h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 0.2rem;
        }

        .verification-text p {
            font-size: 0.9rem;
            color: var(--gray-400);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 3rem 1rem;
            background-color: var(--bg-green-light);
            margin-bottom: ;
        }

        .empty-state i {
            font-size: 3rem;
            color: var(--gray-300);
            margin-bottom: 1.5rem;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.9rem;
            color: var(--gray-400);
            margin-bottom: 1.5rem;
            max-width: 300px;
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: calc(var(--bottom-nav-height) + 20px);
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-green);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            z-index: 80;
            transition: all 0.3s ease;
            display: flex;
        }

        .fab:hover {
            background-color: var(--primary-green-dark);
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        /* Verification Modal */
        .verification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 999;
            display: none;
            flex-direction: column;
            padding: 2rem;
            overflow-y: auto;
        }

        .verification-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .verification-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-green-dark);
            margin-bottom: 0.5rem;
        }

        .verification-subtitle {
            font-size: 1rem;
            color: var(--gray-600);
            margin-bottom: 2rem;
        }

        .verification-steps {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-bottom: 2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .verification-step {
            display: flex;
            gap: 1.5rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--bg-green-light);
            color: var(--primary-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
        }

        .step-description {
            font-size: 0.9rem;
            color: var(--gray-500);
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .verification-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Create Listing Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background-color: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease-out;
            box-shadow: var(--shadow-lg);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--gray-600);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--gray-600);
            font-size: 0.9rem;
        }

        .image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            background-color: var(--gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview i {
            font-size: 3rem;
            color: var(--gray-400);
        }

        .upload-label {
            background-color: var(--gray-100);
            color: var(--gray-600);
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-label:hover {
            background-color: var(--gray-200);
        }

        .category-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .category-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 0.5rem;
            border: 1.5px solid var(--gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .category-option i {
            font-size: 1.5rem;
            color: var(--gray-400);
        }

        .category-option h4 {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 600;
        }

        .category-option.selected {
            border-color: var(--primary-green);
            background-color: var(--bg-green-light);
        }

        .category-option.selected i {
            color: var(--primary-green);
        }

        /* Delete Account Modal */
        .delete-account-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            z-index: 999;
            display: none;
            flex-direction: column;
            padding: 2rem;
            text-align: center;
        }

        .delete-account-icon {
            font-size: 3rem;
            color: #ef4444;
            margin-bottom: 1rem;
        }

        .delete-account-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .delete-account-text {
            font-size: 1rem;
            color: var(--gray-600);
            margin-bottom: 2rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .delete-account-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            width: 90%;
            max-width: 400px;
        }

        .toast {
            background-color: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.3s ease-out;
            transition: all 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .toast.hide {
            animation: slideOut 0.3s ease-out forwards;
        }

        @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(20px); opacity: 0; }
        }

        .toast-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .toast-success .toast-icon {
            background-color: var(--bg-green-light);
            color: var(--primary-green);
        }

        .toast-error .toast-icon {
            background-color: #fef2f2;
            color: #ef4444;
        }

        .toast-warning .toast-icon {
            background-color: #fffbeb;
            color: #f59e0b;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-600);
            margin-bottom: 0.2rem;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--gray-400);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--gray-400);
            font-size: 1rem;
            cursor: pointer;
        }

        /* Responsive Layout */
        @media (min-width: 768px) {
            .app-container {
                padding-left: var(--sidebar-width);
            }

            .sidebar {
                display: flex;
            }

            .mobile-header {
                display: none;
            }

            .bottom-nav {
                display: none;
            }

            .main-content {
                margin-top: 0;
                margin-bottom: 0;
                height: 100vh;
                padding: 2rem;
            }

            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }

            .fab {
                bottom: 30px;
                right: 30px;
            }
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .auth-screen {
                padding: 1.5rem;
                border-radius: 0;
            }

            .role-options {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .food-list {
                grid-template-columns: 1fr;
            }
        }
        
        /* Add these styles to your existing CSS */
.search-container {
    margin-bottom: 1.5rem;
    position: relative;
}

.search-input {
    width: 100%;
    padding: 1rem 1rem 1rem 3rem;
    border: 1px solid var(--gray-300);
    border-radius: 12px;
    font-size: 1rem;
    background-color: white;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: var(--primary-green);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
}

.search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
}

.category-filters {
    display: flex;
    gap: 0.8rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
    scrollbar-width: none; /* Firefox */
}

.category-filters::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
}

.category-filter {
    flex: 0 0 auto;
    padding: 0.6rem 1.2rem;
    border-radius: 20px;
    background-color: var(--gray-100);
    color: var(--gray-600);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.category-filter:hover {
    background-color: var(--gray-200);
}

.category-filter.active {
    background-color: var(--primary-green);
    color: white;
}

/* Updated listing card styles */
.food-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.food-card {
    background-color: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
    cursor: pointer;
    display: flex;
    flex-direction: column;
}

.food-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
}

.listing-image {
    width: 100%;
    height: 180px;
    object-fit: cover;
}

.listing-details {
    padding: 1.2rem;
    flex: 1;
    display: flex;
    flex-direction: column;
}

.listing-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.8rem;
}

.listing-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--gray-700);
    margin: 0;
    flex: 1;
}

.listing-category {
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
    background-color: var(--primary-green);
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    margin-left: 0.8rem;
}

.listing-meta {
    font-size: 0.8rem;
    color: var(--gray-500);
    margin-bottom: 0.8rem;
    display: flex;
    align-items: center;
}

.listing-description {
    font-size: 0.9rem;
    color: var(--gray-600);
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex: 1;
}

.listing-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: auto;
}

.listing-donor {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.donor-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: 600;
    color: white;
}

.donor-name {
    font-size: 0.8rem;
    color: var(--gray-600);
}

.listing-actions {
    display: flex;
    gap: 0.8rem;
}

.action-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-600);
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-icon:hover {
    background-color: var(--primary-green);
    color: white;
}


.notification-item {
    padding: 1rem;
    border-bottom: 1px solid var(--gray-200);
    transition: all 0.3s ease;
    cursor: pointer;
}

.notification-item:hover {
    background-color: var(--gray-50);
}

.notification-item.unread {
    background-color: var(--bg-green-light);
}

.notification-content {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
}

.notification-text {
    flex: 1;
}

.notification-time {
    font-size: 0.8rem;
    color: var(--gray-400);
    margin-top: 0.3rem;
    display: block;
}

.notification-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.8rem;
}

.notification-badge {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--primary-green);
    margin-left: 0.5rem;
}

/* Chat Page Styles */
.chat-header {
    position: fixed;
    top: var(--header-height);
    left: 0;
    width: 100%;
    background-color: white;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border-bottom: 1px solid var(--gray-200);
    z-index: 10;
}

.chat-header-back {
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--gray-600);
}

.chat-header-info {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    flex: 1;
}

.chat-header-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: var(--gray-100);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: white;
    overflow: hidden;
}

.chat-messages {
    margin-top: calc(var(--header-height) + 60px);
    margin-bottom: 70px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    height: calc(100vh - var(--header-height) - 70px - 60px);
    overflow-y: auto;
}

.message {
    max-width: 80%;
    padding: 0.8rem 1rem;
    border-radius: 18px;
    position: relative;
}

.message.sent {
    align-self: flex-end;
    background-color: var(--primary-green);
    color: white;
    border-bottom-right-radius: 4px;
}

.message.received {
    align-self: flex-start;
    background-color: var(--gray-100);
    color: var(--gray-800);
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 0.7rem;
    opacity: 0.7;
    margin-top: 0.3rem;
    text-align: right;
}

.chat-input-container {
    position: fixed;
    bottom: var(--bottom-nav-height);
    left: 0;
    width: 100%;
    padding: 0.8rem;
    background-color: white;
    border-top: 1px solid var(--gray-200);
    display: flex;
    gap: 0.8rem;
    z-index: 10;
}

.chat-input {
    flex: 1;
    padding: 0.8rem 1.2rem;
    border: 1px solid var(--gray-300);
    border-radius: 24px;
    font-size: 1rem;
}

.chat-send-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background-color: var(--primary-green);
    color: white;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
}

@media (min-width: 768px) {
    .chat-header {
        left: var(--sidebar-width);
        width: calc(100% - var(--sidebar-width));
    }
    
    .chat-messages {
        margin-left: var(--sidebar-width);
    }
    
    .chat-input-container {
        left: var(--sidebar-width);
        width: calc(100% - var(--sidebar-width));
    }
}

/* Add to your existing CSS */
.chat-page {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 1000;
    display: flex;
    flex-direction: column;
}

.chat-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: white;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    border-bottom: 1px solid var(--gray-200);
    z-index: 10;
}

.chat-messages {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
    margin-top: 60px; /* Height of header */
    margin-bottom: 70px; /* Height of input */
}

.chat-input-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    padding: 0.8rem;
    background-color: white;
    border-top: 1px solid var(--gray-200);
    display: flex;
    gap: 0.8rem;
    z-index: 10;
}

/* Hide header and bottom nav when in chat */
.chat-page-active .mobile-header,
.chat-page-active .bottom-nav {
    display: none;
}

.chat-page-active .main-content {
    margin-top: 0;
    margin-bottom: 0;
}
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading Food Share</div>
    </div>

    <!-- Onboarding Screens -->
    <div class="onboarding-container" id="onboardingContainer">
        <button class="skip-btn" id="skipBtn">Skip</button>
        <div class="onboarding-slides" id="onboardingSlides">
            <!-- Slide 1 -->
            <div class="onboarding-slide">
                <div class="onboarding-background">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                </div>
                <div class="onboarding-image">
                    <i class="fas fa-hand-holding-heart"></i>
                </div>
                <h2 class="onboarding-title">Share Surplus Food</h2>
                <p class="onboarding-description">Help reduce food waste by sharing your surplus food with those in need in your community.</p>
                <div class="onboarding-progress">
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                </div>
                   <div class="onboarding-actions">
                      <button class="btn btn-primary" id="nextBtn1">Next</button>
                  </div>
            </div>

            <!-- Slide 2 -->
            <div class="onboarding-slide">
                <div class="onboarding-background">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                </div>
                <div class="onboarding-image">
                    <i class="fas fa-hands-helping"></i>
                </div>
                <h2 class="onboarding-title">Find Available Food</h2>
                <p class="onboarding-description">Discover fresh food available near you and connect with donors to arrange pickup.</p>
                <div class="onboarding-progress">
                    <div class="progress-dot"></div>
                    <div class="progress-dot active"></div>
                    <div class="progress-dot"></div>
                </div>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" id="prevBtn2">Back</button>
                    <button class="btn btn-primary" id="nextBtn2">Next</button>
                </div>
            </div>

            <!-- Slide 3 -->
            <div class="onboarding-slide">
                <div class="onboarding-background">
                    <div class="shape shape-1"></div>
                    <div class="shape shape-2"></div>
                    <div class="shape shape-3"></div>
                </div>
                <div class="onboarding-image">
                    <i class="fas fa-heart"></i>
                </div>
                <h2 class="onboarding-title">Make a Difference</h2>
                <p class="onboarding-description">Join our community of donors and receivers to fight hunger and reduce food waste together.</p>
                <div class="onboarding-progress">
                    <div class="progress-dot"></div>
                    <div class="progress-dot"></div>
                    <div class="progress-dot active"></div>
                </div>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" id="prevBtn3">Back</button>
                    <button class="btn btn-primary" id="getStartedBtn">Get Started</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-logo">
            <i class="fas fa-seedling"></i>
            <h1>Food Share</h1>
        </div>

        <div class="auth-tabs">
            <div class="auth-tab active" id="loginTab" onclick="switchTab('login')">Login</div>
            <div class="auth-tab" id="signupTab" onclick="switchTab('signup')">Sign Up</div>
            <div class="auth-tab-indicator" id="tabIndicator" style="left: 0; width: 50%;"></div>
        </div>

        <div class="auth-form-container">
            <!-- Login Form -->
            <form class="auth-form" id="loginForm">
                <div class="input-group">
                    <label for="loginEmail">Email</label>
                    <div class="input-field">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="loginEmail" placeholder="Enter your email">
                    </div>
                    <div class="error-message" id="loginEmailError">Please enter a valid email</div>
                </div>

                <div class="input-group">
                    <label for="loginPassword">Password</label>
                    <div class="input-field">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <div class="error-message" id="loginPasswordError">Password must be at least 6 characters</div>
                </div>

                <button type="button" class="btn btn-primary" onclick="login()" id="loginBtn">
                    <span>Login</span>
                </button>
            </form>

            <!-- Signup Form -->
            <form class="auth-form" id="signupForm" style="display: none;">
                <div class="input-group">
                    <label for="signupName">Full Name</label>
                    <div class="input-field">
                        <i class="fas fa-user"></i>
                        <input type="text" id="signupName" placeholder="Enter your full name">
                    </div>
                    <div class="error-message" id="signupNameError">Please enter your name</div>
                </div>

                <div class="input-group">
                    <label for="signupEmail">Email</label>
                    <div class="input-field">
                        <i class="fas fa-envelope"></i>
                        <input type="email" id="signupEmail" placeholder="Enter your email">
                    </div>
                    <div class="error-message" id="signupEmailError">Please enter a valid email</div>
                </div>

                <div class="input-group">
                    <label for="signupPassword">Password</label>
                    <div class="input-field">
                        <i class="fas fa-lock"></i>
                        <input type="password" id="signupPassword" placeholder="Enter your password">
                    </div>
                    <div class="error-message" id="signupPasswordError">Password must be at least 6 characters</div>
                </div>

                <div class="input-group">
                    <label>Select your role</label>
                    <div class="role-options">
                        <div class="role-option selected" onclick="selectRoleOption(this, 'donor')">
                            <i class="fas fa-hand-holding-heart"></i>
                            <h3>Donor</h3>
                            <p>Share surplus food</p>
                        </div>
                        <div class="role-option" onclick="selectRoleOption(this, 'receiver')">
                            <i class="fas fa-hands-helping"></i>
                            <h3>Receiver</h3>
                            <p>Find available food</p>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Terms and Conditions</label>
                    <div class="terms-container">
                        <div class="terms-content">
                            <h4>Food Share Terms of Service</h4>
                            <p>By creating an account, you agree to our Terms of Service and Privacy Policy. You understand that Food Share is a platform to connect food donors with receivers, and we do not guarantee the quality or safety of any food items shared.</p>
                            <p>Donors must ensure food is safe for consumption and properly stored. Receivers must verify food quality before consumption.</p>
                            <p>You agree to use the platform responsibly and comply with all local laws and regulations regarding food sharing.</p>
                        </div>
                    </div>
                    <div class="terms-checkbox">
                        <input type="checkbox" id="agreeTerms" required>
                        <label for="agreeTerms">I agree to the Terms of Service and Privacy Policy</label>
                    </div>
                    <div class="error-message" id="termsError">You must agree to the terms</div>
                </div>

                <button type="button" class="btn btn-primary" onclick="signup()" id="signupBtn">
                    <span>Create Account</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Profile Setup Screen -->
    <div class="profile-setup" id="profileSetup">
        <div class="profile-setup-header">
            <h1 class="profile-setup-title">Welcome to Food Share!</h1>
            <p class="profile-setup-subtitle">Let's set up your profile</p>
        </div>

        <form class="profile-form" id="profileForm">
            <div class="avatar-choice">
                <button type="button" class="avatar-choice-btn active" id="defaultAvatarBtn">Default Avatar</button>
                <button type="button" class="avatar-choice-btn" id="customAvatarBtn">Upload Photo</button>
            </div>

            <div class="avatar-options" id="defaultAvatarOptions">
                <div class="avatar-option color-1 selected" onclick="selectDefaultAvatar(this, 'A')">
                    <span>A</span>
                </div>
                <div class="avatar-option color-2" onclick="selectDefaultAvatar(this, 'B')">
                    <span>B</span>
                </div>
                <div class="avatar-option color-3" onclick="selectDefaultAvatar(this, 'C')">
                    <span>C</span>
                </div>
                <div class="avatar-option color-4" onclick="selectDefaultAvatar(this, 'D')">
                    <span>D</span>
                </div>
                <div class="avatar-option color-5" onclick="selectDefaultAvatar(this, 'E')">
                    <span>E</span>
                </div>
                <div class="avatar-option color-6" onclick="selectDefaultAvatar(this, 'F')">
                    <span>F</span>
                </div>
            </div>

            <div class="custom-avatar-upload" id="customAvatarUpload">
                <div class="avatar-preview" id="avatarPreview">
                    <i class="fas fa-user"></i>
                </div>
                <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
                <label for="avatarUpload" class="upload-btn">Choose Photo</label>
            </div>

            <div class="input-group">
                <label for="profileBio">Bio (Optional)</label>
                <div class="input-field" style="align-items: flex-start; padding-top: 1rem;">
                    <i class="fas fa-align-left" style="margin-top: 1rem;"></i>
                    <textarea id="profileBio" placeholder="Tell us about yourself" style="width: 100%; border: none; resize: none; min-height: 100px; padding: 1rem 0; font-size: 1rem; font-family: var(--font-main);"></textarea>
                </div>
            </div>

            <div class="input-group">
                <label for="profileLocation">Location</label>
                <div class="input-field">
                    <i class="fas fa-map-marker-alt"></i>
                    <input type="text" id="profileLocation" placeholder="Enter your location">
                </div>
            </div>

            <div class="input-group" id="organizationGroup">
                <label for="profileOrganization">Organization (Optional)</label>
                <div class="input-field">
                    <i class="fas fa-building"></i>
                    <input type="text" id="profileOrganization" placeholder="Enter organization name">
                </div>
            </div>

            <button type="button" class="btn btn-primary" id="completeProfileBtn" style="margin-top: 1rem;">
                <span>Complete Profile</span>
            </button>
        </form>
    </div>

    <!-- Verification Modal -->
    <div class="verification-modal" id="verificationModal">
        <div class="verification-header">
            <h1 class="verification-title">Verify Your Account</h1>
            <p class="verification-subtitle">Complete verification to access all features of Food Share</p>
        </div>

        <div class="verification-steps">
            <div class="verification-step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <h3 class="step-title">Upload Identification</h3>
                    <p class="step-description">Submit a clear photo of your government-issued ID (driver's license, passport, etc.)</p>
                    <div class="image-upload" style="margin-top: 1rem;">
                        <div class="image-preview" id="idImagePreview">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <input type="file" id="idImageUpload" accept="image/*" style="display: none;">
                        <label for="idImageUpload" class="upload-btn">Upload ID Photo</label>
                    </div>
                </div>
            </div>

            <div class="verification-step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <h3 class="step-title">Proof of Address</h3>
                    <p class="step-description">Submit a recent utility bill or bank statement showing your name and address</p>
                    <div class="image-upload" style="margin-top: 1rem;">
                        <div class="image-preview" id="addressImagePreview">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <input type="file" id="addressImageUpload" accept="image/*" style="display: none;">
                        <label for="addressImageUpload" class="upload-btn">Upload Document</label>
                    </div>
                </div>
            </div>

            <div class="verification-step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <h3 class="step-title">Additional Information</h3>
                    <p class="step-description">Tell us why you want to join Food Share (optional but recommended)</p>
                    <div class="input-field" style="margin-top: 1rem; align-items: flex-start; padding-top: 1rem;">
                        <i class="fas fa-comment" style="margin-top: 1rem;"></i>
                        <textarea id="verificationMessage" placeholder="Briefly explain your interest in Food Share" style="width: 100%; border: none; resize: none; min-height: 80px; padding: 1rem 0; font-size: 1rem; font-family: var(--font-main);"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="verification-actions">
            <button class="btn btn-secondary" onclick="hideVerificationModal()">Cancel</button>
            <button class="btn btn-primary" onclick="submitVerification()" id="submitVerificationBtn">Submit for Review</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-avatar" id="sidebarAvatar">
                    <span id="sidebarAvatarInitial">A</span>
                    <img id="sidebarAvatarImage" style="display: none;">
                </div>
                <div class="sidebar-user-info">
                    <h3 id="sidebarUserName">User Name</h3>
                    <p id="sidebarUserStatus">
                        <i class="fas fa-check-circle verified" id="verifiedIcon" style="display: none;"></i>
                        <i class="fas fa-exclamation-circle unverified" id="unverifiedIcon"></i>
                        <span id="statusText">Unverified</span>
                    </p>
                </div>
            </div>

            <div class="sidebar-nav">
                <a href="#" class="sidebar-item active" onclick="showPage('home')">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>
                <a href="#" class="sidebar-item" onclick="showPage('listings')" id="listingsNavItem">
                    <i class="fas fa-utensils"></i>
                    <span>My Listings</span>
                </a>
                <a href="#" class="sidebar-item" onclick="showPage('messages')">
                    <i class="fas fa-comments"></i>
                    <span>Messages</span>
                    <span class="badge" id="messageBadge" style="display: none;">3</span>
                </a>
                <a href="#" class="sidebar-item" onclick="showPage('notifications')">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                    <span class="badge" id="notificationBadge" style="display: none;">5</span>
                </a>
            </div>

            <div class="sidebar-footer">
                <a href="#" class="sidebar-item" onclick="showPage('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>
                <a href="#" class="sidebar-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>

        <!-- Mobile Header -->
        <div class="mobile-header">
            <h1 class="mobile-header-title" id="mobileHeaderTitle">Home</h1>
            <div class="mobile-header-actions">
                <div class="notification-badge" onclick="toggleNotificationsModal()">
                      <i class="fas fa-bell"></i>
                      <span class="badge" id="mobileNotificationBadge" style="display: none;">0</span>
                  </div>
                <div class="mobile-header-avatar" id="mobileHeaderAvatar" onclick="showPage('profile')">
                    <span id="mobileAvatarInitial">A</span>
                    <img id="mobileAvatarImage" style="display: none;">
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Home Page Content -->
            <div class="page-content" id="homePage">
                <div class="welcome-message">
                    <h1 class="greeting" id="greeting">Good Morning</h1>
                    <p class="user-name" id="welcomeUserName">Welcome back, User!</p>
                </div>

                <div id="verificationBanner" class="verification-banner" style="display: none;">
                    <div class="verification-content">
                        <div class="verification-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="verification-text">
                            <h3>Verify Your Account</h3>
                            <p>Complete verification to access all features</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="showVerificationModal()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Verify Now
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <p class="stat-title">Total Donations</p>
                        <h2 class="stat-value" id="totalDonations">0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>0% from last month</span>
                        </p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-title">People Helped</p>
                        <h2 class="stat-value" id="peopleHelped">0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>0% from last month</span>
                        </p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-title">Your Rating</p>
                        <h2 class="stat-value" id="userRating">0.0</h2>
                        <p class="stat-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span>0.0 from last month</span>
                        </p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-title">Active Listings</p>
                        <h2 class="stat-value" id="activeListings">0</h2>
                        <p class="stat-change negative">
                            <i class="fas fa-arrow-down"></i>
                            <span>0 from yesterday</span>
                        </p>
                    </div>
                </div>

                <div class="quick-actions">
                    <a href="#" class="action-card" onclick="showPage('listings')">
                        <i class="fas fa-utensils"></i>
                        <h3>Browse Listings</h3>
                    </a>
                    <a href="#" class="action-card" onclick="showPage('messages')">
                        <i class="fas fa-comments"></i>
                        <h3>Messages</h3>
                    </a>
                    <a href="#" class="action-card" onclick="showPage('notifications')">
                        <i class="fas fa-bell"></i>
                        <h3>Notifications</h3>
                    </a>
                    <a href="#" class="action-card" onclick="showPage('profile')">
                        <i class="fas fa-user"></i>
                        <h3>Profile</h3>
                    </a>
                </div>

            </div>

            <!-- Listings Page Content -->
            <div class="page-content" id="listingsPage" style="display: none;">
                <div class="section-title">
                    <h2 id="listingsPageTitle" style="display:none;">Food Listings</h2>
                    <div id="listingsPageActions"style="display:none;"></div>
                </div>

                <div id="listingsContent">
                    <div class="page-loading">
                        <div class="page-loading-spinner"></div>
                        <div class="page-loading-text">Loading listings...</div>
                    </div>
                </div>
            </div>

            <!-- Messages Page Content -->
            <div class="page-content" id="messagesPage" style="display: none;">

                <div id="messagesContent">
                    <div class="page-loading">
                        <div class="page-loading-spinner"></div>
                        <div class="page-loading-text">Loading messages...</div>
                    </div>
                </div>
            </div>
            
 <!-- Chat Page Content -->
<div class="page-content" id="chatPage" style="display: none;">
    <div class="chat-header">
        <div class="chat-header-back" onclick="backToMessages()">
            <i class="fas fa-arrow-left"></i>
        </div>
        <div class="chat-header-info">
            <div class="chat-header-avatar" id="chatHeaderAvatar">
                <span id="chatAvatarInitial">U</span>
                <img id="chatAvatarImage" style="display: none;">
            </div>
            <h3 id="chatHeaderName">User</h3>
        </div>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        <div class="empty-state">
            <i class="fas fa-comments"></i>
            <h3>No messages yet</h3>
            <p>Send a message to start the conversation!</p>
        </div>
    </div>
    
    <div class="chat-input-container">
        <input type="text" id="chatMessageInput" placeholder="Type your message..." class="chat-input">
        <button id="sendMessageBtn" class="chat-send-btn">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>
            <!-- Profile Page Content -->
            <div class="page-content" id="profilePage" style="display: none;">
                <div class="profile-header" style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
                    <div class="avatar-large" style="width: 80px; height: 80px; border-radius: 50%; background-color: var(--gray-100); display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 2rem; font-weight: 600; color: white;" id="profileAvatar">
                        <span id="profileAvatarInitial">A</span>
                        <img id="profileAvatarImage" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div>
                        <h2 style="font-size: 1.5rem; color: var(--gray-600); margin-bottom: 0.3rem;" id="profileUserName">User Name</h2>
                        <p style="display: flex; align-items: center; gap: 0.3rem; color: var(--gray-400); font-size: 0.9rem;">
                            <i class="fas fa-user-tag"></i>
                            <span id="profileUserRole">Donor</span>
                        </p>
                        <p style="display: flex; align-items: center; gap: 0.3rem; color: var(--gray-400); font-size: 0.9rem; margin-top: 0.3rem;" id="profileVerificationStatus">
                            <i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i>
                            <span>Unverified</span>
                        </p>
                    </div>
                </div>

                <div class="verification-banner" id="profileVerificationBanner" style="display: none;">
                    <div class="verification-content">
                        <div class="verification-icon">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="verification-text">
                            <h3>Account Verification Required</h3>
                            <p>Verify your account to create listings and request food</p>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="showVerificationModal()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                        Start Verification
                    </button>
                </div>

                <div class="profile-details" style="margin-bottom: 2rem;">
                    <div style="margin-bottom: 1rem;">
                        <h3 style="font-size: 1rem; color: var(--gray-500); margin-bottom: 0.3rem;">Bio</h3>
                        <p style="color: var(--gray-600); font-size: 0.9rem; line-height: 1.5;" id="profileBioText">No bio provided</p>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <h3 style="font-size: 1rem; color: var(--gray-500); margin-bottom: 0.3rem;">Location</h3>
                        <p style="color: var(--gray-600); font-size: 0.9rem;" id="profileLocationText">No location provided</p>
                    </div>
                    <div id="profileOrganizationContainer" style="margin-bottom: 1rem; display: none;">
                        <h3 style="font-size: 1rem; color: var(--gray-500); margin-bottom: 0.3rem;">Organization</h3>
                        <p style="color: var(--gray-600); font-size: 0.9rem;" id="profileOrganizationText"></p>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 2rem;">
                    <h2>Account Settings</h2>
                </div>

                <div class="settings-list" style="background-color: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm); margin-bottom: 2rem;">
                    <a href="#" class="setting-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; text-decoration: none; color: var(--gray-600); border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-user" style="color: var(--gray-400);"></i>
                            <span>Personal Information</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--gray-400);"></i>
                    </a>
                    <a href="#" class="setting-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; text-decoration: none; color: var(--gray-600); border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-bell" style="color: var(--gray-400);"></i>
                            <span>Notifications</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--gray-400);"></i>
                    </a>
                    <a href="#" class="setting-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; text-decoration: none; color: var(--gray-600); border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-lock" style="color: var(--gray-400);"></i>
                            <span>Change Password</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--gray-400);"></i>
                    </a>
                </div>

                <div class="section-title">
                    <h2>About</h2>
                </div>

                <div class="settings-list" style="background-color: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-sm); margin-bottom: 2rem;">
                    <a href="#" class="setting-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; text-decoration: none; color: var(--gray-600); border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-file-alt" style="color: var(--gray-400);"></i>
                            <span>Terms of Service</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--gray-400);"></i>
                    </a>
                    <a href="#" class="setting-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; text-decoration: none; color: var(--gray-600); border-bottom: 1px solid var(--gray-200);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-shield-alt" style="color: var(--gray-400);"></i>
                            <span>Privacy Policy</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--gray-400);"></i>
                    </a>
                    <a href="#" class="setting-item" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; text-decoration: none; color: var(--gray-600);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <i class="fas fa-envelope" style="color: var(--gray-400);"></i>
                            <span>Contact Us</span>
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--gray-400);"></i>
                    </a>
                </div>

                <button class="btn btn-primary" onclick="logout()" style="width: 100%; background-color: white; color: var(--gray-600); border: 1px solid var(--gray-200); margin-bottom: 1rem;">
                    <i class="fas fa-sign-out-alt" style="margin-right: 8px;"></i>
                    <span>Logout</span>
                </button>

                <button class="btn btn-secondary" onclick="showDeleteAccountModal()" style="width: 100%; background-color: white; color: #ef4444; border: 1px solid var(--gray-200);">
                    <i class="fas fa-trash-alt" style="margin-right: 8px;"></i>
                    <span>Delete Account</span>
                </button>
            </div>
            
            <!-- Notifications Page Content -->
<div class="page-content" id="notificationsPage" style="display: none;">
    <div class="section-title">
        <h2>Notifications</h2>
        <button class="btn btn-secondary" onclick="markAllAsRead()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
            Mark All as Read
        </button>
    </div>
    
    <div id="notificationsList">
        <!-- Notifications will be rendered here -->
    </div>
</div>

<!-- Notifications Modal -->
<div class="modal-overlay" id="notificationsModal">
    <div class="modal" style="max-width: 500px;">
        <div class="modal-header">
            <h2 class="modal-title">Notifications</h2>
            <button class="modal-close" onclick="hideModal('notificationsModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="notificationsModalContent">
                <div class="page-loading">
                    <div class="page-loading-spinner"></div>
                    <div class="page-loading-text">Loading notifications...</div>
                </div>
            </div>
        </div>
    </div>
</div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <a href="#" class="nav-item active" onclick="showPage('home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('listings')">
                <i class="fas fa-utensils"></i>
                <span>Listings</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('messages')">
                <i class="fas fa-comments"></i>
                <span>Messages</span>
                <span class="badge" id="bottomNavMessageBadge" style="display: none;">3</span>
            </a>
            <a href="#" class="nav-item" onclick="showPage('profile')">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </a>
        </div>

        <!-- Floating Action Button for Donors -->
        <div class="fab" id="fabButton" onclick="showCreateListingModal()">
            <i class="fas fa-plus"></i>
        </div>
    </div>

    <!-- Create Listing Modal -->
    <div class="modal-overlay" id="createListingModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create New Listing</h2>
                <button class="modal-close" onclick="hideModal('createListingModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Food Image</label>
                    <div class="image-upload">
                        <div class="image-preview" id="listingImagePreview">
                            <i class="fas fa-camera"></i>
                        </div>
                        <input type="file" id="listingImageUpload" accept="image/*" style="display: none;">
                        <label for="listingImageUpload" class="upload-label">Upload Photo</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="listingTitle">Food Title</label>
                    <div class="input-field">
                        <i class="fas fa-pen"></i>
                        <input type="text" id="listingTitle" placeholder="e.g., Fresh Baked Bread">
                    </div>
                    <div class="error-message" id="listingTitleError">Please enter a title</div>
                </div>

                <div class="form-group">
                    <label for="listingDescription">Description</label>
                    <div class="input-field" style="align-items: flex-start; padding-top: 1rem;">
                        <i class="fas fa-align-left" style="margin-top: 1rem;"></i>
                        <textarea id="listingDescription" placeholder="Describe the food item (quantity, condition, etc.)" style="width: 100%; border: none; resize: none; min-height: 100px; padding: 1rem 0; font-size: 1rem; font-family: var(--font-main);"></textarea>
                    </div>
                    <div class="error-message" id="listingDescriptionError">Please enter a description</div>
                </div>

                <div class="form-group">
                    <label for="listingExpiry">Expiry Date</label>
                    <div class="input-field">
                        <i class="fas fa-calendar-day"></i>
                        <input type="date" id="listingExpiry">
                    </div>
                    <div class="error-message" id="listingExpiryError">Please select an expiry date</div>
                </div>

                <div class="form-group">
                    <label for="listingAddress">Pickup Address</label>
                    <div class="input-field">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="listingAddress" placeholder="Enter pickup address">
                    </div>
                    <div class="error-message" id="listingAddressError">Please enter an address</div>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <div class="category-select">
                        <div class="category-option" data-category="bakery" onclick="selectCategory(this, 'bakery')">
                            <i class="fas fa-bread-slice"></i>
                            <h4>Bakery</h4>
                        </div>
                        <div class="category-option" data-category="produce" onclick="selectCategory(this, 'produce')">
                            <i class="fas fa-apple-alt"></i>
                            <h4>Produce</h4>
                        </div>
                        <div class="category-option" data-category="dairy" onclick="selectCategory(this, 'dairy')">
                            <i class="fas fa-cheese"></i>
                            <h4>Dairy</h4>
                        </div>
                        <div class="category-option" data-category="pantry" onclick="selectCategory(this, 'pantry')">
                            <i class="fas fa-box-open"></i>
                            <h4>Pantry</h4>
                        </div>
                        <div class="category-option" data-category="prepared" onclick="selectCategory(this, 'prepared')">
                            <i class="fas fa-utensils"></i>
                            <h4>Prepared</h4>
                        </div>
                        <div class="category-option" data-category="other" onclick="selectCategory(this, 'other')">
                            <i class="fas fa-ellipsis-h"></i>
                            <h4>Other</h4>
                        </div>
                    </div>
                    <input type="hidden" id="food-category">
                    <div class="error-message" id="food-category-error"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('createListingModal')">Cancel</button>
                <button class="btn btn-primary" onclick="createListing()" id="createListingBtn">Create Listing</button>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="delete-account-modal" id="deleteAccountModal">
        <div class="delete-account-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h2 class="delete-account-title">Delete Your Account?</h2>
        <p class="delete-account-text">This action cannot be undone. All your data will be permanently removed from our systems.</p>
        
        <div class="form-group" style="margin-bottom: 2rem;">
            <label for="deletePassword">Enter your password to confirm</label>
            <div class="input-field">
                <i class="fas fa-lock"></i>
                <input type="password" id="deletePassword" placeholder="Your password">
            </div>
            <div class="error-message" id="deletePasswordError">Incorrect password</div>
        </div>

        <div class="delete-account-actions">
            <button class="btn btn-secondary" onclick="hideModal('deleteAccountModal')">Cancel</button>
            <button class="btn btn-primary" style="background-color: #ef4444;" onclick="deleteAccount()">Delete Account</button>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyANq9cJd9tpTnbfMIY8ImsxWFWsn9prXbI",
            authDomain: "mealswap-15d15.firebaseapp.com",
            projectId: "mealswap-15d15",
            storageBucket: "mealswap-15d15.appspot.com",
            messagingSenderId: "534579466781",
            appId: "1:534579466781:web:b9b42fa8272c0da1f1ecf4",
            measurementId: "G-BEBCMKFVSY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        // ImageBB API Key
        const IMAGEBB_API_KEY = '1dbc58387d100c16d5e7012f6fd434c1';

        // Global variables
        let currentUser = null;
        let userData = null;
        let selectedRole = 'donor';
        let selectedAvatarType = 'default';
        let selectedAvatar = 'A';
        let selectedAvatarColor = 'color-1';
        let selectedCategory = 'bakery';
        let currentPage = 'home';
        let userListings = [];
        let recentRequests = [];
        let messages = [];
        let notifications = [];
        let listingsLoading = true;
        let messagesLoading = true;
        
        let currentChatUserId = null;
        let currentChannelId = null;
        let currentChatUnsubscribe = null;
        

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const onboardingContainer = document.getElementById('onboardingContainer');
        const onboardingSlides = document.getElementById('onboardingSlides');
        const skipBtn = document.getElementById('skipBtn');
        const nextBtn1 = document.getElementById('nextBtn1');
        const nextBtn2 = document.getElementById('nextBtn2');
        const getStartedBtn = document.getElementById('getStartedBtn');
        const authScreen = document.getElementById('authScreen');
        const appContainer = document.getElementById('appContainer');
        const profileSetup = document.getElementById('profileSetup');
        const defaultAvatarBtn = document.getElementById('defaultAvatarBtn');
        const customAvatarBtn = document.getElementById('customAvatarBtn');
        const defaultAvatarOptions = document.getElementById('defaultAvatarOptions');
        const customAvatarUpload = document.getElementById('customAvatarUpload');
        const avatarUpload = document.getElementById('avatarUpload');
        const avatarPreview = document.getElementById('avatarPreview');
        const completeProfileBtn = document.getElementById('completeProfileBtn');
        const sidebar = document.getElementById('sidebar');
        const mobileHeaderTitle = document.getElementById('mobileHeaderTitle');
        const mainContent = document.getElementById('mainContent');
        const homePage = document.getElementById('homePage');
        const listingsPage = document.getElementById('listingsPage');
        const messagesPage = document.getElementById('messagesPage');
        const profilePage = document.getElementById('profilePage');
        const greeting = document.getElementById('greeting');
        const welcomeUserName = document.getElementById('welcomeUserName');
        const verificationBanner = document.getElementById('verificationBanner');
        const listingsContent = document.getElementById('listingsContent');
        const messagesContent = document.getElementById('messagesContent');
        const sidebarAvatar = document.getElementById('sidebarAvatar');
        const sidebarAvatarInitial = document.getElementById('sidebarAvatarInitial');
        const sidebarAvatarImage = document.getElementById('sidebarAvatarImage');
        const sidebarUserName = document.getElementById('sidebarUserName');
        const sidebarUserStatus = document.getElementById('sidebarUserStatus');
        const verifiedIcon = document.getElementById('verifiedIcon');
        const unverifiedIcon = document.getElementById('unverifiedIcon');
        const statusText = document.getElementById('statusText');
        const mobileHeaderAvatar = document.getElementById('mobileHeaderAvatar');
        const mobileAvatarInitial = document.getElementById('mobileAvatarInitial');
        const mobileAvatarImage = document.getElementById('mobileAvatarImage');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileAvatarInitial = document.getElementById('profileAvatarInitial');
        const profileAvatarImage = document.getElementById('profileAvatarImage');
        const profileUserName = document.getElementById('profileUserName');
        const profileUserRole = document.getElementById('profileUserRole');
        const profileVerificationStatus = document.getElementById('profileVerificationStatus');
        const profileVerificationBanner = document.getElementById('profileVerificationBanner');
        const profileBioText = document.getElementById('profileBioText');
        const profileLocationText = document.getElementById('profileLocationText');
        const profileOrganizationText = document.getElementById('profileOrganizationText');
        const profileOrganizationContainer = document.getElementById('profileOrganizationContainer');
        const listingsNavItem = document.getElementById('listingsNavItem');
        const fabButton = document.getElementById('fabButton');
        const toastContainer = document.getElementById('toastContainer');
        const createListingModal = document.getElementById('createListingModal');
        const listingImagePreview = document.getElementById('listingImagePreview');
        const listingImageUpload = document.getElementById('listingImageUpload');
        const createListingBtn = document.getElementById('createListingBtn');
        const verificationModal = document.getElementById('verificationModal');
        const submitVerificationBtn = document.getElementById('submitVerificationBtn');
        const deleteAccountModal = document.getElementById('deleteAccountModal');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user has completed onboarding
            const hasCompletedOnboarding = localStorage.getItem('hasCompletedOnboarding') === 'true';
            
            if (!hasCompletedOnboarding) {
                showOnboarding();
            } else {
                checkAuthState();
            }

            // Set up event listeners
            setupEventListeners();
        });
        
        // Initialize the app
function initApp() {
    setupEventListeners();
    checkOnboardingStatus();
}

// Check if user has completed onboarding
function checkOnboardingStatus() {
    const onboardingCompleted = localStorage.getItem('hasCompletedOnboarding') === 'true';
    
    if (!onboardingCompleted) {
        showOnboarding();
    } else {
        checkAuthState();
    }
}

function setupSearchAndFilters() {
    // Search functionality
    const searchInput = document.getElementById('listingSearch');
    if (searchInput) {
        searchInput.addEventListener('input', filterListings);
    }
    
    // Category filter functionality
    const categoryFilters = document.querySelectorAll('.category-filter');
    categoryFilters.forEach(filter => {
        filter.addEventListener('click', () => {
            categoryFilters.forEach(f => f.classList.remove('active'));
            filter.classList.add('active');
            filterListings();
        });
    });
}

        function setupEventListeners() {
            // Onboarding navigation
            skipBtn.addEventListener('click', skipOnboarding);
            nextBtn1.addEventListener('click', () => navigateOnboarding(1));
            nextBtn2.addEventListener('click', () => navigateOnboarding(2));
            prevBtn2.addEventListener('click', () => navigateOnboarding(0));
            prevBtn3.addEventListener('click', () => navigateOnboarding(1));
            getStartedBtn.addEventListener('click', completeOnboarding);

            // Profile setup
            defaultAvatarBtn.addEventListener('click', showDefaultAvatarOptions);
            customAvatarBtn.addEventListener('click', showCustomAvatarUpload);
            avatarUpload.addEventListener('change', handleAvatarUpload);
            completeProfileBtn.addEventListener('click', completeProfileSetup);

            // Image uploads
            listingImageUpload.addEventListener('change', handleListingImageUpload);
            
            // Add this to your setupEventListeners function
            document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
            document.getElementById('chatMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function showOnboarding() {
    loadingScreen.style.display = 'none';
    onboardingContainer.style.display = 'block';
    
    // Reset to first slide
    onboardingSlides.style.transform = 'translateX(0)';
    
    // Reset progress dots
    const dots = document.querySelectorAll('.progress-dot');
    dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === 0);
    });
    
    // Reset button visibility
    document.getElementById('nextBtn1').style.display = 'flex';
    document.getElementById('nextBtn2').style.display = 'none';
    document.getElementById('getStartedBtn').style.display = 'none';
}

function navigateOnboarding(slideIndex) {
    onboardingSlides.style.transform = `translateX(-${slideIndex * 100}%)`;
    
    // Update progress dots
    const dots = document.querySelectorAll('.progress-dot');
    dots.forEach(dot => dot.classList.remove('active'));
    dots[slideIndex].classList.add('active');
}

        function skipOnboarding() {
            completeOnboarding();
        }

        function completeOnboarding() {
            localStorage.setItem('hasCompletedOnboarding', 'true');
            onboardingContainer.style.display = 'none';
            checkAuthState();
        }

        function checkAuthState() {
            loadingScreen.style.display = 'flex';
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    await fetchUserData();
                    
                    // Check if profile is complete
                    if (!userData.profileComplete) {
                        showProfileSetup();
                    } else {
                        showApp();
                    }
                } else {
                    // No user is signed in
                    showAuthScreen();
                }
            });
        }

        function showAuthScreen() {
            loadingScreen.style.display = 'none';
            authScreen.style.display = 'flex';
            appContainer.style.display = 'none';
            profileSetup.style.display = 'none';
        }

        function showProfileSetup() {
            loadingScreen.style.display = 'none';
            authScreen.style.display = 'none';
            appContainer.style.display = 'none';
            profileSetup.style.display = 'flex';
        }

  async function showApp() {
    loadingScreen.style.display = 'none';
    authScreen.style.display = 'none';
    appContainer.style.display = 'block';
    profileSetup.style.display = 'none';
    
    // Update UI based on user data
    updateUserInterface();
    
    // Load initial data FIRST
    await loadInitialData();
    
    // THEN set up real-time listeners
    setupRealtimeListeners();
    
    // Show the home page by default
    showPage('home');
}

        async function fetchUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    userData = userDoc.data();
                } else {
                    // Create new user document if it doesn't exist
                    userData = {
                        name: currentUser.displayName || '',
                        email: currentUser.email,
                        role: selectedRole,
                        profileComplete: false,
                        verified: false,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        avatarType: 'default',
                        avatarInitial: 'A',
                        avatarColor: 'color-1',
                        bio: '',
                        location: '',
                        organization: '',
                        stats: {
                            donations: 0,
                            peopleHelped: 0,
                            rating: 0,
                            activeListings: 0
                        }
                    };
                    
                    await db.collection('users').doc(currentUser.uid).set(userData);
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                showToast('Error loading user data', 'error');
            }
        }

  async function loadInitialData() {
    try {
        // Load user listings
        if (userData.role === 'donor') {
            const listingsSnapshot = await db.collection('listings')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get();
            
            userListings = [];
            listingsSnapshot.forEach(doc => {
                userListings.push({ id: doc.id, ...doc.data() });
            });
            
            // Load recent requests
            const requestsSnapshot = await db.collection('requests')
                .where('listingOwnerId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .limit(3)
                .get();
            
            recentRequests = [];
            requestsSnapshot.forEach(doc => {
                recentRequests.push({ id: doc.id, ...doc.data() });
            });
        } else {
            // Load all available listings for receivers
            const listingsSnapshot = await db.collection('listings')
                .where('status', '==', 'available')
                .orderBy('createdAt', 'desc')
                .get();
            
            userListings = [];
            listingsSnapshot.forEach(doc => {
                userListings.push({ id: doc.id, ...doc.data() });
            });
        }
        
        // Load messages
        const messagesSnapshot = await db.collection('messages')
            .where('participants', 'array-contains', currentUser.uid)
            .orderBy('lastUpdated', 'desc')
            .get();
        
        messages = [];
        messagesSnapshot.forEach(doc => {
            messages.push({ id: doc.id, ...doc.data() });
        });
        
        // Load notifications
        const notificationsSnapshot = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        notifications = [];
        notificationsSnapshot.forEach(doc => {
            notifications.push({ id: doc.id, ...doc.data() });
        });
        
        // Update UI with loaded data
        renderUserListings();
        renderMessages();
        renderNotificationsList(notifications);
        await loadNotifications();
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        showToast('Error loading data', 'error');
    }
}

// Initialize notifications
async function loadNotifications() {
    try {
        const snapshot = await db.collection('notifications')
            .where('userId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .get();
        
        notifications = [];
        snapshot.forEach(doc => {
            notifications.push({ id: doc.id, ...doc.data() });
        });
        
        renderNotificationsList();
        updateNotificationBadges();
        
    } catch (error) {
        console.error('Error loading notifications:', error);
        showToast('Error loading notifications', 'error');
    }
}

        function updateUserInterface() {
            // Update greeting based on time of day
            updateGreeting();
            
            // Update user name
            welcomeUserName.textContent = `Welcome back, ${userData.name || 'User'}!`;
            sidebarUserName.textContent = userData.name || 'User';
            profileUserName.textContent = userData.name || 'User';
            
            // Update user role
            profileUserRole.textContent = userData.role === 'donor' ? 'Donor' : 'Receiver';
            
            // Update verification status
            updateVerificationStatus();
            
            // Update avatar
            updateAvatar();
            
            // Update profile details
            updateProfileDetails();
            
            // Update role-specific UI
            if (userData.role === 'donor') {
                listingsNavItem.innerHTML = '<i class="fas fa-utensils"></i><span>My Listings</span>';
            } else {
                listingsNavItem.innerHTML = '<i class="fas fa-search"></i><span>Browse Listings</span>';
            }
            
            if (userData.role === 'donor' && currentPage === 'listings') {
                fabButton.style.display = 'flex';
            } else {
                fabButton.style.display = 'none';
            }
        }

        function updateGreeting() {
            const hour = new Date().getHours();
            let greetingText = 'Hello';
            
            if (hour < 12) {
                greetingText = 'Good Morning';
            } else if (hour < 18) {
                greetingText = 'Good Afternoon';
            } else {
                greetingText = 'Good Evening';
            }
            
            greeting.textContent = greetingText;
        }

        function updateVerificationStatus() {
            if (userData.verified) {
                // Verified user
                verifiedIcon.style.display = 'inline-block';
                unverifiedIcon.style.display = 'none';
                statusText.textContent = 'Verified';
                verificationBanner.style.display = 'none';
                profileVerificationBanner.style.display = 'none';
                profileVerificationStatus.innerHTML = '<i class="fas fa-check-circle" style="color: var(--primary-green);"></i><span>Verified</span>';
            } else {
                // Unverified user
                verifiedIcon.style.display = 'none';
                unverifiedIcon.style.display = 'inline-block';
                statusText.textContent = 'Unverified';
                verificationBanner.style.display = 'flex';
                profileVerificationBanner.style.display = 'flex';
                profileVerificationStatus.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #f59e0b;"></i><span>Unverified</span>';
            }
        }

        function updateAvatar() {
            if (userData.avatarType === 'default') {
                // Default avatar with initial and color
                sidebarAvatarInitial.textContent = userData.avatarInitial;
                sidebarAvatarInitial.style.display = 'flex';
                sidebarAvatarImage.style.display = 'none';
                sidebarAvatar.style.backgroundColor = '';
                sidebarAvatar.classList.add(userData.avatarColor);
                
                mobileAvatarInitial.textContent = userData.avatarInitial;
                mobileAvatarInitial.style.display = 'flex';
                mobileAvatarImage.style.display = 'none';
                mobileHeaderAvatar.style.backgroundColor = '';
                mobileHeaderAvatar.classList.add(userData.avatarColor);
                
                profileAvatarInitial.textContent = userData.avatarInitial;
                profileAvatarInitial.style.display = 'flex';
                profileAvatarImage.style.display = 'none';
                profileAvatar.style.backgroundColor = '';
                profileAvatar.classList.add(userData.avatarColor);
            } else {
                // Custom avatar image
                sidebarAvatarInitial.style.display = 'none';
                sidebarAvatarImage.style.display = 'block';
                sidebarAvatarImage.src = userData.avatarUrl;
                sidebarAvatar.style.backgroundColor = '';
                sidebarAvatar.classList.remove('color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6');
                
                mobileAvatarInitial.style.display = 'none';
                mobileAvatarImage.style.display = 'block';
                mobileAvatarImage.src = userData.avatarUrl;
                mobileHeaderAvatar.style.backgroundColor = '';
                mobileHeaderAvatar.classList.remove('color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6');
                
                profileAvatarInitial.style.display = 'none';
                profileAvatarImage.style.display = 'block';
                profileAvatarImage.src = userData.avatarUrl;
                profileAvatar.style.backgroundColor = '';
                profileAvatar.classList.remove('color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6');
            }
        }

        function updateProfileDetails() {
            // Update bio
            if (userData.bio && userData.bio.trim() !== '') {
                profileBioText.textContent = userData.bio;
            } else {
                profileBioText.textContent = 'No bio provided';
            }
            
            // Update location
            if (userData.location && userData.location.trim() !== '') {
                profileLocationText.textContent = userData.location;
            } else {
                profileLocationText.textContent = 'No location provided';
            }
            
            // Update organization (only for donors)
            if (userData.role === 'donor' && userData.organization && userData.organization.trim() !== '') {
                profileOrganizationContainer.style.display = 'block';
                profileOrganizationText.textContent = userData.organization;
            } else {
                profileOrganizationContainer.style.display = 'none';
            }
            
            // Update stats
            document.getElementById('totalDonations').textContent = userData.stats?.donations || 0;
            document.getElementById('peopleHelped').textContent = userData.stats?.peopleHelped || 0;
            document.getElementById('userRating').textContent = userData.stats?.rating || 0;
            document.getElementById('activeListings').textContent = userData.stats?.activeListings || 0;
        }

  function setupRealtimeListeners() {
    // Listen for user data changes
    const userListener = db.collection('users').doc(currentUser.uid).onSnapshot((doc) => {
        if (doc.exists) {
            userData = doc.data();
            updateUserInterface();
        }
    });
    
        // Listen for activity changes
    db.collection('activities')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .limit(5)
        .onSnapshot(snapshot => {
            recentActivities = [];
            snapshot.forEach(doc => {
                recentActivities.push({ id: doc.id, ...doc.data() });
            });
            
        });
    
// Listen for notifications
        return db.collection('notifications')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .onSnapshot(snapshot => {
            notifications = [];
            snapshot.forEach(doc => {
                notifications.push({ id: doc.id, ...doc.data() });
            });
            
            // Update the notifications list
            renderNotificationsList(notifications);
            
            // Update badge counts
            const unreadCount = notifications.filter(n => !n.read).length;
            updateNotificationBadges(unreadCount);
        });
        
         // Notification listener
    const notificationsListener = db.collection('notifications')
        .where('userId', '==', currentUser.uid)
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
            notifications = [];
            snapshot.forEach(doc => {
                notifications.push({ id: doc.id, ...doc.data() });
            });
            renderNotificationsList();
            updateNotificationBadges();
        });
    
        
    // Listen for listing changes (for donors)
    let listingsListener;
    if (userData.role === 'donor') {
        listingsListener = db.collection('listings')
            .where('userId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .onSnapshot((snapshot) => {
                const listings = [];
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified') {
                        listings.push({ id: change.doc.id, ...change.doc.data() });
                    }
                });
                
                // Merge with existing listings, avoiding duplicates
                const existingIds = new Set(userListings.map(l => l.id));
                const newListings = listings.filter(l => !existingIds.has(l.id));
                userListings = [...userListings, ...newListings];
                
                renderUserListings();
                updateStats();
            });
        
        // Listen for requests (for donors)
        db.collection('requests')
            .where('listingOwnerId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .limit(3)
            .onSnapshot((snapshot) => {
                recentRequests = [];
                snapshot.forEach(doc => {
                    recentRequests.push({ id: doc.id, ...doc.data() });
                });
                renderRecentRequests();
            });
    } else {
        // Listen for all available listings (for receivers)
        listingsListener = db.collection('listings')
            .where('status', '==', 'available')
            .orderBy('createdAt', 'desc')
            .onSnapshot((snapshot) => {
                const listings = [];
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' || change.type === 'modified') {
                        listings.push({ id: change.doc.id, ...change.doc.data() });
                    }
                });
                
                // Merge with existing listings, avoiding duplicates
                const existingIds = new Set(userListings.map(l => l.id));
                const newListings = listings.filter(l => !existingIds.has(l.id));
                userListings = [...userListings, ...newListings];
                
                renderUserListings();
            });
    }
    
    // Listen for messages
    db.collection('messages')
        .where('participants', 'array-contains', currentUser.uid)
        .orderBy('lastUpdated', 'desc')
        .onSnapshot((snapshot) => {
            messages = [];
            snapshot.forEach(doc => {
                messages.push({ id: doc.id, ...doc.data() });
            });
            renderMessages();
            
            // Update message badges
            const unreadCount = messages.reduce((count, message) => {
                return count + (message[`${currentUser.uid}_unread`] || 0);
            }, 0);
            
            if (unreadCount > 0) {
                document.getElementById('messageBadge').textContent = unreadCount;
                document.getElementById('messageBadge').style.display = 'flex';
                document.getElementById('bottomNavMessageBadge').textContent = unreadCount;
                document.getElementById('bottomNavMessageBadge').style.display = 'flex';
            } else {
                document.getElementById('messageBadge').style.display = 'none';
                document.getElementById('bottomNavMessageBadge').style.display = 'none';
            }
        });
        
     const unsubscribeNotifications = db.collection('notifications')
        .where('userId', '==', currentUser.uid)
        .orderBy('createdAt', 'desc')
        .onSnapshot(snapshot => {
            notifications = [];
            snapshot.forEach(doc => {
                notifications.push({ id: doc.id, ...doc.data() });
            });
            renderNotificationsList();
            updateNotificationBadges();
        });
       
    
    // Store the listeners for cleanup
    return {
        userListener,
        listingsListener,
        notificationsListener,
        unsubscribeNotifications
    };
}

  function updateNotificationBadges(count) {
    const badges = [
        document.getElementById('notificationBadge'),
        document.getElementById('mobileNotificationBadge')
    ];
    
    badges.forEach(badge => {
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    });
}
  
        function updateStats() {
            // Update active listings count
            const activeListingsCount = userListings.filter(listing => 
                listing.status === 'available').length;
            
            document.getElementById('activeListings').textContent = activeListingsCount;
            
            // Update Firestore with new stats
            db.collection('users').doc(currentUser.uid).update({
                'stats.activeListings': activeListingsCount,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

function renderUserListings() {
    listingsLoading = false;
    listingsContent.innerHTML = '';
    
    if (userListings.length === 0) {
        listingsContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-utensils"></i>
                <h3>No Listings Found</h3>
                <p>${userData.role === 'donor' ? 'You haven\'t created any listings yet' : 'No available listings in your area'}</p>
            </div>
        `;
        return;
    }
    
    const listingsContainer = document.createElement('div');
    listingsContainer.className = 'food-list';
    
    userListings.forEach(listing => {
        const expiryDate = listing.expiryDate?.toDate() || new Date();
        const today = new Date();
        const timeDiff = expiryDate.getTime() - today.getTime();
        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
        
        // Check if current user has already requested this listing
        const userRequest = listing.requests?.find(r => r.receiverId === currentUser.uid);
        
        const listingElement = document.createElement('div');
        listingElement.className = 'food-card';
        listingElement.innerHTML = `
            <img src="${listing.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                 alt="${listing.title}" class="listing-image" onerror="this.src='https://via.placeholder.com/300x200?text=Image+Error'">
            <div class="listing-details">
                <div class="listing-header">
                    <h3 class="listing-title">${listing.title}</h3>
                    <span class="listing-category">${formatCategory(listing.category)}</span>
                </div>
                <div class="listing-meta">
                    <span><i class="fas fa-map-marker-alt"></i> ${listing.address || 'No address'}</span>
                    <span class="${daysDiff < 0 ? 'expired' : daysDiff < 3 ? 'soon' : ''}">
                        <i class="fas fa-clock"></i> 
                        ${daysDiff < 0 ? 'Expired' : `Expires in ${daysDiff} day${daysDiff !== 1 ? 's' : ''}`}
                    </span>
                </div>
                <p class="listing-description">${listing.description || 'No description provided'}</p>
                <div class="listing-footer">
                    <div class="listing-donor">
                        <div class="donor-avatar" style="background-color: ${getRandomColor()}">
                            ${getInitials(listing.userName)}
                        </div>
                        <span class="donor-name">${listing.userName}</span>
                    </div>
                    ${userData.role === 'receiver' ? `
                        <div class="listing-actions">
                            ${userRequest ? 
                                (userRequest.status === 'accepted' ? `
                                    <div class="action-icon" onclick="startChat('${listing.userId}', '${userRequest.messageThreadId || ''}')">
                                        <i class="fas fa-comment"></i>
                                        <span class="tooltip">Chat</span>
                                    </div>
                                ` : userRequest.status === 'rejected' ? `
                                    <div class="action-icon disabled" title="Request Rejected">
                                        <i class="fas fa-times"></i>
                                        <span class="tooltip">Rejected</span>
                                    </div>
                                ` : `
                                    <div class="action-icon disabled" title="Pending Approval">
                                        <i class="fas fa-clock"></i>
                                        <span class="tooltip">Pending</span>
                                    </div>
                                `)
                                : `
                                <div class="action-icon" onclick="createFoodRequest('${listing.id}')" title="Request Food">
                                    <i class="fas fa-hand-holding-heart"></i>
                                    <span class="tooltip"></span>
                                </div>
                            `}
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
        
        // Add expired class to entire card if expired
        if (daysDiff < 0) {
            listingElement.classList.add('expired');
        }
        
        listingsContainer.appendChild(listingElement);
    });
    
    listingsContent.appendChild(listingsContainer);
}

function getRandomColor() {
    const colors = ['#3b82f6', '#ef4444', '#f59e0b', '#8b5cf6', '#10b981', '#ec4899'];
    return colors[Math.floor(Math.random() * colors.length)];
}

function formatCategory(category) {
    const categories = {
        'bakery': 'Bakery',
        'produce': 'Produce',
        'dairy': 'Dairy',
        'pantry': 'Pantry',
        'prepared': 'Prepared',
        'other': 'Other'
    };
    return categories[category] || 'Other';
}

// Helper function to get initials from name
function getInitials(name) {
    if (!name) return '';
    const parts = name.split(' ');
    let initials = parts[0].charAt(0).toUpperCase();
    if (parts.length > 1) {
        initials += parts[parts.length - 1].charAt(0).toUpperCase();
    }
    return initials;
}

// Filter listings based on search and category
function filterListings() {
    const searchTerm = document.getElementById('listingSearch').value.toLowerCase();
    const activeCategory = document.querySelector('.category-filter.active').getAttribute('data-category');
    
    const listings = document.querySelectorAll('.food-card');
    listings.forEach(listing => {
        const title = listing.querySelector('.listing-title').textContent.toLowerCase();
        const description = listing.querySelector('.listing-description').textContent.toLowerCase();
        const category = listing.querySelector('.listing-category').textContent.toLowerCase();
        
        const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
        const matchesCategory = activeCategory === 'all' || category.includes(activeCategory);
        
        if (matchesSearch && matchesCategory) {
            listing.style.display = 'flex';
        } else {
            listing.style.display = 'none';
        }
    });
}

function renderNotifications(notifications, containerId = 'notificationsContent') {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';

    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell"></i>
                <h3>No Notifications</h3>
                <p>Your notifications will appear here</p>
            </div>
        `;
        return;
    }

    notifications.forEach(notification => {
        const notificationElement = document.createElement('div');
        notificationElement.className = 'notification-item';
        
        let icon, message, color, actions = '';
        
        switch(notification.type) {
            case 'request':
                icon = 'fa-hand-holding-heart';
                message = `${notification.receiverName} requested your "${notification.listingTitle}" listing`;
                color = 'var(--primary-green)';
                if (notification.status === 'pending') {
                    actions = `
                        <div class="notification-actions">
                            <button class="btn btn-primary" onclick="handleNotificationAction('${notification.id}', 'accept')">
                                Accept
                            </button>
                            <button class="btn btn-secondary" onclick="handleNotificationAction('${notification.id}', 'reject')">
                                Reject
                            </button>
                        </div>
                    `;
                }
                break;
            case 'request_accepted':
                icon = 'fa-check-circle';
                message = `${notification.donorName} accepted your request for "${notification.listingTitle}"`;
                color = 'var(--primary-green)';
                break;
            case 'request_rejected':
                icon = 'fa-times-circle';
                message = `${notification.donorName} declined your request for "${notification.listingTitle}"`;
                color = '#ef4444';
                break;
            default:
                icon = 'fa-bell';
                message = notification.message || 'New notification';
                color = 'var(--gray-400)';
        }
        
        notificationElement.innerHTML = `
            <div class="notification-content">
                <i class="fas ${icon}" style="color: ${color};"></i>
                <div class="notification-text">
                    <p>${message}</p>
                    <small class="notification-time">
                        <i class="fas fa-clock"></i> ${formatTime(notification.createdAt.toDate())}
                    </small>
                    ${actions}
                </div>
                ${!notification.read ? '<div class="notification-badge"></div>' : ''}
            </div>
        `;
        
        container.appendChild(notificationElement);
    });
}

        function renderRecentRequests() {
            if (recentRequests.length === 0) {
                document.getElementById('recentActivity').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-utensils"></i>
                        <h3>No Recent Requests</h3>
                        <p>When you receive requests for your listings, they'll appear here.</p>
                    </div>
                `;
                return;
            }
            
            const recentActivity = document.getElementById('recentActivity');
            recentActivity.innerHTML = '';
            
            recentRequests.forEach(request => {
                const requestElement = document.createElement('div');
                requestElement.className = 'food-card';
                requestElement.innerHTML = `
                    <div class="food-image">
                        <img src="${request.listingImageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${request.listingTitle}">
                        <span class="food-badge">Request</span>
                    </div>
                    <div class="food-details">
                        <h3 class="food-title">${request.listingTitle}</h3>
                        <p class="food-description">Request from ${request.receiverName}</p>
                        <div class="food-meta">
                            <span>
                                <i class="fas fa-calendar"></i>
                                ${formatDate(request.createdAt.toDate())}
                            </span>
                            <span>
                                <i class="fas fa-comment"></i>
                                ${request.message || 'No message'}
                            </span>
                        </div>
                    </div>
                `;
                
                requestElement.addEventListener('click', () => viewRequestDetails(request.id));
                recentActivity.appendChild(requestElement);
            });
        }

function renderMessages() {
    messagesLoading = false;
    
    if (messages.length === 0) {
        messagesContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <h3>No Messages Yet</h3>
                <p>When you start conversations about listings, they'll appear here.</p>
            </div>
        `;
        return;
    }
    
    messagesContent.innerHTML = '';
    
    messages.forEach(message => {
        const otherUserId = message.participants.find(id => id !== currentUser.uid);
        const unreadCount = message[`${currentUser.uid}_unread`] || 0;
        const isRequest = message.listingId && message.listingTitle;
        
        const messageElement = document.createElement('div');
        messageElement.className = 'food-card';
        messageElement.style.cursor = 'pointer';
        messageElement.innerHTML = `
            <div class="food-details" style="display: flex; align-items: center; gap: 1rem; padding: 1rem;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background-color: var(--gray-100); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    <span style="font-weight: 600; color: white;">${message.participantInitials[otherUserId] || 'U'}</span>
                </div>
                <div style="flex: 1;">
                    <h3 style="font-size: 1rem; color: var(--gray-600); margin-bottom: 0.3rem;">
                        ${message.participantNames[otherUserId]}
                        ${unreadCount > 0 ? `<span style="background-color: var(--primary-green); color: white; padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.7rem; margin-left: 0.5rem;">${unreadCount}</span>` : ''}
                    </h3>
                    ${isRequest ? `<p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.3rem;">About: ${message.listingTitle}</p>` : ''}
                    <p style="font-size: 0.9rem; color: var(--gray-400); margin-bottom: 0.3rem;">${message.lastMessage || 'No messages yet'}</p>
                    <p style="font-size: 0.8rem; color: var(--gray-400);">${formatTime(message.lastUpdated.toDate())}</p>
                </div>
            </div>
        `;
        
        messageElement.addEventListener('click', () => viewMessage(message.id));
        messagesContent.appendChild(messageElement);
    });
}

        function formatCategory(category) {
            const categories = {
                'bakery': 'Bakery',
                'produce': 'Produce',
                'dairy': 'Dairy',
                'pantry': 'Pantry',
                'prepared': 'Prepared',
                'other': 'Other'
            };
            
            return categories[category] || 'Other';
        }

        function formatDate(date) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString(undefined, options);
        }

        function formatTime(date) {
            const options = { hour: '2-digit', minute: '2-digit' };
            return date.toLocaleTimeString(undefined, options);
        }

        function viewListingDetails(listingId) {
            // In a real app, this would show a detailed view of the listing
            showToast('Listing details would show here', 'info');
        }

        function viewRequestDetails(requestId) {
            // In a real app, this would show the request details
            showToast('Request details would show here', 'info');
        }

        function viewMessage(otherUserId) {
            // In a real app, this would open the chat with the other user
            showToast(`Chat with user ${otherUserId} would open here`, 'info');
        }
        
 async function startChat(otherUserId, threadId = null) {
   
   showPage('chat');
   
    try {
        // Unsubscribe from previous chat if any
        if (currentChatUnsubscribe) {
            currentChatUnsubscribe();
            currentChatUnsubscribe = null;
        }

        // Reset chat state
        currentChatUserId = null;
        currentChannelId = null;
        
        // Get other user's data
        const otherUserDoc = await db.collection('users').doc(otherUserId).get();
        if (!otherUserDoc.exists) {
            showToast('User not found', 'error');
            return;
        }
        
        const otherUserData = otherUserDoc.data();
        
        // Update chat header
        document.getElementById('chatHeaderName').textContent = otherUserData.name;
        
        // Update avatar in chat header
        const chatAvatarInitial = document.getElementById('chatAvatarInitial');
        const chatAvatarImage = document.getElementById('chatAvatarImage');
        
        if (otherUserData.avatarType === 'default') {
            chatAvatarInitial.textContent = otherUserData.avatarInitial || 'U';
            chatAvatarInitial.style.display = 'flex';
            chatAvatarImage.style.display = 'none';
            document.getElementById('chatHeaderAvatar').style.backgroundColor = '';
            document.getElementById('chatHeaderAvatar').classList.add(otherUserData.avatarColor || 'color-1');
        } else {
            chatAvatarInitial.style.display = 'none';
            chatAvatarImage.style.display = 'block';
            chatAvatarImage.src = otherUserData.avatarUrl;
            document.getElementById('chatHeaderAvatar').style.backgroundColor = '';
            document.getElementById('chatHeaderAvatar').classList.remove('color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6');
        }
        
        // Create channel ID (sorted user IDs joined by hyphen)
        const participants = [currentUser.uid, otherUserId].sort();
        const channelId = participants.join('-');
        
        currentChatUserId = otherUserId;
        currentChannelId = channelId;
        
        // Check if chat document exists
        const chatRef = db.collection('chats').doc(channelId);
        const chatDoc = await chatRef.get();
        
        const timestamp = firebase.firestore.FieldValue.serverTimestamp();
        
        if (!chatDoc.exists) {
            // Create new chat document
            await chatRef.set({
                participants: participants,
                participantsInfo: {
                    [currentUser.uid]: {
                        name: userData.name,
                        lastRead: timestamp
                    },
                    [otherUserId]: {
                        name: otherUserData.name,
                        lastRead: null
                    }
                },
                lastMessage: '',
                lastMessageAt: null,
                createdAt: timestamp,
                updatedAt: timestamp
            });
        } else {
            // Update last read time
            await chatRef.update({
                [`participantsInfo.${currentUser.uid}.lastRead`]: timestamp,
                updatedAt: timestamp
            });
        }
        
        // Set up real-time listener for messages
        const messagesQuery = db.collection('messages')
            .where('channelId', '==', channelId)
            .orderBy('timestamp', 'asc');
        
        currentChatUnsubscribe = messagesQuery.onSnapshot(snapshot => {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.innerHTML = '';
    
    if (snapshot.empty) {
        messagesContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <h3>No messages yet</h3>
                <p>Send a message to start the conversation!</p>
            </div>
        `;
    } else {
        snapshot.forEach(doc => {
            const message = doc.data();
            // Ensure timestamp is properly formatted
            if (message.timestamp && message.timestamp.toDate) {
                message.timestamp = message.timestamp.toDate();
            }
            displayMessage(message, message.senderId !== currentUser.uid);
        });
        
        // Scroll to bottom
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
    }
}, error => {
    console.error('Message listener error:', error);
    document.getElementById('chatMessages').innerHTML = `
        <div class="empty-state">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error loading messages</h3>
            <p>${error.message}</p>
        </div>
    `;
});
        
        // Show chat page
        showPage('chat');
        
    } catch (error) {
        console.error('Error starting chat:', error);
        showToast('Error starting chat', 'error');
    }
}

// Function to display a message
function displayMessage(message, isReceived) {
    const messagesContainer = document.getElementById('chatMessages');
    const emptyState = messagesContainer.querySelector('.empty-state');
    
    if (emptyState) {
        messagesContainer.removeChild(emptyState);
    }
    
    const messageElement = document.createElement('div');
    messageElement.className = `message ${isReceived ? 'received' : 'sent'}`;
    
    // Safely handle timestamp
    let messageTime;
    if (message.timestamp) {
        if (message.timestamp.toDate) { // Firestore Timestamp
            messageTime = message.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else if (message.timestamp instanceof Date) { // JavaScript Date
            messageTime = message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        } else { // Fallback
            messageTime = 'Just now';
        }
    } else {
        messageTime = 'Just now';
    }
    
    messageElement.innerHTML = `
        <div class="message-content">${message.text}</div>
        <div class="message-time">${messageTime}</div>
    `;
    
    messagesContainer.appendChild(messageElement);
    
    // Scroll to bottom
    setTimeout(() => {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 50);
}

// Function to send a message
async function sendMessage() {
    const messageInput = document.getElementById('chatMessageInput');
    const messageText = messageInput.value.trim();
    
    if (!messageText || !currentChannelId || !currentChatUserId) {
        return;
    }

    const timestamp = firebase.firestore.FieldValue.serverTimestamp();
    
    const message = {
        channelId: currentChannelId,
        text: messageText,
        senderId: currentUser.uid,
        senderName: userData.name,
        timestamp: timestamp
    };
    
    try {
        // Show message optimistically
        displayMessage({
            text: messageText,
            senderId: currentUser.uid,
            timestamp: new Date() // Use Date object for optimistic update
        }, false);
        
        messageInput.value = '';
        
        // Update chat document first
        await db.collection('chats').doc(currentChannelId).update({
            lastMessage: messageText,
            lastMessageAt: timestamp,
            [`participantsInfo.${currentUser.uid}.lastRead`]: timestamp,
            updatedAt: timestamp
        });
        
        // Then save the message
        await db.collection('messages').add(message);
        
    } catch (error) {
        console.error('Error sending message:', error);
        showToast('Error sending message', 'error');
    }
}

// Function to go back to messages
function backToMessages() {
    if (currentChatUnsubscribe) {
        currentChatUnsubscribe();
        currentChatUnsubscribe = null;
    }
    
    currentChatUserId = null;
    currentChannelId = null;
    
    showPage('messages');
}

function viewMessage(threadId) {
    // Store the thread ID in session to access in the chat UI
    sessionStorage.setItem('currentChatThread', threadId);
    
    // Show the messages page
    showPage('messages');
    
    // In a real implementation, you would:
    // 1. Load the specific chat messages
    // 2. Scroll to the conversation
    // 3. Update the UI to highlight the active chat
    
    // For now, we'll just show a toast
    showToast(`Opening chat with thread ID: ${threadId}`, 'info');
}

function showPage(page) {
    currentPage = page;
    
    // Hide all pages
    document.querySelectorAll('.page-content').forEach(el => {
        el.style.display = 'none';
    });
    
    // Show/hide FAB based on role and page
    if (userData?.role === 'donor' && page === 'listings') {
        fabButton.style.display = 'flex';
    } else {
        fabButton.style.display = 'none';
    }
   
    // Hide all pages
    document.querySelectorAll('.page-content').forEach(el => {
        el.style.display = 'none';
    });
    
    // Toggle chat page class
    if (page === 'chat') {
        document.body.classList.add('chat-page-active');
    } else {
        document.body.classList.remove('chat-page-active');
    }
    
    // Show the selected page
    document.getElementById(`${page}Page`).style.display = 'block';
    
    // Update active nav items
    document.querySelectorAll('.sidebar-item').forEach(el => {
        el.classList.remove('active');
    });
    
    document.querySelectorAll('.nav-item').forEach(el => {
        el.classList.remove('active');
    });
    
    if (page === 'home') {
        document.querySelector('.sidebar-item[onclick="showPage(\'home\')"]').classList.add('active');
        document.querySelector('.nav-item[onclick="showPage(\'home\')"]').classList.add('active');
        mobileHeaderTitle.textContent = 'Home';
    } else if (page === 'listings') {
        document.querySelector('.sidebar-item[onclick="showPage(\'listings\')"]').classList.add('active');
        document.querySelector('.nav-item[onclick="showPage(\'listings\')"]').classList.add('active');
        mobileHeaderTitle.textContent = userData.role === 'donor' ? 'My Listings' : 'Browse Listings';
    } else if (page === 'messages') {
        document.querySelector('.sidebar-item[onclick="showPage(\'messages\')"]').classList.add('active');
        document.querySelector('.nav-item[onclick="showPage(\'messages\')"]').classList.add('active');
        mobileHeaderTitle.textContent = 'Messages';
    } else if (page === 'chat') {
        mobileHeaderTitle.textContent = 'Chat';
    } else if (page === 'profile') {
        mobileHeaderTitle.textContent = 'Profile';
    }
    
    // Scroll to top for non-chat pages
    if (page !== 'chat') {
        mainContent.scrollTo(0, 0);
    }
}

// Add event listeners for chat input
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    
    document.getElementById('chatMessageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
});

function renderMessages() {
    messagesLoading = false;
    messagesContent.innerHTML = '';
    
    if (messages.length === 0) {
        messagesContent.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-comments"></i>
                <h3>No Messages Yet</h3>
                <p>When you start conversations about listings, they'll appear here.</p>
            </div>
        `;
        return;
    }
    
    messages.forEach(message => {
        const otherUserId = message.participants.find(id => id !== currentUser.uid);
        const otherUserData = message.participantNames[otherUserId];
        const unreadCount = message[`${currentUser.uid}_unread`] || 0;
        const isRequest = message.listingId && message.listingTitle;
        
        const messageElement = document.createElement('div');
        messageElement.className = 'food-card';
        messageElement.style.cursor = 'pointer';
        messageElement.innerHTML = `
            <div class="food-details" style="display: flex; align-items: center; gap: 1rem; padding: 1rem;">
                <div class="user-avatar" style="width: 50px; height: 50px; border-radius: 50%; background-color: var(--gray-100); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    ${message.participantAvatars && message.participantAvatars[otherUserId] 
                        ? `<img src="${message.participantAvatars[otherUserId]}" style="width: 100%; height: 100%; object-fit: cover;">`
                        : `<span style="font-weight: 600; color: white;">${message.participantInitials[otherUserId] || 'U'}</span>`}
                </div>
                <div style="flex: 1;">
                    <h3 style="font-size: 1rem; color: var(--gray-600); margin-bottom: 0.3rem;">
                        ${otherUserData}
                        ${unreadCount > 0 ? `<span style="background-color: var(--primary-green); color: white; padding: 0.1rem 0.5rem; border-radius: 10px; font-size: 0.7rem; margin-left: 0.5rem;">${unreadCount}</span>` : ''}
                    </h3>
                    ${isRequest ? `<p style="font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.3rem;">About: ${message.listingTitle}</p>` : ''}
                    <p style="font-size: 0.9rem; color: var(--gray-400); margin-bottom: 0.3rem;">${message.lastMessage || 'No messages yet'}</p>
                    <p style="font-size: 0.8rem; color: var(--gray-400);">${formatTime(message.lastUpdated.toDate())}</p>
                </div>
            </div>
        `;
        
        messageElement.addEventListener('click', () => {
            startChat(otherUserId, message.id);
        });
        messagesContent.appendChild(messageElement);
    });
}

        function showDefaultAvatarOptions() {
            defaultAvatarBtn.classList.add('active');
            customAvatarBtn.classList.remove('active');
            defaultAvatarOptions.style.display = 'flex';
            customAvatarUpload.style.display = 'none';
            selectedAvatarType = 'default';
        }

        function showCustomAvatarUpload() {
            defaultAvatarBtn.classList.remove('active');
            customAvatarBtn.classList.add('active');
            defaultAvatarOptions.style.display = 'none';
            customAvatarUpload.style.display = 'flex';
            selectedAvatarType = 'custom';
        }

        function selectDefaultAvatar(element, initial) {
            // Remove selected class from all options
            document.querySelectorAll('.avatar-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Update selected avatar
            selectedAvatar = initial;
            selectedAvatarColor = element.classList[1]; // Get the color class
            
            // Update preview
            avatarPreview.innerHTML = `<span style="font-size: 3rem; font-weight: 600; color: white;">${initial}</span>`;
            avatarPreview.style.backgroundColor = '';
            avatarPreview.classList.add(selectedAvatarColor);
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showToast('Please select an image file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarPreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                avatarPreview.style.backgroundColor = '';
                avatarPreview.classList.remove('color-1', 'color-2', 'color-3', 'color-4', 'color-5', 'color-6');
            };
            reader.readAsDataURL(file);
        }

        async function completeProfileSetup() {
            try {
                // Show loading state
                completeProfileBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i><span>Setting Up...</span>';
                
                let avatarUrl = '';
                
                if (selectedAvatarType === 'default') {
                    // No need to upload for default avatar
                    avatarUrl = '';
                } else {
                    // Upload custom avatar to ImageBB
                    const file = avatarUpload.files[0];
                    if (!file) {
                        showToast('Please select a profile photo', 'error');
                        completeProfileBtn.innerHTML = '<span>Complete Profile</span>';
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('image', file);
                    
                    const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMAGEBB_API_KEY}`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error('Image upload failed');
                    }
                    
                    avatarUrl = data.data.url;
                }
                
                // Get profile details
                const bio = document.getElementById('profileBio').value.trim();
                const location = document.getElementById('profileLocation').value.trim();
                const organization = document.getElementById('profileOrganization').value.trim();
                
                // Update user data in Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    profileComplete: true,
                    avatarType: selectedAvatarType,
                    avatarInitial: selectedAvatar,
                    avatarColor: selectedAvatarColor,
                    avatarUrl: avatarUrl,
                    bio: bio,
                    location: location,
                    organization: userData.role === 'donor' ? organization : '',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update user data locally
                userData.profileComplete = true;
                userData.avatarType = selectedAvatarType;
                userData.avatarInitial = selectedAvatar;
                userData.avatarColor = selectedAvatarColor;
                userData.avatarUrl = avatarUrl;
                userData.bio = bio;
                userData.location = location;
                if (userData.role === 'donor') {
                    userData.organization = organization;
                }
                
                // Show success message
                showToast('Profile setup complete!', 'success');
                
                // Show the app
                showApp();
            } catch (error) {
                console.error('Error completing profile setup:', error);
                showToast('Error completing profile setup', 'error');
                completeProfileBtn.innerHTML = '<span>Complete Profile</span>';
            }
        }

        function showCreateListingModal() {
            if (!userData.verified) {
                showToast('Please verify your account to create listings', 'error');
                showPage('profile');
                return;
            }
            
            // Reset form
            listingImagePreview.innerHTML = '<i class="fas fa-camera"></i>';
            document.getElementById('listingTitle').value = '';
            document.getElementById('listingDescription').value = '';
            document.getElementById('listingExpiry').value = '';
            document.getElementById('listingAddress').value = '';
            
            // Reset category selection
            document.querySelectorAll('.category-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelector('.category-option[data-category="bakery"]').classList.add('selected');
            selectedCategory = 'bakery';
            
            // Show modal
            createListingModal.style.display = 'flex';
        }

        function handleListingImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.match('image.*')) {
                showToast('Please select an image file', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                listingImagePreview.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
            };
            reader.readAsDataURL(file);
        }
        
  async function createListing() {
    try {
        // Get form values
        const title = document.getElementById('listingTitle').value.trim();
        const description = document.getElementById('listingDescription').value.trim();
        const expiryDate = document.getElementById('listingExpiry').value;
        const address = document.getElementById('listingAddress').value.trim();
        const imageFile = document.getElementById('listingImageUpload').files[0];
        
        // Validate form (existing validation code remains the same)
        
        // Show loading state on button
        const originalButtonText = createListingBtn.innerHTML;
        createListingBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i><span>Creating...</span>';
        createListingBtn.disabled = true;
        
        let imageUrl = '';
        
        // Upload image if provided (existing upload code remains the same)
        
        // Create listing in Firestore
        const newListing = {
            userId: currentUser.uid,
            userName: userData.name,
            title: title,
            description: description,
            category: selectedCategory,
            expiryDate: firebase.firestore.Timestamp.fromDate(new Date(expiryDate)),
            address: address,
            imageUrl: imageUrl,
            status: 'available',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add the new listing to Firestore
        const docRef = await db.collection('listings').add(newListing);
        
        // Immediately add to local state before Firestore listener updates
        const listingWithId = {
            id: docRef.id,
            ...newListing
        };
        
        // Add to beginning of array to show newest first
        userListings.unshift(listingWithId);
        
        // Update the UI immediately
        renderUserListings();
        
        // Hide modal and show success message
        hideModal('createListingModal');
        showToast('Listing created successfully!', 'success');
        
    } catch (error) {
        console.error('Error creating listing:', error);
        showToast('Error creating listing: ' + error.message, 'error');
    } finally {
        // Reset button state
        createListingBtn.innerHTML = originalButtonText;
        createListingBtn.disabled = false;
    }
}

        function selectCategory(element, category) {
            // Remove selected class from all options
            document.querySelectorAll('.category-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Update selected category
            selectedCategory = category;
        }

async function createFoodRequest(listingId) {
    try {
        // Check if user is verified
        if (!userData.verified) {
            showToast('Please verify your account to request food', 'error');
            showVerificationModal();
            return;
        }

        // Find the listing
        const listing = userListings.find(l => l.id === listingId);
        if (!listing) {
            showToast('Listing not found', 'error');
            return;
        }

        // Create a message thread first
        const messageThread = await db.collection('messages').add({
            participants: [currentUser.uid, listing.userId],
            participantNames: {
                [currentUser.uid]: userData.name,
                [listing.userId]: listing.userName
            },
            participantInitials: {
                [currentUser.uid]: userData.avatarInitial,
                [listing.userId]: listing.userInitial || 'U'
            },
            listingId: listingId,
            listingTitle: listing.title,
            lastMessage: 'Hey, is this still available?',
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            [`${currentUser.uid}_unread`]: 0,
            [`${listing.userId}_unread`]: 1 // Mark as unread for donor
        });

        // Create request document
        const requestRef = await db.collection('requests').add({
            listingId: listingId,
            listingTitle: listing.title,
            listingImageUrl: listing.imageUrl,
            donorId: listing.userId,
            donorName: listing.userName,
            receiverId: currentUser.uid,
            receiverName: userData.name,
            status: 'pending',
            messageThreadId: messageThread.id, // Store the message thread ID
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            message: 'Hey, is this still available?'
        });

        // Create notification for donor
        await db.collection('notifications').add({
            userId: listing.userId,  // Notification for the donor
            type: 'request',
            requestId: requestRef.id,
            listingId: listingId,
            listingTitle: listing.title,
            receiverId: currentUser.uid,
            receiverName: userData.name,
            messageThreadId: messageThread.id,
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            read: false
        });

        // Add initial message to the thread
        await db.collection('messages').doc(messageThread.id).collection('conversation').add({
            senderId: currentUser.uid,
            senderName: userData.name,
            text: 'Hey, is this still available?',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            type: 'text'
        });

        showToast('Request sent to donor!', 'success');
        
        // Refresh the listings to update the UI
        renderUserListings();
        
        // Show the messages page
        showPage('messages');
    } catch (error) {
        console.error('Error creating food request:', error);
        showToast('Error sending request', 'error');
    }
}

async function handleRequestAction(requestId, action) {
    try {
        const requestRef = db.collection('requests').doc(requestId);
        const requestDoc = await requestRef.get();
        
        if (!requestDoc.exists) {
            showToast('Request not found', 'error');
            return;
        }

        const request = requestDoc.data();
        
        if (action === 'accept') {
            // Update request status
            await requestRef.update({
                status: 'accepted',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update listing status
            await db.collection('listings').doc(request.listingId).update({
                status: 'claimed',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Create a message thread between donor and receiver
            const messageRef = await db.collection('messages').add({
                participants: [currentUser.uid, request.receiverId],
                participantNames: {
                    [currentUser.uid]: userData.name,
                    [request.receiverId]: request.receiverName
                },
                participantInitials: {
                    [currentUser.uid]: userData.avatarInitial,
                    [request.receiverId]: request.receiverInitial || 'U'
                },
                participantAvatars: {
                    [currentUser.uid]: userData.avatarType === 'default' 
                        ? null 
                        : userData.avatarUrl,
                    [request.receiverId]: request.receiverAvatarUrl || null
                },
                listingId: request.listingId,
                listingTitle: request.listingTitle,
                lastMessage: `Request for "${request.listingTitle}" was accepted`,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                [`${currentUser.uid}_unread`]: 0,
                [`${request.receiverId}_unread`]: 1 // Mark as unread for receiver
            });

            // Add initial message to the thread
            await db.collection('messages').doc(messageRef.id).collection('conversation').add({
                senderId: currentUser.uid,
                senderName: userData.name,
                text: `I've accepted your request for "${request.listingTitle}"! When would you like to pick up?`,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                type: 'text'
            });

            // Create notification for receiver
            await db.collection('notifications').add({
                userId: request.receiverId,
                type: 'request_accepted',
                requestId: requestId,
                listingId: request.listingId,
                listingTitle: request.listingTitle,
                donorId: currentUser.uid,
                donorName: userData.name,
                messageThreadId: messageRef.id,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });

            showToast('Request accepted! A message thread has been created.', 'success');
            
        } else if (action === 'reject') {
            // Update request status
            await requestRef.update({
                status: 'rejected',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Create notification for receiver
            await db.collection('notifications').add({
                userId: request.receiverId,
                type: 'request_rejected',
                requestId: requestId,
                listingId: request.listingId,
                listingTitle: request.listingTitle,
                donorId: currentUser.uid,
                donorName: userData.name,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });

            showToast('Request rejected', 'info');
        }

        // Refresh data
        await loadInitialData();
        renderUserListings();
        
    } catch (error) {
        console.error('Error handling request action:', error);
        showToast('Error processing request', 'error');
    }
}

async function handleNotificationAction(notificationId, action, event) {
    event.stopPropagation();
    
    try {
        const notificationRef = db.collection('notifications').doc(notificationId);
        const notificationDoc = await notificationRef.get();
        
        if (!notificationDoc.exists) return;

        const notification = notificationDoc.data();

        if (action === 'accept') {
            // Update the request status
            await db.collection('requests').doc(notification.requestId).update({
                status: 'accepted',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Add a message to the existing thread
            await db.collection('messages').doc(notification.messageThreadId).collection('conversation').add({
                senderId: currentUser.uid,
                senderName: userData.name,
                text: 'I\'ve accepted your request! When would you like to pick up?',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                type: 'text'
            });

            // Update the message thread
            await db.collection('messages').doc(notification.messageThreadId).update({
                lastMessage: 'I\'ve accepted your request! When would you like to pick up?',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                [`${notification.receiverId}_unread`]: 1 // Mark as unread for receiver
            });

            // Create notification for receiver
            await db.collection('notifications').add({
                userId: notification.receiverId,
                type: 'request_accepted',
                requestId: notification.requestId,
                listingId: notification.listingId,
                listingTitle: notification.listingTitle,
                donorId: currentUser.uid,
                donorName: userData.name,
                messageThreadId: notification.messageThreadId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });

            // Update the original notification
            await notificationRef.update({
                status: 'processed',
                read: true,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            showToast('Request accepted!', 'success');
            
        } else if (action === 'reject') {
            // Update the request status
            await db.collection('requests').doc(notification.requestId).update({
                status: 'rejected',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Add a message to the existing thread
            await db.collection('messages').doc(notification.messageThreadId).collection('conversation').add({
                senderId: currentUser.uid,
                senderName: userData.name,
                text: 'Sorry, this item is no longer available.',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                type: 'text'
            });

            // Update the message thread
            await db.collection('messages').doc(notification.messageThreadId).update({
                lastMessage: 'Sorry, this item is no longer available.',
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                [`${notification.receiverId}_unread`]: 1 // Mark as unread for receiver
            });

            // Create notification for receiver
            await db.collection('notifications').add({
                userId: notification.receiverId,
                type: 'request_rejected',
                requestId: notification.requestId,
                listingId: notification.listingId,
                listingTitle: notification.listingTitle,
                donorId: currentUser.uid,
                donorName: userData.name,
                messageThreadId: notification.messageThreadId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });

            // Update the original notification
            await notificationRef.update({
                status: 'processed',
                read: true,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            showToast('Request rejected', 'info');
        }

        // Refresh the UI
        await loadNotifications();
        await loadInitialData();
        
    } catch (error) {
        console.error('Error handling notification action:', error);
        showToast('Error processing request', 'error');
    }
}

async function loadRecentActivities() {
    try {
        const snapshot = await db.collection('activities')
            .where('userId', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();
        
        recentActivities = [];
        snapshot.forEach(doc => {
            recentActivities.push({ id: doc.id, ...doc.data() });
        });
        
    } catch (error) {
        console.error('Error loading activities:', error);
    }
}

function renderNotificationsList() {
    const container = document.getElementById('notificationsList');
    if (!container) return;
    
    container.innerHTML = '';

    if (notifications.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-bell"></i>
                <h3>No Notifications</h3>
                <p>Your notifications will appear here</p>
            </div>
        `;
        return;
    }

    notifications.forEach(notification => {
        const notificationElement = document.createElement('div');
        notificationElement.className = `notification-item ${notification.read ? '' : 'unread'}`;
        
        let icon, message, color, actions = '';
        
        switch(notification.type) {
            case 'request':
                icon = 'fa-hand-holding-heart';
                message = `${notification.receiverName} requested your "${notification.listingTitle}" listing`;
                color = 'var(--primary-green)';
                actions = `
                    <div class="notification-actions">
                        <button class="btn btn-primary" onclick="handleNotificationAction('${notification.id}', 'accept', event)">
                            Accept
                        </button>
                        <button class="btn btn-secondary" onclick="handleNotificationAction('${notification.id}', 'reject', event)">
                            Reject
                        </button>
                        <button class="btn btn-text" onclick="startChat('${notification.receiverId}', '${notification.messageThreadId}')">
                            <i class="fas fa-comment"></i> Chat
                        </button>
                    </div>
                `;
                break;
            case 'request_accepted':
                icon = 'fa-check-circle';
                message = `${notification.donorName} accepted your request for "${notification.listingTitle}"`;
                color = 'var(--primary-green)';
                actions = `
                    <div class="notification-actions">
                        <button class="btn btn-primary" onclick="startChat('${notification.donorId}', '${notification.messageThreadId}')">
                            <i class="fas fa-comment"></i> Message Donor
                        </button>
                    </div>
                `;
                break;
            case 'request_rejected':
                icon = 'fa-times-circle';
                message = `${notification.donorName} declined your request for "${notification.listingTitle}"`;
                color = '#ef4444';
                break;
            default:
                icon = 'fa-bell';
                message = notification.message || 'New notification';
                color = 'var(--gray-400)';
        }
        
        notificationElement.innerHTML = `
            <div class="notification-content">
                <i class="fas ${icon}" style="color: ${color};"></i>
                <div class="notification-text">
                    <p>${message}</p>
                    <small class="notification-time">
                        <i class="fas fa-clock"></i> ${formatTime(notification.createdAt.toDate())}
                    </small>
                    ${actions}
                </div>
                ${!notification.read ? '<div class="notification-badge"></div>' : ''}
            </div>
        `;
        
        container.appendChild(notificationElement);
    });
}

async function handleNotificationAction(notificationId, action, event) {
    event.stopPropagation();
    
    try {
        const notificationRef = db.collection('notifications').doc(notificationId);
        const notificationDoc = await notificationRef.get();
        
        if (!notificationDoc.exists) return;

        const notification = notificationDoc.data();

        if (action === 'accept') {
            // Update request status
            await db.collection('requests').doc(notification.requestId).update({
                status: 'accepted',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update notification status
            await notificationRef.update({
                status: 'accepted',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: true
            });

            // Create a new notification for the receiver
            await db.collection('notifications').add({
                type: 'request_accepted',
                requestId: notification.requestId,
                listingId: notification.listingId,
                listingTitle: notification.listingTitle,
                donorId: currentUser.uid,
                donorName: userData.name,
                receiverId: notification.receiverId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });

            showToast('Request accepted!', 'success');
        } else if (action === 'reject') {
            // Update request status
            await db.collection('requests').doc(notification.requestId).update({
                status: 'rejected',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            // Update notification status
            await notificationRef.update({
                status: 'rejected',
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: true
            });

            // Create a new notification for the receiver
            await db.collection('notifications').add({
                type: 'request_rejected',
                requestId: notification.requestId,
                listingId: notification.listingId,
                listingTitle: notification.listingTitle,
                donorId: currentUser.uid,
                donorName: userData.name,
                receiverId: notification.receiverId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });

            showToast('Request rejected', 'info');
        }

        // Update the notifications list
        await loadNotifications();
    } catch (error) {
        console.error('Error handling notification action:', error);
        showToast('Error processing request', 'error');
    }
}

async function markAllAsRead() {
    try {
        const batch = db.batch();
        const unreadNotifications = notifications.filter(n => !n.read);
        
        unreadNotifications.forEach(notification => {
            const notificationRef = db.collection('notifications').doc(notification.id);
            batch.update(notificationRef, {
                read: true,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        
        await batch.commit();
        showToast('All notifications marked as read', 'success');
    } catch (error) {
        console.error('Error marking notifications as read:', error);
        showToast('Error marking notifications as read', 'error');
    }
}

        function showVerificationModal() {
            // Reset form
            document.getElementById('idImagePreview').innerHTML = '<i class="fas fa-id-card"></i>';
            document.getElementById('addressImagePreview').innerHTML = '<i class="fas fa-file-invoice"></i>';
            document.getElementById('verificationMessage').value = '';
            
            // Show modal
            verificationModal.style.display = 'flex';
        }

        function hideVerificationModal() {
            verificationModal.style.display = 'none';
        }

        async function submitVerification() {
            try {
                // Validate form
                const idFile = document.getElementById('idImageUpload').files[0];
                const addressFile = document.getElementById('addressImageUpload').files[0];
                const message = document.getElementById('verificationMessage').value.trim();
                
                if (!idFile) {
                    showToast('Please upload your ID', 'error');
                    return;
                }
                
                if (!addressFile) {
                    showToast('Please upload proof of address', 'error');
                    return;
                }
                
                // Show loading state
                submitVerificationBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i><span>Submitting...</span>';
                
                // Upload ID image
                const idFormData = new FormData();
                idFormData.append('image', idFile);
                
                const idResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMAGEBB_API_KEY}`, {
                    method: 'POST',
                    body: idFormData
                });
                
                const idData = await idResponse.json();
                if (!idData.success) {
                    throw new Error('ID image upload failed');
                }
                
                const idUrl = idData.data.url;
                
                // Upload address proof image
                const addressFormData = new FormData();
                addressFormData.append('image', addressFile);
                
                const addressResponse = await fetch(`https://api.imgbb.com/1/upload?key=${IMAGEBB_API_KEY}`, {
                    method: 'POST',
                    body: addressFormData
                });
                
                const addressData = await addressResponse.json();
                if (!addressData.success) {
                    throw new Error('Address proof upload failed');
                }
                
                const addressUrl = addressData.data.url;
                
                // Submit verification request
                await db.collection('verifications').add({
                    userId: currentUser.uid,
                    userName: userData.name,
                    userEmail: userData.email,
                    idImageUrl: idUrl,
                    addressImageUrl: addressUrl,
                    message: message,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update user verification status to "pending"
                await db.collection('users').doc(currentUser.uid).update({
                    verificationStatus: 'pending',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Hide modal
                hideVerificationModal();
                
                // Show success message
                showToast('Verification submitted for review!', 'success');
                
                // Update UI
                userData.verificationStatus = 'pending';
                updateVerificationStatus();
            } catch (error) {
                console.error('Error submitting verification:', error);
                showToast('Error submitting verification', 'error');
                submitVerificationBtn.innerHTML = '<span>Submit for Review</span>';
            }
        }

        function showDeleteAccountModal() {
            // Reset form
            document.getElementById('deletePassword').value = '';
            document.getElementById('deletePasswordError').style.display = 'none';
            
            // Show modal
            deleteAccountModal.style.display = 'flex';
        }

        async function deleteAccount() {
            try {
                const password = document.getElementById('deletePassword').value;
                
                if (!password) {
                    document.getElementById('deletePasswordError').textContent = 'Please enter your password';
                    document.getElementById('deletePasswordError').style.display = 'block';
                    return;
                }
                
                // Reauthenticate user
                const credential = firebase.auth.EmailAuthProvider.credential(
                    currentUser.email,
                    password
                );
                
                await currentUser.reauthenticateWithCredential(credential);
                
                // Delete user data from Firestore
                await db.collection('users').doc(currentUser.uid).delete();
                
                // Delete user account
                await currentUser.delete();
                
                // Hide modal
                hideModal('deleteAccountModal');
                
                // Show success message
                showToast('Account deleted successfully', 'success');
                
                // Redirect to auth screen
                setTimeout(() => {
                    showAuthScreen();
                }, 1500);
            } catch (error) {
                console.error('Error deleting account:', error);
                
                if (error.code === 'auth/wrong-password') {
                    document.getElementById('deletePasswordError').textContent = 'Incorrect password';
                    document.getElementById('deletePasswordError').style.display = 'block';
                } else {
                    showToast('Error deleting account', 'error');
                }
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-times' : 'fa-info'}"></i>
                </div>
                <div class="toast-content">
                    <h3 class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</h3>
                    <p class="toast-message">${message}</p>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 5000);
        }

        // Auth functions
        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const tabIndicator = document.getElementById('tabIndicator');
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                
                // Animate tab indicator
                tabIndicator.style.left = '0';
                tabIndicator.style.width = '50%';
                
                // Animate forms
                if (signupForm.style.display !== 'none') {
                    signupForm.style.animation = 'formSwitchOut 0.4s forwards';
                    setTimeout(() => {
                        signupForm.style.display = 'none';
                        loginForm.style.display = 'flex';
                        loginForm.style.animation = 'formSwitchIn 0.4s forwards';
                    }, 300);
                }
            } else {
                loginTab.classList.remove('active');
                signupTab.classList.add('active');
                
                // Animate tab indicator
                tabIndicator.style.left = '50%';
                tabIndicator.style.width = '50%';
                
                // Animate forms
                if (loginForm.style.display !== 'none') {
                    loginForm.style.animation = 'formSwitchOut 0.4s forwards';
                    setTimeout(() => {
                        loginForm.style.display = 'none';
                        signupForm.style.display = 'flex';
                        signupForm.style.animation = 'formSwitchIn 0.4s forwards';
                    }, 300);
                }
            }
        }
        
        function selectRoleOption(element, role) {
            // Remove selected class from all options
            const options = document.querySelectorAll('.role-option');
            options.forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selected class to clicked option
            element.classList.add('selected');
            
            // Update selected role
            selectedRole = role;
            
            // Show/hide organization field based on role
            if (role === 'donor') {
                document.getElementById('organizationGroup').style.display = 'block';
            } else {
                document.getElementById('organizationGroup').style.display = 'none';
            }
        }
        
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const emailField = document.getElementById('loginEmail').parentElement;
            const passwordField = document.getElementById('loginPassword').parentElement;
            const emailError = document.getElementById('loginEmailError');
            const passwordError = document.getElementById('loginPasswordError');
            
            let isValid = true;
            
            // Reset errors
            emailField.classList.remove('error');
            passwordField.classList.remove('error');
            emailError.style.display = 'none';
            passwordError.style.display = 'none';
            
            // Validate email
            if (!email || !email.includes('@')) {
                emailField.classList.add('error');
                emailError.style.display = 'block';
                isValid = false;
            }
            
            // Validate password
            if (!password || password.length < 6) {
                passwordField.classList.add('error');
                passwordError.style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) return;
            
            try {
                // Show loading state
                const loginBtn = document.getElementById('loginBtn');
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i><span>Logging In...</span>';
                
                // Sign in with Firebase
                await auth.signInWithEmailAndPassword(email, password);
                
                // Success - handled by auth state listener
            } catch (error) {
                console.error('Login error:', error);
                
                // Show error message
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    showToast('Invalid email or password', 'error');
                } else {
                    showToast('Login failed. Please try again.', 'error');
                }
                
                // Reset button
                loginBtn.innerHTML = '<span>Login</span>';
            }
        }
        
        async function signup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            const nameField = document.getElementById('signupName').parentElement;
            const emailField = document.getElementById('signupEmail').parentElement;
            const passwordField = document.getElementById('signupPassword').parentElement;
            const termsError = document.getElementById('termsError');
            const nameError = document.getElementById('signupNameError');
            const emailError = document.getElementById('signupEmailError');
            const passwordError = document.getElementById('signupPasswordError');
            
            let isValid = true;
            
            // Reset errors
            nameField.classList.remove('error');
            emailField.classList.remove('error');
            passwordField.classList.remove('error');
            termsError.style.display = 'none';
            nameError.style.display = 'none';
            emailError.style.display = 'none';
            passwordError.style.display = 'none';
            
            // Validate name
            if (!name) {
                nameField.classList.add('error');
                nameError.style.display = 'block';
                isValid = false;
            }
            
            // Validate email
            if (!email || !email.includes('@')) {
                emailField.classList.add('error');
                emailError.style.display = 'block';
                isValid = false;
            }
            
            // Validate password
            if (!password || password.length < 6) {
                passwordField.classList.add('error');
                passwordError.style.display = 'block';
                isValid = false;
            }
            
            // Validate terms agreement
            if (!agreeTerms) {
                termsError.style.display = 'block';
                isValid = false;
            }
            
            if (!isValid) return;
            
            try {
                // Show loading state
                const signupBtn = document.getElementById('signupBtn');
                signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i><span>Creating Account...</span>';
                
                // Create user with Firebase
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                // Update user profile
                await userCredential.user.updateProfile({
                    displayName: name
                });
                
                // Get organization if donor
                const organization = selectedRole === 'donor' ? document.getElementById('profileOrganization').value.trim() : '';
                
                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    role: selectedRole,
                    profileComplete: false,
                    verified: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    avatarType: 'default',
                    avatarInitial: 'A',
                    avatarColor: 'color-1',
                    organization: organization,
                    stats: {
                        donations: 0,
                        peopleHelped: 0,
                        rating: 0,
                        activeListings: 0
                    }
                });
                
                // Show success message
                showToast('Account created successfully!', 'success');
                
                // Show profile setup
                currentUser = userCredential.user;
                await fetchUserData();
                showProfileSetup();
            } catch (error) {
                console.error('Signup error:', error);
                if (error.code === 'auth/email-already-in-use') {
                    showToast('Email already in use', 'error');
                } else {
                    showToast('Signup failed. Please try again.', 'error');
                }
                
                // Reset button
                signupBtn.innerHTML = '<span>Create Account</span>';
            }
        }
        
         async function logout() {
            try {
                await auth.signOut();
                showToast('Logged out successfully', 'success');
                showAuthScreen();
            } catch (error) {
                console.error('Logout error:', error);
                showToast('Logout failed', 'error');
            }
        }
        
function toggleNotificationsModal() {
    const modal = document.getElementById('notificationsModal');
    if (modal.style.display === 'flex') {
        hideModal('notificationsModal');
    } else {
        showNotificationsModal();
    }
}

function showNotificationsModal() {
    const modal = document.getElementById('notificationsModal');
    modal.style.display = 'flex';
    
    // Render notifications in the modal
    renderNotifications(notifications, 'notificationsModalContent');
    
    // Mark notifications as read
    markNotificationsAsRead();
}

function markNotificationsAsRead() {
    notifications.forEach(notification => {
        if (!notification.read) {
            db.collection('notifications').doc(notification.id).update({
                read: true,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    });
}
      
// When logging out or changing screens
function cleanupListeners() {
    const listeners = setupRealtimeListeners();
    listeners.userListener();
    listeners.listingsListener();
    listeners.notificationsListener();
}      
        
       window.addEventListener('DOMContentLoaded', initApp);
       </script>
       </html>
