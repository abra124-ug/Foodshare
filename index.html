<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodShare - Reduce Waste, Share Love</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Splash Screen -->
        <div class="screen active" id="splashScreen">
            <div class="splash-screen">
                <div class="splash-logo">
                    <div class="logo-icon">
                        <i class="fas fa-seedling splash-logo"></i>
                    </div>
                    <h1 class="logo-text">Food Share</h1>
                    <p class="logo-tagline">Sharing food. Reducing waste.</p>
                </div>
                <div class="loading-indicator"></div>
            </div>
        </div>

        <!-- Onboarding Screens -->
        <div id="onboardingScreen" class="screen">
            
            <div class="onboarding-slide" id="slide1">
                <div class="slide-content">
                    <div class="onboarding-illustration">
                        <div class="onboarding-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                    </div>
                    <h2>Welcome to Food Share</h2>
                    <p>Join our community of conscious individuals working together to reduce food waste and share resources.</p>
                </div>
                
                <div class="onboarding-navigation">
                    <div class="onboarding-dots">
                        <div class="dot active"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <button class="btn btn-primary" onclick="showSlide(2)">Next</button>
                </div>
            </div>

            <div class="onboarding-slide" id="slide2" style="display: none;">
                <i class="fas fa-users onboarding-icon"></i>
                <h1>Join a Community</h1>
                <p>Connect with others who care about reducing food waste and creating a sustainable neighborhood.</p>
                
                <div class="onboarding-navigation">
                    <div class="onboarding-dots">
                        <div class="dot"></div>
                        <div class="dot active"></div>
                        <div class="dot"></div>
                    </div>
                    <button class="btn btn-primary" onclick="showSlide(3)">Next</button>
                </div>
            </div>

            <div class="onboarding-slide" id="slide3" style="display: none;">
                <i class="fas fa-map-marker-alt onboarding-icon"></i>
                <h1>Local Connection</h1>
                <p>Find nearby food sharing opportunities or post your own availability to help your local community.</p>
                
                <div class="onboarding-navigation">
                    <div class="onboarding-dots">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot active"></div>
                    </div>
                    <button class="btn btn-primary" onclick="showPage('authOptions')">Get Started</button>
                </div>
            </div>
        </div>

        <!-- Auth Options Screen -->
        <div id="authOptionsScreen" class="screen">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-seedling"></i>
                </div>
                <h1 class="auth-title">Welcome to FoodShare</h1>
                <p>Let's get you started with your account</p>
            </div>

            <button class="btn btn-primary btn-block" onclick="showPage('login')">
                <i class="fas fa-sign-in-alt"></i>
                Sign In
            </button>
            
            <div class="divider">
                <span>or</span>
            </div>
            
            <button class="btn btn-outline btn-block" onclick="showPage('signup')">
                <i class="fas fa-user-plus"></i>
                Create an Account
            </button>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen">
            <div class="screen-header">
                <button class="header-back" onclick="showPage('authOptions')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2>Sign In</h2>
            </div>

            <div class="content login-content">
                <form id="loginForm">
                    <div class="input-group">
                        <label class="form-label" for="loginEmail">Email</label>
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="email" id="loginEmail" class="form-input" placeholder="your@email.com" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="form-label" for="loginPassword">Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="loginPassword" class="form-input" placeholder="••••••••" required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">Sign In</button>
                </form>

                <div class="auth-footer">
                    Don't have an account? 
                    <a href="#" class="auth-link" onclick="showPage('signup')">Sign Up</a>
                </div>
            </div>
        </div>

        <!-- Signup Screen -->
        <div id="signupScreen" class="screen">
            <div class="screen-header">
                <button class="header-back" onclick="showPage('authOptions')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h2>Create Account</h2>
            </div>

            <div class="content">
                <form id="signupForm">
                    <div class="input-group">
                        <label class="form-label" for="name">Full Name</label>
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" id="name" class="form-input" placeholder="John Doe" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="form-label" for="email">Email</label>
                        <i class="fas fa-envelope input-icon"></i>
                        <input type="email" id="email" class="form-input" placeholder="your@email.com" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="form-label" for="password">Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="password" class="form-input" placeholder="••••••••" required>
                    </div>
                    
                    <div class="input-group">
                        <label class="form-label" for="confirmPassword">Confirm Password</label>
                        <i class="fas fa-lock input-icon"></i>
                        <input type="password" id="confirmPassword" class="form-input" placeholder="••••••••" required>
                    </div>

                    <label class="form-label">I want to:</label>
                    <div class="user-type-selection">
                        <div class="user-type-option" id="sharerOption" onclick="selectUserType('donor')">
                            <i class="fas fa-share-alt user-type-icon"></i>
                            <span class="user-type-label">Share Food</span>
                            <input type="radio" name="userType" value="donor" style="display: none;" required>
                        </div>
                        <div class="user-type-option" id="seekerOption" onclick="selectUserType('receiver')">
                            <i class="fas fa-hand-holding-heart user-type-icon"></i>
                            <span class="user-type-label">Find Food</span>
                            <input type="radio" name="userType" value="receiver" style="display: none;" required>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-block">Create Account</button>
                </form>

                <div class="auth-footer">
                    Already have an account? 
                    <a href="#" class="auth-link" onclick="showPage('login')">Sign In</a>
                </div>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen">
            <div class="welcome-screen">
                <i class="fas fa-check-circle success-icon"></i>
                <h1>Welcome!</h1>
                <p id="welcomeMessage">Account created successfully. Setting up your profile...</p>
            </div>
        </div>

        <!-- Donor Dashboard Screen -->
        <div id="donorScreen" class="screen">
            <div class="dashboard-header">
                <div class="user-greeting">
                    <img src="https://via.placeholder.com/50x50" alt="User Avatar" class="user-avatar" id="donorAvatar">
                    <div class="greeting-text">
                        <h3>Hello, <span id="donorName">User</span>!</h3>
                        <p>Ready to share food today?</p>
                    </div>
                </div>
            </div>

            <div class="container">
                <div class="section-title">
                    <h2>Your Donations</h2>
                    <button class="btn btn-primary" onclick="showDonationForm()">
                        <i class="fas fa-plus"></i>
                        New Listing
                    </button>
                </div>
                
                <div class="food-grid" id="donorListings">
                    <!-- Donor listings will be populated here -->
                </div>
            </div>

            <nav class="bottom-nav">
                <div class="nav-content">
                    <a href="#" class="nav-item active" onclick="navigateTo('home', 'donor')">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="#" class="nav-item" onclick="navigateTo('listings', 'donor')">
                        <i class="fas fa-list"></i>
                        <span>Listings</span>
                    </a>
                    <a href="#" class="nav-item" onclick="navigateTo('messages', 'donor')">
                        <i class="fas fa-message"></i>
                        <span>Messages</span>
                    </a>
                    <a href="#" class="nav-item" onclick="navigateTo('profile', 'donor')">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </div>
            </nav>
        </div>

        <!-- Receiver Dashboard Screen -->
        <div id="receiverScreen" class="screen">
            <header class="app-header">
                <div class="header-content">
                    <div class="logo">
                        <i class="fas fa-seedling"></i>
                        <span>Food Share</span>
                    </div>
                    <div class="user-info">
                        <!-- User info will be added here -->
                    </div>
                </div>
            </header>

            <div class="container">
                <div class="section-title">
                    <h2>Available Food</h2>
                    <div class="search-box">
                        <input type="text" placeholder="Search food items..." onkeyup="searchListings(this.value)">
                    </div>
                </div>
                
                <div class="food-grid" id="availableListings">
                    <!-- Available food listings will be populated here -->
                </div>
            </div>

            <nav class="bottom-nav">
                <div class="nav-content">
                    <a href="#" class="nav-item active" onclick="navigateTo('home', 'receiver')">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="#" class="nav-item" onclick="navigateTo('search', 'receiver')">
                        <i class="fas fa-search"></i>
                        <span>Search</span>
                    </a>
                    <a href="#" class="nav-item" onclick="navigateTo('messages', 'receiver')">
                        <i class="fas fa-message"></i>
                        <span>Messages</span>
                    </a>
                    <a href="#" class="nav-item" onclick="navigateTo('profile', 'receiver')">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </div>
            </nav>
        </div>

        <!-- Profile Screen -->
        <div id="profileScreen" class="screen">
            <div class="profile-header">
                <div class="profile-pic">
                    <i class="fas fa-user"></i>
                </div>
                <h2 class="profile-name" id="profileName">Jane Smith</h2>
                <p class="profile-role" id="profileRole">Food Donor</p>
            </div>

            <div class="profile-sections">
                <div class="profile-section">
                    <h3 class="section-header">
                        <i class="fas fa-cog"></i>
                        Account Settings
                    </h3>
                    <div class="menu-list">
                        <div class="menu-item" onclick="openSettings('personal')">
                            <div class="menu-item-content">
                                <i class="fas fa-user"></i>
                                <div class="menu-item-text">Personal Information</div>
                            </div>
                            <i class="fas fa-chevron-right menu-item-arrow"></i>
                        </div>
                        <div class="menu-item" onclick="openSettings('notifications')">
                            <div class="menu-item-content">
                                <i class="fas fa-bell"></i>
                                <div class="menu-item-text">Notifications</div>
                            </div>
                            <i class="fas fa-chevron-right menu-item-arrow"></i>
                        </div>
                        <div class="menu-item" onclick="openSettings('password')">
                            <div class="menu-item-content">
                                <i class="fas fa-lock"></i>
                                <div class="menu-item-text">Change Password</div>
                            </div>
                            <i class="fas fa-chevron-right menu-item-arrow"></i>
                        </div>
                    </div>
                </div>
    
                <div class="profile-section">
                    <h3 class="section-header">
                        <i class="fas fa-info-circle"></i>
                        About
                    </h3>
                    <div class="menu-list">
                        <div class="menu-item" onclick="openAbout('terms')">
                            <div class="menu-item-content">
                                <i class="fas fa-file-alt"></i>
                                <div class="menu-item-text">Terms of Service</div>
                            </div>
                            <i class="fas fa-chevron-right menu-item-arrow"></i>
                        </div>
                        <div class="menu-item" onclick="openAbout('privacy')">
                            <div class="menu-item-content">
                                <i class="fas fa-shield-alt"></i>
                                <div class="menu-item-text">Privacy Policy</div>
                            </div>
                            <i class="fas fa-chevron-right menu-item-arrow"></i>
                        </div>
                        <div class="menu-item" onclick="openAbout('contact')">
                            <div class="menu-item-content">
                                <i class="fas fa-envelope"></i>
                                <div class="menu-item-text">Contact Us</div>
                            </div>
                            <i class="fas fa-chevron-right menu-item-arrow"></i>
                        </div>
                    </div>
                </div>
    
                <button type="button" class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Log out</span>
                </button>
    
                <button type="button" class="delete-btn" onclick="confirmDeleteAccount()">
                    <i class="fas fa-trash"></i>
                    <span>Delete Account</span>
                </button>
            </div>

            <nav class="bottom-nav">
                <div class="nav-content">
                    <a href="#" class="nav-item" id="profileHomeNav">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="#" class="nav-item" id="profileListingsNav">
                        <i class="fas fa-list"></i>
                        <span>Listings</span>
                    </a>
                    <a href="#" class="nav-item" id="profileMessagesNav">
                        <i class="fas fa-message"></i>
                        <span>Messages</span>
                    </a>
                    <a href="#" class="nav-item active" id="profileProfileNav">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </div>
            </nav>
        </div>

        <!-- Chat Modal -->
        <div class="chat-modal" id="chatModal" style="display: none;">
            <div class="chat-container">
                <div class="chat-header">
                    <h3 id="chatRecipientName">John Doe</h3>
                    <button class="btn btn-icon" onclick="closeChat()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be populated here -->
                </div>
                
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="sendMessageOnEnter(event)">
                    <button class="btn btn-primary btn-icon" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Donation Form Modal -->
        <div class="chat-modal" id="donationFormModal" style="display: none;">
            <div class="chat-container">
                <div class="chat-header">
                    <h3>Add New Food Listing</h3>
                    <button class="btn btn-icon" onclick="closeDonationForm()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <form id="donationForm">
                    <div class="input-group">
                        <label for="foodTitle">Food Title</label>
                        <input type="text" id="foodTitle" placeholder="What are you sharing?">
                    </div>
                    
                    <div class="input-group">
                        <label for="foodDescription">Description</label>
                        <textarea id="foodDescription" rows="3" placeholder="Describe the food (quantity, condition, etc.)"></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="expiryDate">Expiry Date</label>
                        <input type="date" id="expiryDate">
                    </div>
                    
                    <div class="input-group">
                        <label for="pickupAddress">Pickup Address</label>
                        <input type="text" id="pickupAddress" placeholder="Where can it be picked up?">
                    </div>
                    
                    <div class="input-group">
                        <label for="foodCategory">Category</label>
                        <select id="foodCategory">
                            <option value="bakery">Bakery</option>
                            <option value="produce">Produce</option>
                            <option value="dairy">Dairy</option>
                            <option value="pantry">Pantry</option>
                            <option value="prepared">Prepared Meals</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="input-group">
                        <label for="foodImage">Upload Image (optional)</label>
                        <input type="file" id="foodImage" accept="image/*">
                    </div>
                    
                    <button type="button" class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="submitDonation()">
                        <i class="fas fa-plus"></i>
                        <span>Add Listing</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
        <!-- Firebase SDKs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-firestore-compat.min.js"></script>
<script>
  // DOM elements cache for better performance
const screens = {
    splash: document.getElementById('splashScreen'),
    onboarding: document.getElementById('onboardingScreen'),
    authOptions: document.getElementById('authOptionsScreen'),
    login: document.getElementById('loginScreen'),
    signup: document.getElementById('signupScreen'),
    welcome: document.getElementById('welcomeScreen'),
    donor: document.getElementById('donorScreen'),
    receiver: document.getElementById('receiverScreen'),
    profile: document.getElementById('profileScreen')
};

const onboardingSlides = [
    document.getElementById('slide1'),
    document.getElementById('slide2'),
    document.getElementById('slide3')
];

const modals = {
    chat: document.getElementById('chatModal'),
    donationForm: document.getElementById('donationFormModal')
};

// Firebase config 
const firebaseConfig = {
    apiKey: "AIzaSyDgRi43mb42KExpplTBF6T9Z6IsedrTw7E",
    authDomain: "foodshare-5951e.firebaseapp.com",
    projectId: "foodshare-5951e",
    storageBucket: "foodshare-5951e.firebasestorage.app",
    messagingSenderId: "460631614669",
    appId: "1:460631614669:web:8e1379b952c757ea7a7584",
    measurementId: "G-E6Z0RDYK70"
};

// Initialize Firebase (this will be called after DOM is loaded)
let auth, db, storage, currentUser;

function initializeFirebase() {
    try {
        if (typeof firebase !== 'undefined') {
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();

            // Listen for auth state changes
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData();
                    // Skip onboarding for authenticated users
                    setOnboardingCompleted();
                } else {
                    // Check if onboarding has been completed before
                    if (isOnboardingCompleted()) {
                        showPage('authOptions');
                    } else {
                        showPage('onboarding');
                    }
                }
            });
        } else {
            console.error("Firebase SDK not loaded.");
            // Fallback to demo mode
            checkOnboardingStatus();
        }
    } catch (error) {
        console.error("Firebase initialization failed: ", error);
        // Fallback to demo mode or show an error message
        checkOnboardingStatus();
    }
}

// Check onboarding status
function checkOnboardingStatus() {
    if (isOnboardingCompleted()) {
        showPage('authOptions');
    } else {
        showPage('onboarding');
    }
}

// Mark onboarding as completed
function setOnboardingCompleted() {
    localStorage.setItem('onboardingCompleted', 'true');
}

// Check if onboarding is completed
function isOnboardingCompleted() {
    return localStorage.getItem('onboardingCompleted') === 'true';
}

// Splash screen timer and initial page load
document.addEventListener('DOMContentLoaded', () => {
    // Show splash screen for 2 seconds then check auth state
    setTimeout(() => {
        if (auth) {
            // If Firebase is initialized, onAuthStateChanged will handle routing
            // Just wait for it to fire
        } else {
            // If Firebase isn't available, check onboarding status manually
            checkOnboardingStatus();
        }
    }, 10000);

    // Initialize form submit handlers
    initFormHandlers();

    // Setup profile navigation handlers
    setupProfileNavigation();

    // Try to initialize Firebase if available
    try {
        initializeFirebase();
    } catch (error) {
        console.log("Firebase not initialized: ", error);
    }
});

// Page navigation functions
function showPage(pageId) {
    // Hide all screens first
    Object.values(screens).forEach(screen => {
        screen.classList.remove('active');
    });

    // Show the requested screen
    screens[pageId].classList.add('active', 'animate-in');

    // Special case for returning to first onboarding slide
    if (pageId === 'onboarding') {
        showSlide(1);
    }

    // If this is the last onboarding slide, mark as completed
    if (pageId === 'authOptions' && screens.onboarding.classList.contains('active')) {
        setOnboardingCompleted();
    }
}

// Onboarding slide navigation
function showSlide(slideNumber) {
    // Hide all slides
    onboardingSlides.forEach(slide => {
        slide.style.display = 'none';
    });

    // Show the requested slide (adjust for zero-based array)
    onboardingSlides[slideNumber - 1].style.display = 'flex';
}

// User type selection in signup
function selectUserType(type) {
    const sharerOption = document.getElementById('sharerOption');
    const seekerOption = document.getElementById('seekerOption');

    // Reset both options
    sharerOption.classList.remove('selected');
    seekerOption.classList.remove('selected');

    // Select the chosen type
    if (type === 'donor') {
        sharerOption.classList.add('selected');
        document.querySelector('input[value="donor"]').checked = true;
    } else {
        seekerOption.classList.add('selected');
        document.querySelector('input[value="receiver"]').checked = true;
    }
}

// Initialize form handlers
function initFormHandlers() {
    // Login form handler
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }

    // Signup form handler
    const signupForm = document.getElementById('signupForm');
    if (signupForm) {
        signupForm.addEventListener('submit', handleSignup);
    }
}

// Setup profile navigation
function setupProfileNavigation() {
    // Set up profile navigation based on user type
    document.getElementById('profileHomeNav').addEventListener('click', function(e) {
        e.preventDefault();
        const userType = currentUser?.userType || 'donor';
        navigateTo('home', userType);
    });
    
    document.getElementById('profileListingsNav').addEventListener('click', function(e) {
        e.preventDefault();
        const userType = currentUser?.userType || 'donor';
        navigateTo('listings', userType);
    });
    
    document.getElementById('profileMessagesNav').addEventListener('click', function(e) {
        e.preventDefault();
        const userType = currentUser?.userType || 'donor';
        navigateTo('messages', userType);
    });
}

// Handle login form submission
function handleLogin(e) {
    e.preventDefault();

    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;

    if (auth) {
        // Firebase login
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Successful login
                currentUser = userCredential.user;
                loadUserData();
                // Dashboard will be shown after user data is loaded
            })
            .catch((error) => {
                // Handle errors - show appropriate message
                let errorMessage = "Login failed. Please try again.";
                if (error.code === "auth/user-not-found" || error.code === "auth/wrong-password") {
                    errorMessage = "Invalid email or password.";
                }
                alert(errorMessage);
            });
    } else {
        // Demo mode without Firebase
        simulateLogin(email);
    }
}

// Handle signup form submission
function handleSignup(e) {
    e.preventDefault();

    const name = document.getElementById('name').value;
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const userType = document.querySelector('input[name="userType"]:checked')?.value;

    // Basic validation
    if (password !== confirmPassword) {
        alert("Passwords don't match");
        return;
    }

    if (!userType) {
        alert("Please select a user type");
        return;
    }

    if (auth) {
        // Firebase signup
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                // Create user profile in database
                createUserProfile(userCredential.user.uid, {
                    name,
                    email,
                    userType
                });

                // Show welcome screen
                document.getElementById('welcomeMessage').textContent =
                    `Welcome, ${name}! Setting up your profile...`;
                showPage('welcome');

                // Transition to appropriate dashboard after delay
                setTimeout(() => {
                    routeUserToDashboard(userType, name);
                }, 2000);
            })
            .catch((error) => {
                let errorMessage = "Signup failed. Please try again.";
                if (error.code === "auth/email-already-in-use") {
                    errorMessage = "This email is already in use.";
                }
                alert(errorMessage);
            });
    } else {
        // Demo mode without Firebase
        simulateSignup(name, email, userType);
    }
}

// Function to route user to appropriate dashboard
function routeUserToDashboard(userType, name) {
    if (userType === 'donor') {
        document.getElementById('donorName').textContent = name;
        showPage('donor');
    } else if (userType === 'receiver') {
        document.getElementById('receiverName').textContent = name;
        showPage('receiver');
    }
}

// Create user profile in database
async function createUserProfile(userId, userData) {
    try {
        let profileImageUrl = null;

        // Create user document in Firestore
        if (db) {
            await db.collection('users').doc(userId).set({
                name: userData.name,
                email: userData.email,
                userType: userData.userType,
                profileImageUrl: profileImageUrl,
                createdAt: new Date()
            });
        }

        // Update currentUser
        currentUser = {
            uid: userId,
            ...userData,
            profileImageUrl
        };

    } catch (error) {
        console.error("Error creating user profile:", error);
        alert("Error creating user profile. Please try again.");
    }
}

// Load user data from database and route to correct dashboard
async function loadUserData() {
    if (!currentUser || !db) return;

    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            const userType = userData.userType;
            const name = userData.name;
            
            // Route to the correct dashboard based on user type
            if (userType === 'donor') {
                document.getElementById('donorName').textContent = name;
                if (userData.profileImageUrl) {
                    document.getElementById('donorAvatar').src = userData.profileImageUrl;
                }
                showPage('donor');
            } else if (userType === 'receiver') {
                document.getElementById('receiverName').textContent = name;
                if (userData.profileImageUrl) {
                    document.getElementById('receiverAvatar').src = userData.profileImageUrl;
                }
                showPage('receiver');
            }
        }
    } catch (error) {
        console.error("Error loading user data:", error);
    }
}


// Logout function
function logout() {
    if (auth) {
        auth.signOut().then(() => {
            currentUser = null; // Clear local state
            showPage('authOptions');
        }).catch((error) => {
            console.error("Logout error:", error);
        });
    } else {
        // Demo mode
        currentUser = null;
        showPage('authOptions');
    }
}

// Navigation function for bottom navigation bar
function navigateTo(screen, userType) {
    // Get all navigation items for the current user type
    const navItems = document.querySelectorAll(`.bottom-nav .nav-item`);
    
    // Remove active class from all navigation items
    navItems.forEach(item => {
        item.classList.remove('active');
    });
    
    // Add active class to the clicked navigation item
    event.currentTarget.classList.add('active');
    
    // Handle navigation based on user type and selected screen
    switch(screen) {
        case 'home':
            // Navigate to the appropriate home screen based on user type
            if (userType === 'donor') {
                showDonorHome();
            } else {
                showReceiverHome();
            }
            break;
            
        case 'listings':
        case 'search':
            // Show listings for donor or search page for receiver
            if (userType === 'donor') {
                showDonorListings();
            } else {
                showReceiverSearch();
            }
            break;
            
        case 'messages':
            // Show messages screen (common for both user types)
            showMessages(userType);
            break;
            
        case 'profile':
            // Show profile screen (common for both user types but with different data)
            showProfile(userType);
            break;
            
        default:
            console.error('Unknown screen:', screen);
    }
}

// Function to show donor home screen
function showDonorHome() {
    // Hide any visible container screens within donor screen
    hideAllDonorContainers();
    
    // Show the donor home container
    const homeContainer = document.querySelector('#donorScreen .container');
    if (homeContainer) {
        homeContainer.style.display = 'block';
    }
    
    // Load donor's active listings
    loadDonorListings();
}

// Function to show receiver home screen
function showReceiverHome() {
    // Hide any visible container screens within receiver screen
    hideAllReceiverContainers();
    
    // Show the receiver home container
    const homeContainer = document.querySelector('#receiverScreen .container');
    if (homeContainer) {
        homeContainer.style.display = 'block';
    }
    
    // Load available food listings
    loadAvailableListings();
}

// Function to show donor's listings
function showDonorListings() {
    // Hide any visible container screens within donor screen
    hideAllDonorContainers();
    
    // Create and show a listings-specific container if it doesn't exist
    let listingsContainer = document.querySelector('#donorListingsContainer');
    if (!listingsContainer) {
        listingsContainer = document.createElement('div');
        listingsContainer.id = 'donorListingsContainer';
        listingsContainer.className = 'container';
        listingsContainer.innerHTML = `
            <div class="section-title">
                <h2>Manage Your Listings</h2>
                <button class="btn btn-primary" onclick="showDonationForm()">
                    <i class="fas fa-plus"></i>
                    New Listing
                </button>
            </div>
            <div class="tabs">
                <button class="tab-btn active" onclick="filterDonorListings('active')">Active</button>
                <button class="tab-btn" onclick="filterDonorListings('pending')">Pending</button>
                <button class="tab-btn" onclick="filterDonorListings('completed')">Completed</button>
            </div>
            <div class="food-grid" id="filteredDonorListings">
                <!-- Filtered listings will be populated here -->
            </div>
        `;
        document.getElementById('donorScreen').appendChild(listingsContainer);
    }
    
    listingsContainer.style.display = 'block';
    
    // Load and filter donor's listings
    loadDonorListings('active');
}

// Function to show receiver's search page
function showReceiverSearch() {
    // Hide any visible container screens within receiver screen
    hideAllReceiverContainers();
    
    // Create and show a search-specific container if it doesn't exist
    let searchContainer = document.querySelector('#receiverSearchContainer');
    if (!searchContainer) {
        searchContainer = document.createElement('div');
        searchContainer.id = 'receiverSearchContainer';
        searchContainer.className = 'container';
        searchContainer.innerHTML = `
            <div class="section-title">
                <h2>Find Food</h2>
            </div>
            <div class="search-filters">
                <div class="filter-group">
                    <label>Category</label>
                    <select id="categoryFilter" onchange="applyFilters()">
                        <option value="">All Categories</option>
                        <option value="bakery">Bakery</option>
                        <option value="produce">Produce</option>
                        <option value="dairy">Dairy</option>
                        <option value="pantry">Pantry</option>
                        <option value="prepared">Prepared Meals</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Distance</label>
                    <select id="distanceFilter" onchange="applyFilters()">
                        <option value="">Any Distance</option>
                        <option value="1">< 1 mile</option>
                        <option value="3">< 3 miles</option>
                        <option value="5">< 5 miles</option>
                        <option value="10">< 10 miles</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Sort By</label>
                    <select id="sortFilter" onchange="applyFilters()">
                        <option value="distance">Distance</option>
                        <option value="expiry">Expiry Date</option>
                        <option value="recent">Recently Added</option>
                    </select>
                </div>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search food items..." onkeyup="searchListings()">
                <button class="search-btn" onclick="searchListings()">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="food-grid" id="searchResults">
                <!-- Search results will be populated here -->
            </div>
        `;
        document.getElementById('receiverScreen').appendChild(searchContainer);
    }
    
    searchContainer.style.display = 'block';
    
    // Load initial search results
    searchListings();
}

// Function to show messages screen
function showMessages(userType) {
    // Determine which screen is currently active based on user type
    const activeScreen = userType === 'donor' ? 'donorScreen' : 'receiverScreen';
    
    // Hide any visible container screens
    if (userType === 'donor') {
        hideAllDonorContainers();
    } else {
        hideAllReceiverContainers();
    }
    
    // Create and show a messages-specific container if it doesn't exist
    let messagesContainer = document.querySelector(`#${activeScreen}MessagesContainer`);
    if (!messagesContainer) {
        messagesContainer = document.createElement('div');
        messagesContainer.id = `${activeScreen}MessagesContainer`;
        messagesContainer.className = 'container';
        messagesContainer.innerHTML = `
            <div class="section-title">
                <h2>Messages</h2>
            </div>
            <div class="messages-list" id="${userType}MessagesList">
                <!-- Message threads will be populated here -->
            </div>
        `;
        document.getElementById(activeScreen).appendChild(messagesContainer);
    }
    
    messagesContainer.style.display = 'block';
    
    // Load message threads
    loadMessageThreads(userType);
}

// Function to show profile screen
function showProfile(userType) {
    // Show the profile screen
    showPage('profile');
    
    // Update profile screen navigation based on user type
    document.getElementById('profileHomeNav').onclick = function(e) {
        e.preventDefault();
        showPage(userType === 'donor' ? 'donor' : 'receiver');
        navigateTo('home', userType);
    };
    
    document.getElementById('profileListingsNav').onclick = function(e) {
        e.preventDefault();
        showPage(userType === 'donor' ? 'donor' : 'receiver');
        navigateTo(userType === 'donor' ? 'listings' : 'search', userType);
    };
    
    // Load user profile data
    loadUserProfile(userType);
}

// Helper functions for containers visibility
function hideAllDonorContainers() {
    const containers = document.querySelectorAll('#donorScreen .container');
    containers.forEach(container => {
        container.style.display = 'none';
    });
}

function hideAllReceiverContainers() {
    const containers = document.querySelectorAll('#receiverScreen .container');
    containers.forEach(container => {
        container.style.display = 'none';
    });
}

// Placeholder functions for data loading - these would be implemented with actual data in a real app
function loadDonorListings(filter = 'all') {
    // This would fetch listings from the database in a real app
    console.log('Loading donor listings with filter:', filter);
    
    // For demo purposes, show sample listings
    const listings = [
        { id: 1, title: 'Organic Apples', category: 'produce', expiry: '2025-03-25', status: 'active' },
        { id: 2, title: 'Fresh Bread', category: 'bakery', expiry: '2025-03-23', status: 'pending' },
        { id: 3, title: 'Leftover Pasta', category: 'prepared', expiry: '2025-03-22', status: 'active' }
    ];
    
    // Filter listings based on selected filter
    const filteredListings = filter === 'all' ? listings : listings.filter(item => item.status === filter);
    
    // Display listings
    displayDonorListings(filteredListings);
}

function loadAvailableListings() {
    // This would fetch available listings from the database in a real app
    console.log('Loading available listings for receiver');
    
    // For demo purposes, show sample listings
    const listings = [
        { id: 4, title: 'Fresh Vegetables', category: 'produce', expiry: '2025-03-24', distance: '0.5 miles' },
        { id: 5, title: 'Milk and Yogurt', category: 'dairy', expiry: '2025-03-23', distance: '1.2 miles' },
        { id: 6, title: 'Canned Goods', category: 'pantry', expiry: '2025-04-15', distance: '0.8 miles' }
    ];
    
    // Display listings
    displayAvailableListings(listings);
}

function searchListings() {
    // Get search term
    const searchTerm = document.getElementById('searchInput')?.value || '';
    console.log('Searching for:', searchTerm);
    
    // Apply any filters
    applyFilters();
}

function applyFilters() {
    // Get filter values
    const category = document.getElementById('categoryFilter')?.value || '';
    const distance = document.getElementById('distanceFilter')?.value || '';
    const sortBy = document.getElementById('sortFilter')?.value || 'distance';
    
    console.log('Applying filters:', { category, distance, sortBy });
    
    // This would fetch filtered listings from the database in a real app
    // For demo purposes, use sample data
    const listings = [
        { id: 4, title: 'Fresh Vegetables', category: 'produce', expiry: '2025-03-24', distance: '0.5 miles' },
        { id: 5, title: 'Milk and Yogurt', category: 'dairy', expiry: '2025-03-23', distance: '1.2 miles' },
        { id: 6, title: 'Canned Goods', category: 'pantry', expiry: '2025-04-15', distance: '0.8 miles' }
    ];
    
    // Filter and sort listings based on criteria
    let filteredListings = listings;
    if (category) {
        filteredListings = filteredListings.filter(item => item.category === category);
    }
    
    // Display results
    const resultsContainer = document.getElementById('searchResults');
    if (resultsContainer) {
        displayListingsInContainer(filteredListings, resultsContainer);
    }
}

function loadMessageThreads(userType) {
    // This would fetch message threads from the database in a real app
    console.log('Loading message threads for', userType);
    
    // For demo purposes, show sample threads
    const threads = [
        { id: 1, name: 'Jane Doe', lastMessage: 'Is the bread still available?', time: '10:30 AM', unread: true },
        { id: 2, name: 'Alex Smith', lastMessage: 'Thanks for the vegetables!', time: 'Yesterday', unread: false }
    ];
    
    // Display threads
    displayMessageThreads(threads, userType);
}

function loadUserProfile(userType) {
    // This would fetch user profile data from the database in a real app
    console.log('Loading profile for', userType);
    
    // For demo purposes, use sample data
    const profileData = {
        name: userType === 'donor' ? 'Jane Smith' : 'Alex Johnson',
        role: userType === 'donor' ? 'Food Donor' : 'Food Receiver',
        totalDonations: userType === 'donor' ? 12 : 0,
        totalReceived: userType === 'receiver' ? 8 : 0,
        totalHelped: userType === 'donor' ? 58 : 0,
        rating: userType === 'donor' ? 4.8 : 4.6
    };
    
    // Update profile UI
    document.getElementById('profileName').textContent = profileData.name;
    document.getElementById('profileRole').textContent = profileData.role;
    document.getElementById('totalDonations').textContent = userType === 'donor' ? 
        profileData.totalDonations : profileData.totalReceived;
    document.getElementById('totalHelped').textContent = profileData.totalHelped;
    document.getElementById('rating').textContent = profileData.rating;
}

// Helper functions for displaying content
function displayDonorListings(listings) {
    const container = document.getElementById('donorListings') || 
                      document.getElementById('filteredDonorListings');
    if (container) {
        displayListingsInContainer(listings, container, true);
    }
}

function displayAvailableListings(listings) {
    const container = document.getElementById('availableListings');
    if (container) {
        displayListingsInContainer(listings, container, false);
    }
}

function displayListingsInContainer(listings, container, isDonor = false) {
    // Clear container
    container.innerHTML = '';
    
    if (listings.length === 0) {
        container.innerHTML = '<p class="empty-message">No listings found</p>';
        return;
    }
    
    // Create HTML for each listing
    listings.forEach(listing => {
        const listingElement = document.createElement('div');
        listingElement.className = 'food-item';
        
        listingElement.innerHTML = `
            <div class="food-image">
                <img src="/api/placeholder/200/200" alt="${listing.title}">
                ${listing.status === 'pending' ? '<div class="status-badge pending">Pending</div>' : ''}
                ${listing.status === 'completed' ? '<div class="status-badge completed">Completed</div>' : ''}
            </div>
            <div class="food-info">
                <h3>${listing.title}</h3>
                <p class="food-category">${listing.category}</p>
                <p class="food-expiry">Expires: ${listing.expiry}</p>
                ${!isDonor ? `<p class="food-distance">${listing.distance}</p>` : ''}
            </div>
            <div class="food-actions">
                ${isDonor ? 
                    `<button class="btn btn-outline btn-sm" onclick="editListing(${listing.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline btn-sm" onclick="deleteListing(${listing.id})">
                        <i class="fas fa-trash"></i>
                    </button>` : 
                    `<button class="btn btn-primary btn-sm" onclick="requestFood(${listing.id})">
                        Request
                    </button>`
                }
            </div>
        `;
        
        container.appendChild(listingElement);
    });
}

function displayMessageThreads(threads, userType) {
    const container = document.getElementById(`${userType}MessagesList`);
    if (!container) return;
    
    // Clear container
    container.innerHTML = '';
    
    if (threads.length === 0) {
        container.innerHTML = '<p class="empty-message">No messages yet</p>';
        return;
    }
    
    // Create HTML for each thread
    threads.forEach(thread => {
        const threadElement = document.createElement('div');
        threadElement.className = `message-thread ${thread.unread ? 'unread' : ''}`;
        threadElement.onclick = () => openChat(thread.id, thread.name);
        
        threadElement.innerHTML = `
            <div class="thread-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="thread-content">
                <div class="thread-header">
                    <h3 class="thread-name">${thread.name}</h3>
                    <span class="thread-time">${thread.time}</span>
                </div>
                <p class="thread-preview">${thread.lastMessage}</p>
            </div>
            ${thread.unread ? '<div class="unread-indicator"></div>' : ''}
        `;
        
        container.appendChild(threadElement);
    });
}

// Chat functions
function openChat(threadId, recipientName) {
    // Set chat recipient name
    document.getElementById('chatRecipientName').textContent = recipientName;
    
    // Show chat modal
    document.getElementById('chatModal').style.display = 'flex';
    
    // Focus on input
    document.getElementById('messageInput').focus();
    
    // Load chat messages
    loadChatMessages(threadId);
}

function closeChat() {
    document.getElementById('chatModal').style.display = 'none';
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (message) {
        // In a real app, this would save the message to the database
        console.log('Sending message:', message);
        
        // Add message to UI
        addMessageToChat('sent', message);
        
        // Clear input
        messageInput.value = '';
    }
}

function sendMessageOnEnter(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function loadChatMessages(threadId) {
    // This would fetch chat messages from the database in a real app
    console.log('Loading chat messages for thread:', threadId);
    
    // For demo purposes, show sample messages
    const messages = [
        { type: 'received', text: 'Hello, is this item still available?', time: '10:30 AM' },
        { type: 'sent', text: 'Yes, it is! When would you like to pick it up?', time: '10:32 AM' },
        { type: 'received', text: 'Would this afternoon work?', time: '10:35 AM' }
    ];
    
    // Display messages
    const chatContainer = document.getElementById('chatMessages');
    chatContainer.innerHTML = '';
    
    messages.forEach(message => {
        addMessageToChat(message.type, message.text, message.time);
    });
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function addMessageToChat(type, text, time) {
    const chatContainer = document.getElementById('chatMessages');
    const messageElement = document.createElement('div');
    messageElement.className = `chat-message ${type}`;
    
    // Get current time if not provided
    const messageTime = time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    messageElement.innerHTML = `
        <div class="message-content">
            <p>${text}</p>
            <span class="message-time">${messageTime}</span>
        </div>
    `;
    
    chatContainer.appendChild(messageElement);
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Donation form functions
function showDonationForm() {
    document.getElementById('donationFormModal').style.display = 'flex';
}

function closeDonationForm() {
    document.getElementById('donationFormModal').style.display = 'none';
}

function submitDonation() {
    const title = document.getElementById('foodTitle').value;
    const description = document.getElementById('foodDescription').value;
    const expiry = document.getElementById('expiryDate').value;
    const address = document.getElementById('pickupAddress').value;
    const category = document.getElementById('foodCategory').value;
    
    // Basic validation
    if (!title || !description || !expiry || !address) {
        alert('Please fill out all required fields');
        return;
    }
    
    // In a real app, this would save the donation to the database
    console.log('Submitting donation:', { title, description, expiry, address, category });
    
    // Close form and refresh listings
    closeDonationForm();
    loadDonorListings();
    
    // Reset form
    document.getElementById('donationForm').reset();
}

// Placeholder functions for interaction handlers
function editListing(listingId) {
    console.log('Edit listing:', listingId);
    // This would open an edit form in a real app
}

function deleteListing(listingId) {
    console.log('Delete listing:', listingId);
    // This would show a confirmation dialog in a real app
}

function requestFood(listingId) {
    console.log('Request food:', listingId);
    // This would send a request and open chat in a real app
    
    // For demo purposes, open a chat
    openChat(listingId, 'Food Owner');
}

// Filter donor listings
function filterDonorListings(filter) {
    // Update active tab
    const tabButtons = document.querySelectorAll('.tab-btn');
    tabButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    event.currentTarget.classList.add('active');
    
    // Load filtered listings
    loadDonorListings(filter);
}
</script>
</body>
</html>

